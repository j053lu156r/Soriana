sap.ui.define(["sap/ui/model/json/JSONModel","demo/controllers/BaseController","demo/models/BaseModel","sap/m/Label","sap/m/Link","sap/m/MessageToast","sap/m/Text","sap/ui/core/Fragment"],function(e,t,o,s,n,r,i,l){"use strict";var a="/sap/opu/odata/sap/ZOCP_DOCPAGO_SRV/";var u;var c=new Date;return t.extend("demo.controllers.ComplPago.DetallePago",{sCollection:"GroupedTotales>/Hierarchy",aCrumbs:["movimientos","positions"],mInitialOrderState:{products:{},count:0,hasCounts:false},onInit:function(){var t=this.getView().byId("exitFullScreenBtn"),o=this.getView().byId("enterFullScreenBtn");this.oRouter=this.getOwnerComponent().getRouter();this.oModel=this.getOwnerComponent().getModel();this.oRouter.getRoute("detailComplPagos").attachPatternMatched(this._onDocumentMatched,this);this.getView().addEventDelegate({onBeforeShow:function(t){this.getOwnerComponent().setModel(new e,"totales");var o=new e({filtros:[{filtro:"belnr",descripcion:"Documento"},{filtro:"xblnr",descripcion:"Factura"},{filtro:"",descripcion:""}]});this.getView().setModel(o,"filterOptions")}},this);if(!this._pTemplate){this._pTemplate=this.loadFragment({id:this.getView().getId(),name:"demo.views.ComplPago.Row"})}this._oTable=this.byId("detailsStatementList")},searchData:function(){var t=this;var o=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYYMMdd"});let s=this.getConfigModel().getProperty("/supplierInputKey");let n=new Date;console.log(this._fecha);let r=this._fecha.replace(/-/g,"");let i=o.format(n);let l=this._document;if(s==null||s==""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/global.supplierSelectError"));return false}if(r==""||i==""){}var u=this._sociedad;var c=` and belnr eq '${l}' and Bukrs eq '${u}' `;var d=this.getOdata(a);var h=[];h.push(new sap.ui.model.Filter({path:"Datei",operator:sap.ui.model.FilterOperator.EQ,value1:r}));h.push(new sap.ui.model.Filter({path:"Lifnr",operator:sap.ui.model.FilterOperator.EQ,value1:s}));h.push(new sap.ui.model.Filter({path:"Datef",operator:sap.ui.model.FilterOperator.EQ,value1:i}));h.push(new sap.ui.model.Filter({path:"belnr",operator:sap.ui.model.FilterOperator.EQ,value1:l}));h.push(new sap.ui.model.Filter({path:"Bukrs",operator:sap.ui.model.FilterOperator.EQ,value1:u}));var m="ZOCP_DOCPAGO_SRV";var p="EStmtHdrSet";var g=["Citms","Oitms"];var b=h;var f="";t._GEToDataV2(m,p,b,g).then(function(o){sap.ui.core.BusyIndicator.show();var n=o.data;console.log(n);var r=n;console.log(r);let i=[...r.results[0].Citms.results,...r.results[0].Oitms.results];var l=i;var a=l.reduce(function(e,t){var o=t.Agrupacion==="1"?Number(t.Wrbtr):0;var s=e+Number(o);return s},0);var c=l.reduce(function(e,t){var o=t.Agrupacion==="2"?Number(t.Wrbtr):0;var s=e+Number(o);return s},0);var d=l.filter(e=>{if(e.DescripcionGpo===""&&e.Agrupacion==="1"){e.DescripcionGpo="AJUSTE DE FACTURAS";e.IdNumGpo="9";e.DescTipomov="CARGOS DIVERSOS";e.IdNumTipomov="65"}else if(e.DescripcionGpo===""&&e.Agrupacion==="3"){e.DescripcionGpo="RETENCION POR AFORO";e.IdNumGpo="AF";e.DescTipomov="RETENCION POR AFORO";e.IdNumTipomov="";e.Wrbtr=(Number(c)+Number(a)+Number(e.Wrbtr))*-1}return true});r.results[0].Detalles={results:[...l]};delete r.results[0].Citms;delete r.results[0].Oitms;var h=$.extend({},r.results[0]);var m=new e;m.setData(h);let p=[...l];var g=p.reduce(function(e,t){console.log(t.Wrbtr);var o=Number(t.Wrbtr);var s=e+o;return s},0);var b=t.groupArrayOfObjects(p,"DescripcionGpo");console.log(b);var f=[];var C=this;for(let e in b){console.log("sumando valores");var v=b[e].reduce(function(e,t){var o=Number(t.Wrbtr);var s=e+o;return s},0);if(e==="RETENCION POR AFORO"){if(u==="5003"){f.push({name:e,totalRegs:b[e].length,totalDebit:0,totalCredit:0,cost:t.truncate(v,2),positions:b[e]})}}else{f.push({name:e,totalRegs:b[e].length,totalDebit:0,totalCredit:0,cost:t.truncate(v,2),positions:b[e]})}}console.log(f);var y=f.reduce(function(e,o){var s=Number(o.totalRegs);var n=e+s;return t.truncate(n,2)},0);var I=1e-5;g=g+I;var O=new e({Hierarchy:{movimientos:f,totalR:y,totalD:0,totalC:0,totalCostos:t.truncate(g,2)},Lifnr:s});console.log(O);t.getOwnerComponent().setModel(O,"GroupedTotales");t.initTable();sap.ui.core.BusyIndicator.hide()})},subtractYears:function(e,t=new Date){t.setFullYear(t.getFullYear()-e);return t},groupArrayOfObjects:function(e,t){return e.reduce(function(e,o){(e[o[t]]=e[o[t]]||[]).push(o);return e},{})},initTable:function(){console.log("on init table");var e=this._getInitialPath();this._setAggregation(e);var t=this.byId("breadcrumb");var o=new n({text:"Conceptos",press:[e,this.onBreadcrumbPress,this]});t.destroyLinks();t.addLink(o)},_getInitialPath:function(){return[this.sCollection,this.aCrumbs[0]].join("/")},_nextCrumb:function(e){for(var t=0,o=this.aCrumbs.length;t<o;t++){if(this.aCrumbs[t]===e){return this.aCrumbs[t+1]}}},truncate:function(e,t){return Math.trunc(e*Math.pow(10,t))/Math.pow(10,t)},_stripItemBinding:function(e){var t=e.split("/");return t.slice(0,t.length-1).join("/")},_setAggregation:function(e){var t=e.split("/").reverse()[0];if(t===this.aCrumbs[this.aCrumbs.length-1]){this.byId("statusColumn").setVisible(true);this.byId("folioColumn").setVisible(true);this.byId("referenceColumn").setVisible(true);this.byId("typeDocColumn").setVisible(true);this.byId("dateColumn").setVisible(true);this.byId("amountColumn").setVisible(true);this.byId("mCondicionColumn").setVisible(true);this.byId("bloqueoColumn").setVisible(true);this.byId("conciliacionColumn").setVisible(false);this.byId("tipoMovColumn").setVisible(true);this.byId("tipoColumn").setVisible(false);this.byId("totalRegColumn").setVisible(false);this.byId("debitColumn").setVisible(false);this.byId("creditColumn").setVisible(false);this.byId("costoColumn").setVisible(false);this.byId("sucursalColumn").setVisible(true);this.byId("folio2Column").setVisible(true);this.byId("sumFooter").setVisible(false);this.byId("verReporteColumn").setVisible(true)}else{this.byId("statusColumn").setVisible(false);this.byId("folioColumn").setVisible(false);this.byId("referenceColumn").setVisible(false);this.byId("tipoMovColumn").setVisible(false);this.byId("typeDocColumn").setVisible(false);this.byId("dateColumn").setVisible(false);this.byId("amountColumn").setVisible(false);this.byId("mCondicionColumn").setVisible(false);this.byId("bloqueoColumn").setVisible(false);this.byId("conciliacionColumn").setVisible(false);this.byId("tipoColumn").setVisible(true);this.byId("totalRegColumn").setVisible(true);this.byId("debitColumn").setVisible(false);this.byId("creditColumn").setVisible(false);this.byId("costoColumn").setVisible(true);this.byId("verReporteColumn").setVisible(false);this.byId("sucursalColumn").setVisible(false);this.byId("folio2Column").setVisible(false);this.byId("sumFooter").setVisible(true)}console.log("SET agregation spath",e);this._oTable.bindRows({path:e})},conceptoSelect:function(e){console.log("on condepto select");let t=e.getSource().getBindingContext("GroupedTotales").getPath();console.log(t);var o=t.split("/");var s=t.split("/").reverse()[1];var r=o[o.length-2];console.log("current path",r);if(s!==this.aCrumbs[this.aCrumbs.length-1]){var i=this.byId("breadcrumb");var l=o[o.length-2];var a=this.aCrumbs.indexOf(l)+1;console.log("currentNOde",a);var u=new n({text:"{GroupedTotales>name}",press:[t+"/"+this.aCrumbs[a],this.onBreadcrumbPress,this]});u.bindElement({path:"GroupedTotales>"+t});i.addLink(u)}if(r===this.aCrumbs[this.aCrumbs.length-1]){console.log("on Documento seleccionado....");var c={};console.log("on documnt press",e);console.log(t);let o=this.getOwnerComponent().getModel("GroupedTotales").getProperty(t);console.log(o);var d=this.getOwnerComponent().getModel("GroupedTotales").getProperty("/Bukrs");var h=o.Budat;var m=h.substr(0,4)?h.substr(0,4):"";console.log(this.getOwnerComponent().getModel("totales"));var p=o.Tcode;console.log(d,m,p);var g=o.Belnr;var b=["MEB4","WLF4","MEB2","MEB0","WLF2","ZMMFILACUERDO","WFL5","MEB4"];var f=["Z_APORTACIONES"];var C=["ZMM_ACUERDOS_LIQUI"];console.log(b.includes(p));console.log(g);console.log(o.Foliodescuento);if(p.match("(ZMMFILACUERDO|MEB|WLF).*")&&g.startsWith("51")||p==""&&!(g.startsWith("170")&&o.Foliodescuento)){console.log("on detailAcuerdosAS");this.getOwnerComponent().getRouter().navTo("detailAcuerdos",{layout:sap.f.LayoutType.ThreeColumnsEndExpanded,document:o.Belnr,sociedad:this._sociedad,ejercicio:m,doc:this._document,fecha:this._fecha},true)}else if(f.includes(p)||g.startsWith("170")&&o.Foliodescuento){console.warn("detailAportacionesComplementoS");this.getOwnerComponent().getRouter().navTo("detailAportacionesComplemento",{layout:sap.f.LayoutType.ThreeColumnsEndExpanded,document:o.Foliodescuento,sociedad:this._sociedad,ejercicio:m,doc:this._document,fecha:this._fecha},true)}else if(C.includes(p)||p===""){console.log("on boletin vtz");this.getOwnerComponent().getRouter().navTo("BoletinVtaDetailPolizas",{layout:sap.f.LayoutType.ThreeColumnsEndExpanded,document:g,company:d,year:m},false)}}else{console.log("on grupo seleccionado seleccionado.....");var v="GroupedTotales>";var y=[t,this._nextCrumb(r)].join("/");this._setAggregation(v+y);console.log("new spath",y)}},onBreadcrumbPress:function(e,t){var o=e.getSource();var s=this.byId("breadcrumb");var n=s.indexOfLink(o);var r=s.getLinks().slice(n+1);if(r.length){r.forEach(function(e){e.destroy()});this._setAggregation(t)}},handleFullScreen:function(){var e=this.getOwnerComponent().getHelper().getNextUIState(2);this.bFocusFullScreenButton=true;var t=this.oModel.getProperty("/actionButtonsInfo/midColumn/fullScreen");this.oRouter.navTo("detailComplPagos",{layout:t,document:this._document,sociedad:this._sociedad,ejercicio:this._ejercicio,fecha:this._fecha})},handleExitFullScreen:function(){this.bFocusFullScreenButton=true;var e=this.oModel.getProperty("/actionButtonsInfo/midColumn/exitFullScreen");this.oRouter.navTo("detailComplPagos",{layout:e,document:this._document,sociedad:this._sociedad,ejercicio:this._ejercicio,fecha:this._fecha})},handleClose:function(){console.log("on hanlde close");var e=this.oModel.getProperty("/actionButtonsInfo/midColumn/closeColumn");this.oRouter.navTo("masterCompl",{layout:e})},_onDocumentMatched:function(t){this._document=t.getParameter("arguments").document||this._document||"0";this._sociedad=t.getParameter("arguments").sociedad||this._sociedad||"0";this._ejercicio=t.getParameter("arguments").ejercicio||this._ejercicio||"0";this._fecha=t.getParameter("arguments").fecha||this._fecha||"0";console.log(this._document);this.getView().bindElement({path:"/ProductCollection/"+this._document,model:"products"});this.getView().setModel(new e({document:this._document,fecha:this._fecha,currency:"MXN"}),"detailComplPagos");this.searchData()},onPressReporte:function(e){console.info(e);var t=e.getSource().getBindingContext("GroupedTotales").getPath();console.log(t);let o=this.getOwnerComponent().getModel("GroupedTotales").getProperty(t);let s=this.getConfigModel().getProperty("/supplierInputKey");console.log(o);if(o.Xblnr==""){return}var n=o.Xblnr;var r=n.replace(/[0-9]/g,"");var i=r.replace("-","");var l=n.replace(/\D/g,"");console.log("serie numbers",r);console.log("serie",i);console.log("folio",l);this.getOwnerComponent().getRouter().navTo("ComplementoReporteMC",{layout:sap.f.LayoutType.EndColumnFullScreen,document:l,proveedor:s,serie:r,fecha:o.Budat},false)},hasReport:function(e){return Math.abs(e)>0?true:false},formatCurrency:function(e){let t=parseFloat(e);t=t.toLocaleString("en-US",{style:"currency",currency:"USD"});return(e>0?"-":"")+t.replace("$","")},_onDocumentPress:function(e){console.log("on documnt press",e);let t=e.getSource().getBindingContext("Documentos").getPath().split("/").pop();let o=this.getOwnerComponent().getModel("Documentos").getProperty("/Detalles/Paginated/results");let s=o[t];console.log(s);this.getOwnerComponent().getRouter().navTo("detailComplPagos",{layout:sap.f.LayoutType.TwoColumnsMidExpanded,document:s.Vblnr},true)},onDocumentPress:function(e){console.log("on documnt press",e);let t=e.getSource().getBindingContext("GroupedTotales").getPath();let o=this.getOwnerComponent().getModel("GroupedTotales").getProperty(t);console.log(o);var s=this.getOwnerComponent().getModel("GroupedTotales").getProperty("/Bukrs");var n=o.Budat;var r=n.substr(0,4)?n.substr(0,4):"";var i=o.Tcode;console.log(s,r,i);var l=o.Belnr;var a=["Z_APORTACIONES"];var u=["ZMM_ACUERDOS_LIQUI"];if(i.match("(ZMMFILACUERDO|MEB|WLF).*")&&l.startsWith("51")||i==""&&!(l.startsWith("170")&&o.Foliodescuento)){console.log("on detail factoraje acuerdos",i.match("(ZMMFILACUERDO|MEB|WLF).*"));this.getOwnerComponent().getRouter().navTo("detailAcuerdos",{layout:sap.f.LayoutType.ThreeColumnsEndExpanded,document:o.Belnr,sociedad:this._sociedad,ejercicio:r,doc:this._document,fecha:this._fecha},true)}else if(a.includes(i)||l.startsWith("170")&&o.Foliodescuento){console.warn("detailAportacionesComplementoS");this.getOwnerComponent().getRouter().navTo("detailAportacionesComplemento",{layout:sap.f.LayoutType.ThreeColumnsEndExpanded,document:o.Foliodescuento,sociedad:this._sociedad,ejercicio:n,doc:this._document,fecha:this._fecha},true)}else if(u.includes(i)||i===""){console.log("on boletin vtz");this.getOwnerComponent().getRouter().navTo("BoletinVtaDetailPolizas",{layout:sap.f.LayoutType.ThreeColumnsEndExpanded,document:l,company:s,year:r},false)}},onDocumentDevolucionPress:function(e){var t=e.getSource().getBindingContext("GroupedTotales").getPath();let o=this.getOwnerComponent().getModel("GroupedTotales").getProperty(t);console.log(o);var s=this.getOwnerComponent().getModel("GroupedTotales").getProperty("/Lifnr");this.getOwnerComponent().getRouter().navTo("detailDevoComplemento",{layout:sap.f.LayoutType.ThreeColumnsEndExpanded,xblnr:o.Foliodescuento,lifnr:s,ebeln:o.Ebeln||0,suc:o.Sucursal},true)}})});