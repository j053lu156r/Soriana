sap.ui.define(["sap/ui/model/json/JSONModel","demo/controllers/BaseController","sap/ui/core/mvc/Controller","jquery.sap.global","sap/ui/core/Fragment","demo/models/BaseModel"],function(e,t){"use strict";var s=new this.UserModel;var o=new Map;var r=new Map;return t.extend("demo.controllers.Users.Detail",{onInit:function(){var e=this.getView().byId("exitFullScreenBtn"),t=this.getView().byId("enterFullScreenBtn");this.oRouter=this.getOwnerComponent().getRouter();this.oModel=this.getOwnerComponent().getModel();this.oRouter.getRoute("detailUsers").attachPatternMatched(this._onUserMatched,this);[e,t].forEach(function(e){e.addEventDelegate({onAfterRendering:function(){if(this.bFocusFullScreenButton){this.bFocusFullScreenButton=false;e.focus()}}.bind(this)})},this)},handleHistory:function(e){var t=this.getOwnerComponent().getHelper().getNextUIState(2);var s=this._supplier;if(this._supplier==""){s="-1"}else{s=this._supplier}this.oRouter.navTo("historyUsers",{layout:t.layout,user:this._user,supplier:s})},handleFullScreen:function(){this.bFocusFullScreenButton=true;var e=this.oModel.getProperty("/actionButtonsInfo/midColumn/fullScreen");var t="";if(this._supplier==""){t="-1"}else{t=this._supplier}this.oRouter.navTo("detailUsers",{layout:e,user:this._user,supplier:t})},handleExitFullScreen:function(){this.bFocusFullScreenButton=true;var e=this.oModel.getProperty("/actionButtonsInfo/midColumn/exitFullScreen");var t="";if(this._supplier==""){t="-1"}else{t=this._supplier}this.oRouter.navTo("detailUsers",{layout:e,user:this._user,supplier:t})},handleClose:function(){var e=this.oModel.getProperty("/actionButtonsInfo/midColumn/closeColumn");this.oRouter.navTo("masterUsers",{layout:e})},_onUserMatched:function(t){this._user=t.getParameter("arguments").user||this._user||"0";this._supplier=t.getParameter("arguments").supplier||this._supplier||"0";o.clear();if(this._supplier=="-1"){this._supplier=""}this.clearFields();var r=s.getJsonModel("/headerAdmSet?$expand=ETNOMPROVNAV,ETUSERFUNCNAV&$filter= IOption eq '9' and IIdusua eq '"+this._user+"' and ILifnr eq '"+this._supplier+"'");var n=r.getProperty("/results/0");if(n!=null){n.ETUSERFUNCNAV.results.forEach(function(e){this.defineSelectionCB(e.Idfuncion)},this);this.getOwnerComponent().setModel(new e(n),"detailUserModel");this.getOwnerComponent().setModel(new e(this.getOwnerComponent().getModel("tilesModel").getData()),"tilesModelLocal")}},functionSelected:function(e){var t=e.getSource().getBindingContext("tilesModelLocal").getPath();var s=this.getOwnerComponent().getModel("tilesModelLocal").getProperty(t);var o=s.idFunction;this.defineSelectionCB(o.toString().padStart(6,"000000"))},functionSelectedExtended:function(e){var t=e.getSource().getBindingContext("tilesModelLocal").getPath();var s=this.getOwnerComponent().getModel("tilesModelLocal").getProperty(t);var o=s.idFunction;this.defineSelectionCBExtend(o.toString().padStart(6,"000000"))},defineSelectionCB:function(e){var t=`func-${e}`;if(!o.has(t)){o.set(t,e)}else{o.delete(t)}},defineSelectionCBExtend:function(e){var t=`func-${e}`;if(!r.has(t)){r.set(t,e)}else{r.delete(t)}},hasSelected:function(e){var t=`func-${e.toString().padStart(6,"000000")}`;return o.has(t)},editUser:function(){if(!this.hasAccess(14)){return false}var e=true;var t=this.getOwnerComponent().getModel("userdata").getProperty("/IMail");var o={IOption:"4",IIdusua:this._user,IMail:t,ILifnr:this._supplier,Name1:this.getView().byId("Name1").getValue(),Name2:this.getView().byId("Name2").getValue(),Name3:this.getView().byId("Name3").getValue(),Zpuesto:this.getView().byId("Puesto").getValue(),Zdepart:this.getView().byId("Depto").getValue(),TelNumber:this.getView().byId("Tel1").getValue(),Znomjefe:this.getView().byId("Jefe").getValue(),TelNumber2:this.getView().byId("Tel2").getValue(),Spras:"s"};if(o.TelNumber!=""){if(!this.validatePhone("Tel1")){e=false}}if(o.TelNumber2!=""){if(!this.validatePhone("Tel2")){e=false}}if(e){var r=s.create("/headerAdmSet",o);if(r!=null&&r.ESuccess=="X"){this.editFunctions()}else{sap.m.MessageBox.error(r.EMessage)}}},editFunctions:function(){var e=[];for(let[t,s]of o){e.push({Idfuncion:s.toString()})}var t=this.getOwnerComponent().getModel("userdata").getProperty("/IMail");this.sendFunctions(this._supplier,e,t)},sendFunctions:function(e,t,o){if(e==""&&this.getOwnerComponent().getModel("detailUserModel").getProperty("/Esusdata/Idrol")){e="-1"}var r={IOption:"13",IIdusua:this._user,IMail:o,ILifnr:e,ITFUNCTIONSNAV:t};var n=s.create("/headerAdmSet",r);if(n!=null&&n.ESuccess=="X"){sap.m.MessageBox.success(n.EMessage)}else{sap.m.MessageBox.error(n.EMessage)}},extendUserFunctions:function(e,t,o){if(e==""&&this.getOwnerComponent().getModel("detailUserModel").getProperty("/Esusdata/Idrol")){e="-1"}var r={IOption:"23",IIdusua:this._user,IMail:o,ILifnr:e,ITFUNCTIONSNAV:t};var n=s.create("/headerAdmSet",r);if(n!=null&&n.ESuccess=="X"){sap.m.MessageBox.success(n.EMessage)}else{sap.m.MessageBox.error(n.EMessage)}},clearFields:function(){this.getView().byId("Name1").setValue("");this.getView().byId("Name2").setValue("");this.getView().byId("Name3").setValue("");this.getView().byId("Depto").setValue("");this.getView().byId("Tel1").setValue("");this.getView().byId("Tel2").setValue("");this.getView().byId("Puesto").setValue("");this.getView().byId("Jefe").setValue("");this.getView().byId("Tel1").setValueState(sap.ui.core.ValueState.None);this.getView().byId("Tel2").setValueState(sap.ui.core.ValueState.None);var e=[];var t=15;for(var s=0;s<=t;s++){var o=s.toString();if(this.getView().byId("f-"+o.padStart(6,"000000"))){this.getView().byId("f-"+o.padStart(6,"000000")).setSelected(false)}}},sendInv:function(){var e=this.getOwnerComponent().getModel("detailUserModel").getProperty("/Esusdata/SmtpAddr");var t=this.getOwnerComponent().getModel("userdata").getProperty("/IMail");var o=s.getJsonModel("/headerAdmSet?$expand=ETHISTORINAV&$filter= IOption eq '24' and IMail eq '"+e+"' and ICusua eq '"+t+"'");var r=o.getProperty("/results/0");if(r!=null){if(r.ESuccess=="X"){sap.m.MessageBox.success(`${this.getOwnerComponent().getModel("appTxts").getProperty("/sendCon.send")} ${e}`)}else{sap.m.MessageBox.error(r.EMessage)}}else{sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/logon.erroServer"))}},handleExtendDialog:function(){if(!this._oDialog||this.oDialog===undefined){this._oDialog=sap.ui.xmlfragment("extendUserDialog","demo.fragments.ExtendUser",this)}r.clear();this.getView().addDependent(this._oDialog);jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._oDialog);this._oDialog.open()},extendDialogClose:function(){if(this._oDialog){this._oDialog.destroy();this._oDialog==null}},extendUserSave:function(e){var t=this.getConfigModel().getProperty("/supplierInputKey");var s=[];for(let[e,t]of r){s.push({Idfuncion:t.toString()})}var o=this.getOwnerComponent().getModel("userdata").getProperty("/IMail");this.extendUserFunctions(t,s,o);if(this._oDialog){this._oDialog.destroy()}},handleDropUser:function(){if(!this.hasAccess(15)){return false}var e=this;var t=this.getOwnerComponent().getModel("detailUserModel").getProperty("/Esusdata/Zactivo");var s="";if(t==="B"){s=`${this.getOwnerComponent().getModel("appTxts").getProperty("/nuser.reactiveUser")}`}else{s=`${this.getOwnerComponent().getModel("appTxts").getProperty("/nuser.dropConfirm")}`}sap.m.MessageBox.confirm(s,{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],emphasizedAction:sap.m.MessageBox.Action.YES,onClose:function(t){if(t==sap.m.MessageBox.Action.YES){e.dropUser()}}})},dropUser:function(){if(!this.hasAccess(15)){return}var e=this.getOwnerComponent().getModel("detailUserModel").getProperty("/Esusdata/Zactivo");var t={IOption:"15",IIdusua:this._user,IMail:this.getOwnerComponent().getModel("userdata").getProperty("/IMail"),ITFUNCTIONSNAV:[]};var o=s.create("/headerAdmSet",t);if(o!=null){if(o.ESuccess=="X"){sap.m.MessageBox.success(o.EMessage,{actions:[sap.m.MessageBox.Action.CLOSE],emphasizedAction:sap.m.MessageBox.Action.CLOSE,onClose:function(e){this.oRouter.navTo("masterUsers")}.bind(this)})}else{sap.m.MessageBox.error(o.EMessage)}}else{sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/logon.erroServer"))}},handleChangeToAdmin:function(){var e=this;var t=this.getOwnerComponent().getModel("detailUserModel").getProperty("/Esusdata/Zactivo");var s=`${this.getOwnerComponent().getModel("appTxts").getProperty("/nuser.confToAdmin")}`;var o=this.getOwnerComponent().getModel("detailUserModel");if(o!=null){var r=o.getProperty("/Esusdata/Idrol");if(r=="0001"||r=="0002"){s=`${this.getOwnerComponent().getModel("appTxts").getProperty("/nuser.confToColaborador")}`}}sap.m.MessageBox.confirm(s,{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],emphasizedAction:sap.m.MessageBox.Action.YES,onClose:function(t){if(t==sap.m.MessageBox.Action.YES){e.changeToAdmin()}}})},changeToAdmin:function(){var e=this.getOwnerComponent().getModel("userdata").getProperty("/Esusdata/SmtpAddr");var t=s.getJsonModel("/headerAdmSet?$expand=ETHISTORINAV&$filter=IOption eq '6' and IMail eq '"+e+"' and IIdusua eq '"+this._user+"'");var o=t.getProperty("/results/0");if(o!=null){if(o.ESuccess==="X"){sap.m.MessageBox.success(o.EMessage)}else{sap.m.MessageBox.error(o.EMessage)}}else{sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/logon.erroServer"))}},adminFields:function(e){var t=this.getOwnerComponent().getModel("detailUserModel");if(t!=null){var s=t.getProperty("/Esusdata/Idrol")}var o="";var r=this.getOwnerComponent().getModel("userdata");if(r!=null){o=r.getProperty("/ERol")}var n=true;if(e!=null){n=e.includes(s)&&e.includes(o)}this.getOwnerComponent().getModel().setProperty("/userdetailHadmin",n);n=true;return n},btnChgRolGetName:function(e){return e!="0001"&&e!="0002"?`${this.getOwnerComponent().getModel("appTxts").getProperty("/user.btnChgRol2Adm")}`:`${this.getOwnerComponent().getModel("appTxts").getProperty("/user.btnChgRol2Col")}`},frmBtnChgRolVisible:function(e,t,s,o){return o!=s},frmBtnChgRolVisible2:function(e,t,s,o){return o!=s},validateIfExist:function(){var e=s.getJsonModel()},handleUnlink:function(){var e=this;var t=`Seguro que desea desvincular el proveedor ${this._supplier} de este usuario?`;sap.m.MessageBox.confirm(t,{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],emphasizedAction:sap.m.MessageBox.Action.YES,onClose:function(t){if(t==sap.m.MessageBox.Action.YES){e.unlink()}}})},unlink:function(){var e=this._supplier;var t=this._user;var o=this.getOwnerComponent().getModel("userdata").getProperty("/IMail");var r="/headerAdmSet?$expand=ETNOMPROVNAV&$filter=IOption eq'25'";r+=" and ILifnr eq '"+e+"'";r+=" and IMail eq '"+o+"'";r+=" and IIdusua eq '"+t+"'";var n=s.getJsonModel(r);var i=n.getProperty("/results/0");if(i!=null){if(i.ESuccess==="X"){sap.m.MessageBox.success(i.EMessage)}else{sap.m.MessageBox.error(i.EMessage)}}else{sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/logon.erroServer"))}}})});