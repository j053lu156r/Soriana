sap.ui.define(["demo/controllers/BaseController","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode","sap/ui/table/RowAction","sap/ui/table/RowActionItem","sap/ui/export/library","sap/ui/export/Spreadsheet"],function(e,t,r,i,o,a,n){"use strict";var l=a.EdmType;var s="/sap/opu/odata/sap/ZOSP_MMIM_MIGO_DOC_SRV/";return e.extend("demo.controllers.VisorNotasEntrada.Master",{onInit:function(){$(document).ready(function(){$(document).on("focus",":input",function(){$(this).attr("autocomplete","off")})});this.configFilterLanguage(this.getView().byId("filterBar"));this._oPropertiesModel=new t({rowsCount:""});this._oPropertiesModel.setDefaultBindingMode(r.TwoWay);this.getOwnerComponent().setModel(this._oPropertiesModel,"properties");this.VisibleTable();this.SearchFTienda()},VisibleTable:function(){var e=this;e.oModel=new t({idMblnr:true,idEbeln:true,idBudatMkpf:true,idWerks:true,idXblnr:true,idXblnr2:true});e.getView().setModel(e.oModel);e.TableVisible();var r=e.getOwnerComponent().getModel("appTxts");var i=[];i.push({text:r.getProperty("/visor.invoice"),key:"XblnrFact"},{text:r.getProperty("/visor.Frecibo"),key:"Xblnr"},{text:r.getProperty("/visor.order"),key:"Ebeln"});var o=new sap.ui.model.json.JSONModel(i);e.getView().setModel(o,"OPFiltros");var a=new Date;a=a.getTime()-1e3*60*60*24*7;e.getView().byId("dateRange").setDateValue(new Date(a));e.getView().byId("dateRange").setSecondDateValue(new Date)},SearchFTienda:function(){var e=[];e.push(new sap.ui.model.Filter({path:"Zoption",operator:sap.ui.model.FilterOperator.EQ,value1:"2"}));var t=this;var r="ZOSP_MMPI_MATNR_LIST_SRV";var i="EKORG_LIST";var o="";var a=e;var n="";sap.ui.core.BusyIndicator.show();t._GEToDataV2(r,i,a,o,n).then(function(e){sap.ui.core.BusyIndicator.hide();var r=e.data.results;console.log(r);const i=new sap.ui.model.json.JSONModel(r);t.getView().setModel(i,"Tienda")})},TableVisible:function(){var e=this;e.getView().byId("idMblnr").setVisible(e.getView().getModel().getProperty("/idMblnr"));e.getView().byId("idEbeln").setVisible(e.getView().getModel().getProperty("/idEbeln"));e.getView().byId("idBudatMkpf").setVisible(e.getView().getModel().getProperty("/idBudatMkpf"));e.getView().byId("idWerks").setVisible(e.getView().getModel().getProperty("/idWerks"));e.getView().byId("idXblnr").setVisible(e.getView().getModel().getProperty("/idXblnr"));e.getView().byId("idXblnr2").setVisible(e.getView().getModel().getProperty("/idXblnr2"))},onChange:function(){var e=this.getView().byId("dateRange").getDateValue();var t=this.getView().byId("dateRange").getSecondDateValue();var r=new Date;r=t.getTime()-1e3*60*60*24*7;console.log(e.getTime());console.log(t.getTime());console.log(t.getTime()-e.getTime());if(t.getTime()-e.getTime()>6048e5){sap.m.MessageBox.error("la busqueda no puede ser superior a 7 dias ");console.log(new Date(r));console.log(t);this.getView().byId("dateRange").setDateValue(new Date(r));this.getView().byId("dateRange").setSecondDateValue(t)}},Validacion:function(){var e=this;if(!e.getView().byId("OPFiltrosC").getSelectedKey()){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/visor.ComboboxError"));e.getView().byId("inpInvoice").setValue("");return false}},onPress:function(e){var t=e.getSource().getParent();var r=this;var i=t.getBindingContext("migoModel").getProperty("Mblnr");var o=t.getBindingContext("migoModel").getProperty("Mjahr");var a=t.getBindingContext("migoModel").getProperty("Ebeln");var n=t.getBindingContext("migoModel").getProperty("Lifnr");var l=t.getBindingContext("migoModel").getProperty("BudatMkpf");var s=t.getBindingContext("migoModel").getProperty("Werks");var p=t.getBindingContext("migoModel").getProperty("Xblnr");var g=t.getBindingContext("migoModel").getProperty("XblnrFact");if(p===""){p="0.1"}if(g===""){g="0.1"}this.getOwnerComponent().getRouter().navTo("detailVisorNotas",{layout:sap.f.LayoutType.MidColumnFullScreen,Mblnr:i,Mjahr:o,Ebeln:a,Lifnr:n,BudatMkpf:l,Werks:s,Xblnr:p,XblnrFact:g})},searchData:function(){if(!this.hasAccess(48)){return false}var e=this;var t=e.getView().getModel("configSite").getData();if(e.getView().byId("supplierInput").getValue()===""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/visor.SearchError"));return false}var r=[];if(e.getView().byId("dateRange").getValue().split("-")[1].trim()===e.getView().byId("dateRange").getValue().split("-")[0].trim()){var i=e.getView().byId("dateRange").getDateValue();var o=e.getView().byId("dateRange").getDateValue()}else{var i=e.getView().byId("dateRange").getDateValue();var o=e.getView().byId("dateRange").getSecondDateValue()}r.push(new sap.ui.model.Filter({path:"BudatMkpf",operator:sap.ui.model.FilterOperator.BT,value1:i.toISOString().slice(0,10)+"T00:00:00",value2:o.toISOString().slice(0,10)+"T00:00:00"}));r.push(new sap.ui.model.Filter({path:"Lifnr",operator:sap.ui.model.FilterOperator.EQ,value1:t.supplierInputKey}));if(this.getView().byId("FtiendNT").getSelectedKey()!==""){var a="";r.push(new sap.ui.model.Filter({path:"Ekorg",operator:sap.ui.model.FilterOperator.EQ,value1:this.getView().byId("FtiendNT").getSelectedKey()}))}else{sap.m.MessageBox.error("Favor Seleccione Formato Tienda");return false}if(this.getView().byId("inpInvoice").getValue()!==""){var a="";r.push(new sap.ui.model.Filter({path:e.getView().byId("OPFiltrosC").getSelectedKey(),operator:sap.ui.model.FilterOperator.EQ,value1:this.getView().byId("inpInvoice").getValue()}))}var n="ZOSP_MMIM_MIGO_DOC_SRV";var l="MIGO_DOC";var s="DocDetalleNav";var p=r;var g="";sap.ui.core.BusyIndicator.show();e._GEToDataV2(n,l,p,s,g).then(function(t){sap.ui.core.BusyIndicator.hide();var r=t.data.results;for(var i=0;i<r.length;i++){r[i].BudatMkpf=new Date(r[i].BudatMkpf).toISOString().slice(0,10)}var o=new sap.ui.model.json.JSONModel(r);e.getView().setModel(o,"migoModel");e.genereteRowAction()})},genereteRowAction:function(){var e=this.getOwnerComponent().getModel("appTxts");var t=this.byId("tableVisor");var r=t.getRowActionTemplate();if(r){r.destroy();r=null}r=new i({items:[new o({icon:"sap-icon://open-command-field",text:e.getProperty("/global.view"),press:e=>this.onPress(e)})]});t.setRowActionTemplate(r);t.setRowActionCount(2)},createColumnConfig:function(){var e=this;var t=e.getView().getModel("migoModel").getData(),r=[];var i=this.getOwnerComponent().getModel("appTxts");r.push({label:i.getProperty("/visor.folio"),type:l.String,property:"Mblnr"});r.push({label:i.getProperty("/visor.order"),type:l.String,property:"Ebeln"});r.push({label:i.getProperty("/visor.supplier"),type:l.String,property:"Lifnr"});r.push({label:i.getProperty("/visor.receivedDate"),type:l.String,property:"BudatMkpf"});r.push({label:i.getProperty("/visor.branchOffice"),type:l.String,property:"Werks"});r.push({label:i.getProperty("/visor.invoice"),type:l.String,property:"XblnrFact"});return r},buildExportTable:function(){var e,t,r,i,o,a=this;if(!a._oTable){a._oTable=this.byId("tableVisor")}o=a._oTable;t=o.getBinding().oList;e=a.createColumnConfig();r={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:t,fileName:"Notas de Entrada",worker:false};i=new n(r);i.build().finally(function(){i.destroy()})},ConfigTable:function(){var e=this;var t=e.getView().byId("dinamicTableNE");if(!t){t=sap.ui.xmlfragment(e.getView().getId(),"demo.views.VisorNotasEntrada.fragment.optionNE",this);e.getView().addDependent(t);e.getView().byId("dinamicTableNE").addStyleClass(e.getOwnerComponent().getContentDensityClass())}t.open()},ClosepopUp:function(){var e=this;e.TableVisible();e.getView().byId("dinamicTableNE").close()},onParentClicked:function(e){var t=e.getParameter("selected");this.oModel.setData({idMblnr:t,idEbeln:t,idBudatMkpf:t,idWerks:t,idXblnr:t,idXblnr2:t})},DMAsivo:function(){var e=this;var t=e.getView().getModel("migoModel").getData();var r=[];for(var i=0;i<t.length;i++){var o=t[i].DocDetalleNav.results;r.push({BudatMkpf:t[i].BudatMkpf,Ebeln:t[i].Ebeln,Lifnr:t[i].Lifnr,Mblnr:t[i].Mblnr,Mjahr:t[i].Mjahr,Werks:t[i].Werks,Xblnr:t[i].Xblnr,XblnrFact:t[i].XblnrFact,Ean11p:"",Ebelnp:"",Ebelpp:"",Erfmep:"",Erfmgp:"",Maktxp:"",Matnrp:"",Mblnrp:"",Meinsp:"",Mengep:"",Mjahrp:"",Zeilep:""});for(var a=0;a<o.length;a++){r.push({BudatMkpf:"",Ebeln:"",Lifnr:"",Mblnr:"",Mjahr:"",Werks:"",Xblnr:"",XblnrFact:"",Ean11p:o[a].Ean11,Ebelnp:o[a].Ebeln,Ebelpp:o[a].Ebelp,Erfmep:o[a].Erfme,Erfmgp:o[a].Erfmg,Maktxp:o[a].Maktx,Matnrp:o[a].Matnr,Mblnrp:o[a].Mblnr,Meinsp:o[a].Meins,Mengep:o[a].Menge,Mjahrp:o[a].Mjahr,Zeilep:o[a].Zeile,Fconverp:Number(o[a].Menge)/Number(o[a].Erfmg)})}}var n=new sap.ui.model.json.JSONModel(r);e.getView().setModel(n,"ExcelMasivo");this.buildExportTable2()},createColumnConfig2:function(){var e=this;var t=e.getView().getModel("ExcelMasivo").getData(),r=[];var i=this.getOwnerComponent().getModel("appTxts");r.push({label:i.getProperty("/visor.folio"),type:l.String,property:"Mblnr"});r.push({label:i.getProperty("/visor.order"),type:l.String,property:"Ebeln"});r.push({label:i.getProperty("/visor.supplier"),type:l.String,property:"Lifnr"});r.push({label:i.getProperty("/visor.receivedDate"),type:l.String,property:"BudatMkpf"});r.push({label:i.getProperty("/visor.branchOffice"),type:l.String,property:"Werks"});r.push({label:i.getProperty("/visor.invoice"),type:l.String,property:"XblnrFact"});r.push({label:i.getProperty("/visor.Frecibo"),type:l.String,property:"Xblnr"});r.push({label:i.getProperty("/visor.position"),type:l.String,property:"Ebelpp"});r.push({label:i.getProperty("/visor.codigo"),type:l.String,property:"Ean11p"});r.push({label:i.getProperty("/visor.descripcion"),type:l.String,property:"Maktxp"});r.push({label:i.getProperty("/visor.quantity"),type:l.String,property:"Erfmgp"});r.push({label:i.getProperty("/visor.Fconver"),type:l.String,property:"Fconverp"});r.push({label:i.getProperty("/visor.capacidad"),type:l.String,property:"Mengep"});return r},buildExportTable2:function(){var e,t,r,i;e=this.createColumnConfig2();t=this.getView().getModel("ExcelMasivo").getProperty("/");r={workbook:{columns:e},dataSource:t,fileName:"Notas de Entrada"};i=new n(r);i.build().then(function(){}).finally(i.destroy)},clearFilters:function(){this.getView().byId("inpInvoice").setValue("");this.getView().byId("dateRange").setValue("")}})});