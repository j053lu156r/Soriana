sap.ui.define(["sap/ui/model/json/JSONModel","demo/controllers/BaseController","demo/models/BaseModel","sap/m/Label","sap/m/Link","sap/m/MessageToast","sap/m/Text","sap/ui/core/Fragment"],function(t,e,s,o,i,n,r,a){"use strict";var l="/sap/opu/odata/sap/ZOSP_STATEMENT_SRV_01/";var u;var d=new Date;return e.extend("demo.controllers.ComplPago.DetallePagoFuturo",{sCollection:"GroupedTotales>/Hierarchy",aCrumbs:["movimientos","positions"],mInitialOrderState:{products:{},count:0,hasCounts:false},onInit:function(){var e=this.getView().byId("exitFullScreenBtn"),s=this.getView().byId("enterFullScreenBtn");this.oRouter=this.getOwnerComponent().getRouter();this.oModel=this.getOwnerComponent().getModel();this.oRouter.getRoute("detailComplPagos").attachPatternMatched(this._onDocumentMatched,this);this.getView().addEventDelegate({onBeforeShow:function(e){this.getOwnerComponent().setModel(new t,"totales");var s=new t({filtros:[{filtro:"belnr",descripcion:"Documento"},{filtro:"xblnr",descripcion:"Factura"},{filtro:"",descripcion:""}]});this.getView().setModel(s,"filterOptions")}},this);if(!this._pTemplate){this._pTemplate=a.load({id:this.getView().getId(),name:"demo.views.ComplPago.Row"})}this._oTable=this.byId("idGroupTable")},searchData:function(){let e=this.getConfigModel().getProperty("/supplierInputKey");let s=new Date;let o="20160219";let i=this.buildSapDate(s);let n=this._document;if(e==null||e==""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/global.supplierSelectError"));return false}if(o==""||i==""){}var r="";var a=this.getOdata(l);let d=`EStmtHdrSet?$expand=Citms,Oitms&$filter= Lifnr eq '${e}' and Datei eq '${o}' and Datef eq '${i}' ${r} &$format=json`;var c=this.getOdataJsonModel(d,a);u=c.getJSON();var h=JSON.parse(u);let m=[...h.results[0].Citms.results,...h.results[0].Oitms.results];h.results[0].Detalles={results:[...m]};delete h.results[0].Citms;delete h.results[0].Oitms;var b=$.extend({},h.results[0]);var g=new t;g.setData(b);console.info("agrupando datos",m);let p=[...m];var f=this.groupArrayOfObjects(p,"DescTipomov");var C=[];var v=this;for(let t in f){console.log("sumando valores");var y=f[t].reduce(function(t,e){var s=e.Bschl==="21"?Number(e.Wrbtr):0;var o=t+s;return v.truncate(o,2)},0);var I=f[t].reduce(function(t,e){var s=e.Bschl!=="21"?Number(e.Wrbtr):0;var o=t+s;return v.truncate(o,2)},0);var V=f[t].reduce(function(t,e){var s=Number(e.Wrbtr);var o=t+s;return v.truncate(o,2)},0);C.push({name:t,totalRegs:f[t].length,totalDebit:Math.abs(I),totalCredit:Math.abs(y),cost:Math.abs(V),positions:f[t]})}console.log(C);var M=C.reduce(function(t,e){var s=Number(e.totalRegs);var o=t+s;return v.truncate(o,2)},0);var _=C.reduce(function(t,e){var s=Number(e.totalDebit);var o=t+s;return v.truncate(o,2)},0);var w=C.reduce(function(t,e){var s=Number(e.totalCredit);var o=t+s;return v.truncate(o,2)},0);var T=C.reduce(function(t,e){var s=Number(e.cost);var o=t+s;return v.truncate(o,2)},0);var P=new t({Hierarchy:{movimientos:C,totalR:M,totalD:_,totalC:w,totalCostos:T}});console.log(P);this.getOwnerComponent().setModel(P,"GroupedTotales");this.initTable()},subtractYears:function(t,e=new Date){e.setFullYear(e.getFullYear()-t);return e},groupArrayOfObjects:function(t,e){return t.reduce(function(t,s){(t[s[e]]=t[s[e]]||[]).push(s);return t},{})},initTable:function(){console.log("on init table");var t=this._getInitialPath();this._setAggregation(t);var e=this.byId("breadcrumb");var s=new i({text:"{appTxts>/aportaciones.concepto}",press:[t,this.onBreadcrumbPress,this]});e.destroyLinks();e.addLink(s)},_getInitialPath:function(){return[this.sCollection,this.aCrumbs[0]].join("/")},_nextCrumb:function(t){for(var e=0,s=this.aCrumbs.length;e<s;e++){if(this.aCrumbs[e]===t){return this.aCrumbs[e+1]}}},truncate:function(t,e){return Math.trunc(t*Math.pow(10,e))/Math.pow(10,e)},_stripItemBinding:function(t){var e=t.split("/");return e.slice(0,e.length-1).join("/")},_setAggregation:function(t){var e=t.split("/").reverse()[0];if(e===this.aCrumbs[this.aCrumbs.length-1]){this._oTable.setMode("None");this.byId("statusColumn").setVisible(true);this.byId("folioColumn").setVisible(true);this.byId("referenceColumn").setVisible(true);this.byId("typeDocColumn").setVisible(true);this.byId("dateColumn").setVisible(true);this.byId("amountColumn").setVisible(true);this.byId("mCondicionColumn").setVisible(true);this.byId("bloqueoColumn").setVisible(true);this.byId("conciliacionColumn").setVisible(true);this.byId("tipoMovColumn").setVisible(true);this.byId("tipoColumn").setVisible(false);this.byId("totalRegColumn").setVisible(false);this.byId("debitColumn").setVisible(false);this.byId("creditColumn").setVisible(false);this.byId("costoColumn").setVisible(false)}else{this._oTable.setMode("SingleSelectMaster");this.byId("statusColumn").setVisible(false);this.byId("tipoMovColumn").setVisible(false);this.byId("folioColumn").setVisible(false);this.byId("referenceColumn").setVisible(false);this.byId("typeDocColumn").setVisible(false);this.byId("dateColumn").setVisible(false);this.byId("amountColumn").setVisible(false);this.byId("mCondicionColumn").setVisible(false);this.byId("bloqueoColumn").setVisible(false);this.byId("conciliacionColumn").setVisible(false);this.byId("tipoColumn").setVisible(true);this.byId("totalRegColumn").setVisible(true);this.byId("debitColumn").setVisible(false);this.byId("creditColumn").setVisible(false);this.byId("costoColumn").setVisible(true)}console.log("SET agregation spath",t);this._pTemplate.then(function(e){this._oTable.bindAggregation("items",t,e)}.bind(this))},handleSelection:function(t){console.log("on condepto select");var e=t.getParameter("listItem").getBindingContextPath();console.log(e);var s=e.split("/");var o=e.split("/").reverse()[1];var n=s[s.length-2];console.log("current path",n);if(o!==this.aCrumbs[this.aCrumbs.length-1]){var r=this.byId("breadcrumb");var a=s[s.length-2];var l=this.aCrumbs.indexOf(a)+1;console.log("currentNOde",l);var u=new i({text:"{GroupedTotales>name}",press:[e+"/"+this.aCrumbs[l],this.onBreadcrumbPress,this]});u.bindElement({path:"GroupedTotales>"+e});r.addLink(u)}if(n===this.aCrumbs[this.aCrumbs.length-1]){var d={};var c=t.getParameter("selected");t.getParameter("listItems").forEach(function(t){d[t.getBindingContext().getPath()]=c});this._updateOrder(d)}else{var h="GroupedTotales>";var m=[e,this._nextCrumb(n)].join("/");this._setAggregation(h+m);console.log("new spath",m)}},onBreadcrumbPress:function(t,e){var s=t.getSource();var o=this.byId("breadcrumb");var i=o.indexOfLink(s);var n=o.getLinks().slice(i+1);if(n.length){n.forEach(function(t){t.destroy()});this._setAggregation(e)}},handleFullScreen:function(){var t=this.getOwnerComponent().getHelper().getNextUIState(2);this.bFocusFullScreenButton=true;var e=this.oModel.getProperty("/actionButtonsInfo/midColumn/fullScreen");this.oRouter.navTo("detailComplPagos",{layout:e,document:this._document})},handleExitFullScreen:function(){this.bFocusFullScreenButton=true;var t=this.oModel.getProperty("/actionButtonsInfo/midColumn/exitFullScreen");this.oRouter.navTo("detailComplPagos",{layout:t,document:this._document})},handleClose:function(){console.log("on hanlde close");var t=this.oModel.getProperty("/actionButtonsInfo/midColumn/closeColumn");this.oRouter.navTo("masterCompl",{layout:t})},_onDocumentMatched:function(e){this._document=e.getParameter("arguments").document||this._document||"0";console.log(this._document);this.getView().bindElement({path:"/ProductCollection/"+this._document,model:"products"});this.getView().setModel(new t({document:this._document}),"detailComplPagos");this.searchData()}})});