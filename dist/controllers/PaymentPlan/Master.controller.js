sap.ui.define(["sap/ui/core/Fragment","demo/controllers/BaseController","sap/ui/core/routing/History","sap/m/PDFViewer","sap/ui/model/json/JSONModel","sap/ui/core/routing/Router","demo/models/BaseModel","sap/m/MessageBox","sap/m/MessageToast","sap/m/Link"],function(e,t,a,s,o,r,n,i,l,u){"use strict";var d=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYY-MM-dd"});var g="/sap/opu/odata/sap/ZOSP_STATEMENT_SRV_01/";var c;var h=new Date;var b=new this.PaymentPlan;return t.extend("demo.controllers.PaymentPlan.Master",{sCollection:"GroupedDates>/Hierarchy",aCrumbs:["dates","positions"],mInitialOrderState:{products:{},count:0,hasCounts:false},onInit:function(){this.getView().addEventDelegate({onAfterShow:function(e){var t=this.getConfigModel();t.setProperty("/barVisible",true);this.getOwnerComponent().setModel(new o,"tableItemsPayPlan");this.getView().byId("docno").setValue("");this.getView().byId("datePay").setValue("")}},this);if(!this._pTemplate){this._pTemplate=e.load({id:this.getView().getId(),name:"demo.views.PaymentPlan.Row"})}this._oTable=this.byId("idGroupTable")},searchData:function(){var e=false;if(!b.getModel()){b.initModel()}var t=sap.ui.core.format.DateFormat.getDateTimeInstance({parent:"yyyyMMdd"});var a=this.getView().byId("datePay");var s=this.buildSapDate(a.getDateValue());var r=this.buildSapDate(a.getSecondDateValue());var n=this.getConfigModel().getProperty("/supplierInputKey");var i=this.getView().byId("docno").getValue();if(n!=null&&n!=""){e=true}else{sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/global.supplierSelectError"))}if(e){if(i==""){if(s!=""&&r!=""){e=true}else{e=true}}else{e=true}}if(e){var l="/EPPLSTSet?$filter= Ioption eq '2' and Lifnr eq '"+n+"'";if(i!=""){l+=" and Ivblnr eq '"+i+"'"}if(s!=""&&r!=""){l+=" and Ilaufdi eq '"+s+"' and Ilaufdf eq '"+r+"'"}else{var u="20220630";var g="20220601";l+=" and Ilaufdi eq '"+g+"' and Ilaufdf eq '"+u+"'"}var c=b.getJsonModel(l);var h=c.getProperty("/results");var m={TBLPAYS:{results:[]}};h.forEach(function(e){m.TBLPAYS.results.push(e)});const e=h.map(e=>({...e,date:new Date(e.Laufd)}));var p=[...e].sort((e,t)=>Number(e.date)-Number(t.date));console.log(p);for(var f in p){var v=new Date;var y=new Date(p[f].Laufd.replace(/-/g,"/"));var D;if(Number(y)>Number(v)){D=this.getNextDayOfWeek(new Date(p[f].Laufd.replace(/-/g,"/")),5)}else{D=this.getNextDayOfWeek(new Date,5)}p[f].fechaCorte=d.format(D)}var C=this.groupArrayOfObjects(p,"fechaCorte");var w=[];var P=this;var I=0;for(let e in C){console.log(C);console.log(e);console.log("sumando valores");var V=C[e].reduce(function(e,t){var a=Number(t.Rbetr);var s=e+a;console.log(s);return s},0);console.log(V);var M=.001;V=V+M;console.log(V);I=I+V,console.log(I);w.push({name:e,totalRegs:C[e].length,cost:P.truncate(V,2),positions:C[e],costoAcumulado:P.truncate(I,2)})}console.log(w);var T=w.reduce(function(e,t){var a=Number(t.cost);var s=e+a;console.log(s);return s},0);var L=new o({Hierarchy:{dates:w,totalCostos:T}});console.log(L);this.getOwnerComponent().setModel(L,"GroupedDates");this.initTable();this.getOwnerComponent().setModel(new o(m),"tableItemsPayPlan");this.paginate("tableItemsPayPlan","/TBLPAYS",1,0)}},onExit:function(){},filtrado:function(e){var t=[];var a=e.getParameter("query");var s=this.getView().byId("selectFilter");var o=s.getSelectedKey();if(a&&a.length>0){var r=new sap.ui.model.Filter(o,sap.ui.model.FilterOperator.Contains,a);t.push(r)}var n=this.getView().byId("complPagoList");var i=n.getBinding("items");i.filter(t)},setDaterangeMaxMin:function(){var e=this.getView().byId("dateRange");var t=new Date;var a=new Date;var s=new Date;s.setDate(t.getDate()-7);a.setDate(t.getDate()-30);e.setSecondDateValue(t);e.setDateValue(s)},onListItemPress:function(e){var t=e.getSource().getBindingContext("tableItemsPayPlan").getPath(),a=t.split("/").slice(-1).pop();var s=this.getOwnerComponent().getModel("tableItemsPayPlan");var o=s.getProperty("/TBLPAYS/results");var r=o[a];this.getOwnerComponent().getRouter().navTo("detailPayPlan",{layout:sap.f.LayoutType.TwoColumnsMidExpanded,document:r.Vblnr,laufd:r.Laufd,laufi:r.Laufi,zbukr:r.Zbukr,lifnr:r.Lifnr},true)},subtractYears:function(e,t=new Date){t.setFullYear(t.getFullYear()-e);return t},groupArrayOfObjects:function(e,t){return e.reduce(function(e,a){(e[a[t]]=e[a[t]]||[]).push(a);return e},{})},truncate:function(e,t){return Math.trunc(e*Math.pow(10,t))/Math.pow(10,t)},getDaysBetweenDates:function(e,t,a){var s=[];var o={sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6};var r=o[a.toLowerCase().substr(0,3)];var n=new Date(e);n.setDate(n.getDate()+(r-n.getDay()+7)%7);while(n<t){s.push(new Date(+n));n.setDate(n.getDate()+7)}return s},getNextDayOfWeek:function(e,t){var a=new Date(e.getTime());a.setDate(e.getDate()+(7+t-e.getDay())%7);return a},initTable:function(){console.log("on init table");var e=this._getInitialPath();this._setAggregation(e);var t=this.byId("breadcrumb");var a=new u({text:"{appTxts>/plan.dateCorte}",press:[e,this.onBreadcrumbPress,this]});t.destroyLinks();t.addLink(a)},_getInitialPath:function(){return[this.sCollection,this.aCrumbs[0]].join("/")},_nextCrumb:function(e){for(var t=0,a=this.aCrumbs.length;t<a;t++){if(this.aCrumbs[t]===e){return this.aCrumbs[t+1]}}},onBreadcrumbPress:function(e,t){var a=e.getSource();var s=this.byId("breadcrumb");var o=s.indexOfLink(a);var r=s.getLinks().slice(o+1);if(r.length){r.forEach(function(e){e.destroy()});this._setAggregation(t)}},_setAggregation:function(e){var t=e.split("/").reverse()[0];if(t===this.aCrumbs[this.aCrumbs.length-1]){this._oTable.setMode("None");this._oTable.setMode("SingleSelectMaster");this.byId("paymentDocColumn").setVisible(true);this.byId("clientColumn").setVisible(true);this.byId("amountColumn").setVisible(true);this.byId("datePayColumn").setVisible(true);this.byId("dateCorte").setVisible(false);this.byId("saldoCorte").setVisible(false);this.byId("saldoAcumulado").setVisible(false)}else{this._oTable.setMode("SingleSelectMaster");this.byId("paymentDocColumn").setVisible(false);this.byId("clientColumn").setVisible(false);this.byId("amountColumn").setVisible(false);this.byId("datePayColumn").setVisible(false);this.byId("dateCorte").setVisible(true);this.byId("saldoCorte").setVisible(true);this.byId("saldoAcumulado").setVisible(true)}console.log("SET agregation spath",e);this._pTemplate.then(function(t){this._oTable.bindAggregation("items",e,t)}.bind(this))},handleSelection:function(e){console.log("on condepto select");var t=e.getParameter("listItem").getBindingContextPath();console.log(t);var a=t.split("/");var s=t.split("/").reverse()[1];var o=a[a.length-2];console.log("current path",o);if(s!==this.aCrumbs[this.aCrumbs.length-1]){var r=this.byId("breadcrumb");var n=a[a.length-2];var i=this.aCrumbs.indexOf(n)+1;console.log("currentNOde",i);var l=new u({text:"{GroupedDates>name}",press:[t+"/"+this.aCrumbs[i],this.onBreadcrumbPress,this]});l.bindElement({path:"GroupedDates>"+t});r.addLink(l)}if(o===this.aCrumbs[this.aCrumbs.length-1]){console.log("on Documento seleccionado....");var d={};console.log("on documnt press",e);console.log(t);let a=this.getOwnerComponent().getModel("GroupedDates").getProperty(t);console.log(a);this.getOwnerComponent().getRouter().navTo("detailPayPlan",{layout:sap.f.LayoutType.TwoColumnsMidExpanded,document:a.Vblnr,laufd:a.Laufd,laufi:a.Laufi,zbukr:a.Zbukr,lifnr:a.Lifnr},true)}else{console.log("on grupo seleccionado seleccionado.....");var g="GroupedDates>";var c=[t,this._nextCrumb(o)].join("/");this._setAggregation(g+c);console.log("new spath",c)}}})});