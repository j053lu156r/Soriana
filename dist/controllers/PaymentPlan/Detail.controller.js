sap.ui.define(["sap/ui/model/json/JSONModel","demo/controllers/BaseController","demo/models/BaseModel","sap/m/Label","sap/m/Link","sap/m/MessageToast","sap/m/Text","sap/ui/core/Fragment"],function(t,e,n,a,r,o,i,l){"use strict";var s="/sap/opu/odata/sap/ZOSP_STATEMENT_SRV_01/";var u;var c=new this.PaymentPlan;return e.extend("demo.controllers.PaymentPlans.Detail",{sCollection:"GroupedTotales>/Hierarchy",aCrumbs:["movimientos","positions"],mInitialOrderState:{products:{},count:0,hasCounts:false},onInit:function(){var t=this.getView().byId("exitFullScreenBtn"),e=this.getView().byId("enterFullScreenBtn");this.oRouter=this.getOwnerComponent().getRouter();this.oModel=this.getOwnerComponent().getModel();this.oRouter.getRoute("detailPayPlan").attachPatternMatched(this._onDocumentMatched,this);[t,e].forEach(function(t){t.addEventDelegate({onAfterRendering:function(){if(this.bFocusFullScreenButton){this.bFocusFullScreenButton=false;t.focus()}}.bind(this)})},this);if(!this._pTemplate){this._pTemplate=l.load({id:this.getView().getId(),name:"demo.views.PaymentPlan.Row"})}this._oTable=this.byId("idGroupTable")},handleItemPress:function(e){var n=this.getOwnerComponent().getHelper().getNextUIState(2),a=e.getSource().getBindingContext("tableDetailMoves").getPath();var r=this.getOwnerComponent().getModel("tableDetailMoves").getProperty(a);if(!this._oDialog||this.oDialog===undefined){this._oDialog=sap.ui.xmlfragment("demo.fragments.Exhaustion",this)}this.getView().addDependent(this._oDialog);jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._oDialog);this._oDialog.setModel(new t(r));this._oDialog.open()},handleFullScreen:function(){this.bFocusFullScreenButton=true;var t=this.oModel.getProperty("/actionButtonsInfo/midColumn/fullScreen");this.oRouter.navTo("detailPayPlan",{layout:t,document:this._document,laufd:this._laufd,laufi:this._laufi,zbukr:this._zbukr,lifnr:this._lifnr})},handleExitFullScreen:function(){this.bFocusFullScreenButton=true;var t=this.oModel.getProperty("/actionButtonsInfo/midColumn/exitFullScreen");this.oRouter.navTo("detailPayPlan",{layout:t,document:this._document,laufd:this._laufd,laufi:this._laufi,zbukr:this._zbukr,lifnr:this._lifnr})},handleClose:function(){var t=this.oModel.getProperty("/actionButtonsInfo/midColumn/closeColumn");this.oRouter.navTo("masterPayPlan",{layout:t})},_onDocumentMatched:function(e){this._document=e.getParameter("arguments").document||this._document||"0",this._laufd=e.getParameter("arguments").laufd||this._laufd||"0",this._laufi=e.getParameter("arguments").laufi||this._laufi||"0",this._zbukr=e.getParameter("arguments").zbukr||this._zbukr||"0",this._lifnr=e.getParameter("arguments").lifnr||this._lifnr||"0";this._laufd=this._laufd.replaceAll("-","");var n="EPPHDRSet?$expand=EDETNAV,EGRPNAV&$filter=IOption eq '1' and Lifnr eq '"+this._lifnr+"'"+" and Vblnr eq '"+this._document+"'"+" and Laufd eq '"+this._laufd+"'"+" and Laufi eq '"+this._laufi+"'"+" and Zbukr eq '"+this._zbukr+"'";var a=c.getJsonModel(n);var r=a.getProperty("/results/0");this.getOwnerComponent().setModel(new t(r),"payPlanDetail");this.paginate("payPlanDetail","/EDETNAV",1,0)},formatSatusOrder:function(t){if(t){return"Cerrado"}else{return"Abierto"}},onCloseDialog:function(){if(this._oDialog){this._oDialog.destroy();this._oDialog=null}},onExit:function(){this.onCloseDialog()},buildExcel:function(){var t=this.getOwnerComponent().getModel("appTxts");let e=this.getOwnerComponent().getModel("payPlanDetail");var n=[{name:t.getProperty("/plan.paymentDocUPC"),template:{content:e.getProperty("/Vblnr")}},{name:t.getProperty("/plan.societyUPC"),template:{content:e.getProperty("/Zbukr")}},{name:t.getProperty("/plan.societyUPC"),template:{content:e.getProperty("/Butxt")}},{name:t.getProperty("/plan.amountUPC"),template:{content:e.getProperty("/Rwbtr")}},{name:t.getProperty("/plan.paymentDateUPC"),template:{content:e.getProperty("/Valut")}},{name:t.getProperty("/global.exerciseUPC"),template:{content:e.getProperty("/Gjahr")}},{name:t.getProperty("/plan.supplierUPC"),template:{content:e.getProperty("/Lifnr")}},{name:t.getProperty("/plan.totalAmountUPC"),template:{content:e.getProperty("/Tfactura")}},{name:t.getProperty("/plan.docCountUPC"),template:{content:e.getProperty("/Cfactura")}},{name:t.getProperty("/plan.documentsUPC"),template:{content:"{Blnr}"}},{name:t.getProperty("/plan.descriptionUPC"),template:{content:"{Ltext}"}},{name:t.getProperty("/plan.referenceUPC"),template:{content:"{Xref3}"}},{name:t.getProperty("/plan.quantityUPC"),template:{content:"{Wrbtr}"}},{name:t.getProperty("/global.currencyUC"),template:{content:"{Waers}"}},{name:t.getProperty("/plan.invoiceNumUPC"),template:{content:"{Xblnr}"}},{name:t.getProperty("/plan.dateDocUPC"),template:{content:"{Budat}"}}];this.exportxls("payPlanDetail","/EDETNAV/results",n)},generateFile:function(t){let e=t.getSource().getBindingContext("payPlanDetail").getPath().split("/").pop();let n=this.getOwnerComponent().getModel("payPlanDetail").getProperty("/EDETNAV/Paginated/results");let a=n[e];let r=String(a.Laufd).replace(/-/g,"");let o=`EPPHDRSet?$expand=EDTLHDR,ECABCNV,EDETCNV&$filter=IOption eq '2' and \n            Zbukr  eq '${a.Zbukr}' and  \n            Lifnr  eq '${a.Lifnr}' and \n            Gjahr  eq '${a.Gjahr}' and \n            Laufd  eq '${r}' and \n            Laufi  eq '${a.Laufi}' and \n            Belnr  eq '${a.Blnr}' and \n            Vblnr  eq '${a.Vblnr}'&$format=json`;var i=c.getJsonModel(o);let l=i.getProperty("/results");let s=l[0].EDTLHDR.results;let u=l[0].ECABCNV.results;let g=l[0].EDETCNV.results;let p=[];p=p.concat(this.generaRenglonesArchivo(s));p=p.concat(this.generaRenglonesArchivo(u));p=p.concat(this.generaRenglonesArchivo(g));let h=p.join("\n");let d=a.Blnr;sap.ui.core.util.File.save(h,d,"txt","text/plain","utf-8",false)},generaRenglonesArchivo:function(t){let e=[];for(let n=0;n<t.length;n++)e.push(Object.values(t[n]).slice(1).join("\t"));return e},searchDataPartidas:function(){let e=this.getConfigModel().getProperty("/supplierInputKey");let n=new Date;let a="20160219";let r=this.buildSapDate(n);let o=this._document;if(e==null||e==""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/global.supplierSelectError"));return false}if(a==""||r==""){}var i="";var l=this.getOdata(s);let c=`EStmtHdrSet?$expand=Citms,Oitms&$filter= Lifnr eq '${e}' and Datei eq '${a}' and Datef eq '${r}' ${i} &$format=json`;var g=this.getOdataJsonModel(c,l);u=g.getJSON();var p=JSON.parse(u);let h=[...p.results[0].Oitms.results];p.results[0].Detalles={results:[...h]};delete p.results[0].Citms;delete p.results[0].Oitms;var d=$.extend({},p.results[0]);var m=new t;m.setData(d);console.info("agrupando datos",h);let f=[...h];var P=this.groupArrayOfObjects(f,"FechaTesoreria");var b=[];var v=this;var y=0;for(let t in P){console.log("sumando valores");var C=P[t].reduce(function(t,e){var n=e.Bschl==="21"?Number(e.Wrbtr):0;var a=t+n;return v.truncate(a,2)},0);var _=P[t].reduce(function(t,e){var n=e.Bschl!=="21"?Number(e.Wrbtr):0;var a=t+n;return v.truncate(a,2)},0);var D=P[t].reduce(function(t,e){var n=Number(e.Wrbtr);var a=t+n;return v.truncate(a,2)},0);y=y+Math.abs(D);console.log(v.truncate(y,2));b.push({name:t,totalRegs:P[t].length,totalDebit:Math.abs(_),totalCredit:Math.abs(C),cost:Math.abs(D),positions:P[t],costoAcumulado:v.truncate(y,2)})}console.log(b);var M=b.reduce(function(t,e){var n=Number(e.totalRegs);var a=t+n;return v.truncate(a,2)},0);var S=b.reduce(function(t,e){var n=Number(e.totalDebit);var a=t+n;return v.truncate(a,2)},0);var T=b.reduce(function(t,e){var n=Number(e.totalCredit);var a=t+n;return v.truncate(a,2)},0);var E=b.reduce(function(t,e){var n=Number(e.cost);var a=t+n;return v.truncate(a,2)},0);var x=new t({Hierarchy:{movimientos:b,totalR:M,totalD:S,totalC:T,totalCostos:E}});console.log(x);this.getOwnerComponent().setModel(x,"GroupedTotales");this.initTable()},subtractYears:function(t,e=new Date){e.setFullYear(e.getFullYear()-t);return e},groupArrayOfObjects:function(t,e){return t.reduce(function(t,n){(t[n[e]]=t[n[e]]||[]).push(n);return t},{})},initTable:function(){console.log("on init table");var t=this._getInitialPath();this._setAggregation(t);var e=this.byId("breadcrumb");var n=new r({text:"{appTxts>/plan.dateCorte}",press:[t,this.onBreadcrumbPress,this]});e.destroyLinks();e.addLink(n)},_getInitialPath:function(){return[this.sCollection,this.aCrumbs[0]].join("/")},_nextCrumb:function(t){for(var e=0,n=this.aCrumbs.length;e<n;e++){if(this.aCrumbs[e]===t){return this.aCrumbs[e+1]}}},truncate:function(t,e){return Math.trunc(t*Math.pow(10,e))/Math.pow(10,e)},_stripItemBinding:function(t){var e=t.split("/");return e.slice(0,e.length-1).join("/")},_setAggregation:function(t){var e=t.split("/").reverse()[0];if(e===this.aCrumbs[this.aCrumbs.length-1]){this._oTable.setMode("None")}else{this._oTable.setMode("SingleSelectMaster")}console.log("SET agregation spath",t);this._pTemplate.then(function(e){this._oTable.bindAggregation("items",t,e)}.bind(this))},onBreadcrumbPress:function(t,e){var n=t.getSource();var a=this.byId("breadcrumb");var r=a.indexOfLink(n);var o=a.getLinks().slice(r+1);if(o.length){o.forEach(function(t){t.destroy()});this._setAggregation(e)}}})});