sap.ui.define(["demo/controllers/BaseController","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/m/MessageBox","demo/models/formatter"],function(e,t,a,o,i){"use strict";var r=new this.Pedidostemp;var n=new this.Citas1;var s=null;var l={generalData:{cedisType:"",tipoCita:"",totalBultos:"",tarimas:"",tipoUnidad:"",tipoProducto:"",transportista:""},pedidos:[]};var d="ZOSP_CITAS_ADM_SRV";var p="MainSet";var g="ZOSP_DEVO_NC_SRV_01";var u="notCreditSet";var c=null;var h=[];return e.extend("demo.controllers.Quotes.wizards.WQuoteCreate",{formatter:i,setInitialDate(){let e=this.getView().byId("DP1");let t=new Date;t=t.getTime()+1e3*60*60*24*2;e.setDateValue(new Date(t));e.setMinDate(new Date(t));e.fireChange()},createQuote:function(e){if(!this.hasAccess(31)){return}if(this.getConfigModel().getProperty("/supplierInputKey")!=null){this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel,"CitaMainData");this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel([]),"CitaCreationArray");var a=this.getView();var o="demo.views.Quotes.wizards.WQuoteCreate";this.remissionType=e;let i=this;if(!this._pDialog){this._pDialog=t.load({id:a.getId(),name:o,controller:this}).then(function(e){e.attachAfterOpen(this.onDialogAfterOpen,this);a.addDependent(e);return e}.bind(this))}this._pDialog.then(function(e){e.open();i.setInitialDate();if(i.getView().getModel("ModelLectura")!==undefined){var t=i.getView().getModel("ModelLectura").getData();console.log(t);i.getView().byId("sTipoCita").setSelectedKey(t.Tipocita);i.getView().byId("totalpackagesInput").setValue("1");i.getView().byId("platformsInput").setValue("2");i.getView().byId("sTipoUnidad").setSelectedKey(t.Tipounidad);i.getView().byId("carrierInput").setValue("1234");i.getView().byId("DP1").setDateValue(new Date(t.Fechacita));i.getView().byId("sTipoCita").setEditable(false);i.getView().byId("totalpackagesInput").setEditable(false);i.getView().byId("platformsInput").setEditable(false);i.getView().byId("sTipoUnidad").setEditable(false);i.getView().byId("carrierInput").setEditable(false);i.getView().byId("DP1").setEditable(false)}})}else{sap.m.MessageBox.error(this.getView().getModel("appTxts").getProperty("/quotes.messageNoSupplier"))}},onDialogAfterOpen:function(){this._oWizard=this.byId("QuoteCedisWizard");this._oWizard._getProgressNavigator().ontap=function(){};this.handleButtonsVisibility();s=new a(l);this.getView().setModel(s,"TemporalModel");s.setProperty("/generalData/tipoCita",this.getView().byId("sTipoCita").getSelectedKey());s.setProperty("/generalData/tipoUnidad",this.getView().byId("sTipoUnidad").getSelectedKey())},handleButtonsVisibility:function(){var e=this.getView().getModel();var t=e.getProperty("/selectedPayment");switch(this._oWizard.getProgress()){case 1:e.setProperty("/nextButtonVisible",true);e.setProperty("/backButtonVisible",true);e.setProperty("/finishButtonVisible",false);break;case 2:e.setProperty("/nextButtonVisible",false);e.setProperty("/backButtonVisible",true);e.setProperty("/finishButtonVisible",false);break;case 3:e.setProperty("/nextButtonVisible",false);e.setProperty("/backButtonVisible",true);e.setProperty("/finishButtonVisible",true);break;default:break}},onDialogNextButton:function(){this.getView().getModel("TemporalModel").getData().generalData.totalBultos=this.getView().byId("totalpackagesInput").getValue();this.getView().getModel("TemporalModel").getData().generalData.tarimas=this.getView().byId("platformsInput").getValue();this.getView().getModel("TemporalModel").getData().generalData.transportista=this.getView().byId("carrierInput").getValue();console.log(this.getView().getModel("TemporalModel").getData());if(this._oWizard.getProgressStep().getValidated()){console.log(this._oWizard.getProgressStep().sButtonText);if(this._oWizard.getProgressStep().sButtonText==="Paso 2"){let e=this.byId("DP1").getDateValue();this.searchOrders(this.buildSapDate(e))}this._oWizard.nextStep()}this.handleButtonsVisibility()},onDialogBackButton:function(){this._oWizard.previousStep();this.handleButtonsVisibility()},onCloseWizard:function(){this._handleMessageBoxOpen(this.getView().getModel("appTxts").getProperty("/quotes.discardButton"),"warning")},testModelos:function(){console.log(this.getView().getModel("configSite").getData());console.log(this.getView().getModel("TemporalModel").getData());console.log(this.getView().getModel("CitaCreationArray").getData())},async handleWizardSubmit(){sap.m.MessageBox["confirm"](this.getView().getModel("appTxts").getProperty("/quotes.submitAppoinment"),{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:async function(e){if(e===sap.m.MessageBox.Action.YES){this._oWizard.discardProgress(this._oWizard.getSteps()[0]);this.byId("wizardDialog").destroy();this._pDialog=null;this._oWizard=null;let e=this.getOwnerComponent().getModel("CitaCreationArray").getData();var t=this.getView().getModel("configSite").getData();var a=this.getView().getModel("TemporalModel").getData();console.log(this.getView().getModel("TemporalModel").getData());console.log(e);let s={Proveedor:t.supplierInputKey.padStart(10,0),Action:"1",ETCITANUEVA:[{Ebeln:e[0].Ebeln,Ebelp:e[0].Ebelp,Matnr:e[0].Matnr,Citado:e[0].Citado.toLocaleString(),FechaCita:e[0].FechaCita,HoraIni:e[0].HoraIni,HoraFin:e[0].HoraFin,Anden:Number(e[0].Citado)+1,TipoCita:a.generalData.tipoCita,Lifnr:"",Bultos:a.generalData.totalBultos,Tarimas:a.generalData.tarimas,TipoUnidad:a.generalData.tipoUnidad,Transportista:a.generalData.transportista},{Ebeln:e[1].Ebeln,Ebelp:e[1].Ebelp,Matnr:e[1].Matnr,Citado:e[1].Citado.toLocaleString(),FechaCita:e[1].FechaCita,HoraIni:e[1].HoraIni,HoraFin:e[1].HoraFin,Anden:Number(e[1].Citado)+1,TipoCita:a.generalData.tipoCita,Lifnr:"",Bultos:a.generalData.totalBultos,Tarimas:a.generalData.tarimas,TipoUnidad:a.generalData.tipoUnidad,Transportista:a.generalData.transportista}],ETRETURN:[]};sap.ui.core.BusyIndicator.show();let l=null;var o=d;var i="/"+p;var r=JSON.stringify(s);var n=this;n._POSToData(o,i,r).then(function(e){sap.ui.core.BusyIndicator.hide();var t=e.d;console.log(e);if(t.Success==="X"){sap.m.MessageBox.success(t.Message)}else{sap.m.MessageBox.error(t.Message)}})}}.bind(this)})},_POSToData:function(e,t,a){var o="/sap/opu/odata/sap/"+e;var i=this;return new Promise(function(e,i){$.ajax({url:o+t,type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",data:a,headers:{"X-Requested-With":"X"},success:function(t){e(t)},error:function(e,t,a){sap.ui.core.BusyIndicator.hide();console.log("error",e);i(new Error(e))}})})},getToken:function(e){var t=null;$.ajax({type:"GET",url:"/sap/opu/odata/sap/model/ZOSP_CITAS_ADM_SRV/MainSet$filter=Fechaini eq '20221101' and Fechafin eq '20221130'",headers:{"X-CSRF-Token":"Fetch"},contentType:"application/json; charset=utf-8",dataType:"json",async:false,success:function(e,a,o){t=o.getResponseHeader("X-CSRF-Token")},error:function(e,a,o){t=e.getResponseHeader("X-CSRF-Token")}});console.log(t);return t},_handleMessageBoxOpen:function(e,t){sap.m.MessageBox[t](e,{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){this._oWizard.discardProgress(this._oWizard.getSteps()[0]);this.byId("wizardDialog").destroy();this._pDialog=null;this._oWizard=null;this.getView().setModel(new a,"tableWizardOrderPosition");this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel,"CitaMainData");this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel([]),"CitaCreationArray");c=null}}.bind(this)})},searchOrders:function(e){let t=[];t.push(this.buildFiltro("IOption",7));t.push(this.buildFiltro("ILifnr",this.getConfigModel().getProperty("/supplierInputKey")));t.push(this.buildFiltro("IKdatb",e));sap.ui.core.BusyIndicator.show();let o=this;this._GetODataV2(g,u,t,["ETOC"],"").then(e=>{o.getOwnerComponent().setModel(new a,"Pedidos");e.data.results[0].ETOC.results.forEach(e=>{e.Selected=false});o.getOwnerComponent().setModel(new a(e.data.results[0]),"Pedidos");sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.error(e)})},getDetailOrder:function(){var e=this;var t=`/Valida_citasSet?$expand=Po_validas&$filter=IOption eq '1' and IEbeln eq '${this._document}'`;this.getView().setModel(new a,"tableWizardPo_validas");n.getJsonModelAsync(t,function(t){console.log(t);var a=t.getProperty("/results/0");console.log(a);if(a.ESuccess=="X"){var o=e.getView().getModel("tableWizardPo_validas");o.setProperty("/Oekponav",a.Po_validas)}else{sap.m.MessageBox.error(a.EMessage)}},function(){sap.m.MessageBox.error("")},this)},onSelectRBOption:function(e){s.setProperty("/generalData/cedisType",e.getParameters().selectedIndex)},onChangeSelectTipoCita:function(e){s.setProperty("/generalData/tipoCita",e.getParameters().selectedItem.getKey());console.info(s);this.getOwnerComponent().getModel("CitaMainData").setProperty("/TipoCita",e.getParameters().selectedItem.getKey())},onChangeSelectTipoUnidad:function(e){s.setProperty("/generalData/tipoUnidad",e.getParameters().selectedItem.getKey());console.info(s)},onSelectProductType:function(e){s.setProperty("/generalData/tipoProducto",e.getParameters().selectedItem.getKey());console.info(s)},selectChange:function(e){console.log(e)},appointmentDateChange(e){let t=e.getSource();let a=t.getDateValue();this.setAppoimentCalendar(a,a);this.getOwnerComponent().getModel("CitaMainData").setProperty("/FechaCita",this.buildSapDate(a))},setAppoimentCalendar(e,t){let a=this.getView().byId("appoinmentPC");e.setHours(8,0);a.setStartDate(e);a.setMinDate(e);a.setMaxDate(t);let o=new Date;o.setHours(10,0)},handleIntervalSelect:function(e){var t=e.getSource(),a=e.getParameter("startDate"),o=e.getParameter("endDate"),i=e.getParameter("row"),r=this.getOwnerComponent().getModel("Platforms"),n=r.getData(),s=-1;for(var l=0;l<n.length;l++){for(var d=0;d<n[l].appointments.length;d++){if(n[l].appointments[d].type==="Type08"){sap.m.MessageBox.warning("Favor Guarde la cita abierta");return}}}let p=a.getHours();a.setHours(p);p++;o.setHours(p);var g=new Date(new Date(a).toISOString().slice(0,10)+" "+n[0].DispIni);var u=new Date(new Date(o).toISOString().slice(0,10)+" "+n[0].DispFin);if(a.toLocaleString("en-GB")>g.toLocaleString("en-GB")&&o.toLocaleString("en-GB").trim()<u.toLocaleString("en-GB")){n[t.indexOfRow(i)].appointments.push({start:a,end:o,title:"Entrega "+a.toISOString().substr(0,10),type:"Type08"});r.setData(n)}else{sap.m.MessageBox.warning("El Horario Seleccionado esta fuera del rango Habilitado")}let c=this.getOwnerComponent().getModel("CitaCreationArray").getData();c.forEach(e=>{e.FechaCita=a.toISOString().substr(0,10);e.HoraIni=a.toTimeString().substr(0,8);e.HoraFin=o.toTimeString().substr(0,8);e.Anden=t.indexOfRow(i)});this.getOwnerComponent().getModel("CitaCreationArray").setData(c)},handleAppointmentSelect:function(e){var t=e.getParameter("appointment"),a,i,r;if(t){a=t.getSelected()?"selected":"deselected";o.show("'"+t.getTitle()+"' "+a+". \n  Cita: "+this.byId("appoinmentPC").getSelectedAppointments().length)}else{i=e.getParameter("appointments");r=i.length+" Appointments selected";o.show(r)}t.setSelected(false)},selectPedido:async function(e){console.log(this.getView().getModel("Pedidos"));let t=e.getSource();let a=e.getParameter("rowContext").getModel().getData();let o=e.getParameter("rowContext").getObject();let i=e.getParameter("rowIndex");let r=t.getSelectedIndices();let n=r.some(e=>e==i);console.log(r);if(r.length==0){c=null}else if(c==null){console.log(c);c=o.Werks;this.fetchConfigCentro(c);this.byId("btnAppoimentNext").setVisible(true);this.byId("btnAppoimentNext").setEnabled(false);this.byId("inputCantidad").setEnabled(true)}else if(c!=o.Werks){sap.m.MessageBox.warning("Todos los pedidos deben pertencer al mismo centro");t.removeSelectionInterval(i,i);return}console.log(a.ETOC.results);a.ETOC.results.forEach(e=>{if(e.Ebeln==o.Ebeln&&e.Ean11==o.Ean11)console.log(n);e.Selected=n});t.setFirstVisibleRow(i+2);await new Promise(e=>setTimeout(e,100));t.setFirstVisibleRow(n?i:0);if(n)this.addToCreationArray(o);else this.dropFromCreationArray(o);let s=this.getOwnerComponent().getModel("CitaCreationArray").getData();let l=this.findMaxDate(s,a);let d=this.byId("DP1").getDateValue();this.setAppoimentCalendar(d,l)},findMaxDate(e,t){let a=[];t.ETOC.results.forEach(t=>{if(e.some(e=>e.Ebeln==t.Ebeln&&e.Matnr==t.Matnr))a.push(t)});let o=new Date;a.forEach(e=>{let t=new Date(e.Kdate);if(o<t)o=t});return o},captureQuntSummon:function(e){let t=e.getSource();t.setValueState(sap.ui.core.ValueState.None);let a=t.data("matnr");let o=t.data("ebeln");let i=Number(t.data("menger"));let r=Number(e.getParameter("value"));if(i<r){t.setValueState(sap.ui.core.ValueState.Error);t.setValueStateText("Debe ser menor a la cantidad por agotar");h.push(t.getId());this.byId("btnAppoimentNext").setEnabled(h.length==0);return}else{let e=h.filter(e=>e!=t.getId());h=e}this.byId("btnAppoimentNext").setEnabled(h.length==0&&r>0);let n=this.getOwnerComponent().getModel("CitaCreationArray").getData();n.forEach(e=>{if(e.Matnr==a&&e.Ebeln==o)e.Citado=r});this.getOwnerComponent().getModel("CitaCreationArray").setData(n)},hasOnlyNumbers:function(){this.byId("btnAppoimentNext").setEnabled(true)},addToCreationArray(e){let t=this.getOwnerComponent().getModel("CitaCreationArray").getData();let a=this.getOwnerComponent().getModel("CitaMainData").getData();let o={Ebeln:e.Ebeln,Ebelp:e.Ebelp,Matnr:e.Matnr,TipoCita:a.TipoCita};t.push(o);this.getOwnerComponent().getModel("CitaCreationArray").setData(t)},dropFromCreationArray(e){let t=this.getOwnerComponent().getModel("CitaCreationArray").getData();let a=t.filter(t=>t.Matnr!=e.Matnr&&t.Ebeln!=e.Ebeln);this.getOwnerComponent().getModel("CitaCreationArray").setData(a)},clearModelsOnFilter(e){this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel([]),"CitaCreationArray");c=null},convertHora:function(e){var t=e;var a="";var o="";var i="";a=t.slice(2,4);o=t.slice(5,7);i=t.slice(8,10);return a+":"+o+":"+i},fetchConfigCentro(e){let t=[];t.push(this.buildFiltro("Action","3"));t.push(this.buildFiltro("Centro",e));sap.ui.core.BusyIndicator.show();let a=this;var o=d;var i=p;var r="ETCONFIG";var n=t;var s="";sap.ui.core.BusyIndicator.show();a._GEToDataV2(o,i,n,r,s).then(function(e){sap.ui.core.BusyIndicator.hide();var t=e.data.results[0].ETCONFIG.results;var o="";var i=[];for(var r=0;r<t.length;r++){t[r].DatoH01=a.convertHora(t[r].DatoH01);t[r].DatoH02=a.convertHora(t[r].DatoH02)}for(var r=0;r<t.length;r++){if(t[r].Func==="ANDENES"){o=Number(t[r].Dato1)}}var n=new Date;n=n.getTime()+1e3*60*60*24*2;n=new Date(n).toISOString().slice(0,10);for(var r=0;r<o-1;r++){var s=r;i.push({name:t[r].Func+"-"+Number(s+1),role:t[r].Func,DispIni:t[r].DatoH01,DispFin:t[r].DatoH02,appointments:[]})}console.log(i);var l=new sap.ui.model.json.JSONModel(i);a.getOwnerComponent().setModel(l,"Platforms");a.GetCitas()})},buildFiltro(e,t){return new sap.ui.model.Filter({path:e,operator:sap.ui.model.FilterOperator.EQ,value1:`${t}`})},GetCitas:function(){let e=this;var t=this.getConfigModel().getProperty("/supplierInputKey");var a=this.getView().byId("quoteFolioIniInput").getValue();var o=this.getView().byId("quoteFolioFinInput").getValue();var i=this.getView().byId("quotedateRange");var r=this.buildSapDate(i.getDateValue());var n=this.buildSapDate(i.getSecondDateValue());let s=[];s.push(new sap.ui.model.Filter({path:"Action",operator:sap.ui.model.FilterOperator.EQ,value1:"1"}));s.push(new sap.ui.model.Filter({path:"Proveedor",operator:sap.ui.model.FilterOperator.EQ,value1:t}));if(a!=null&&a!=""&&o!=null&&o!=""){s.push(new sap.ui.model.Filter({path:"Folioini",operator:sap.ui.model.FilterOperator.EQ,value1:a}));s.push(new sap.ui.model.Filter({path:"Foliofin",operator:sap.ui.model.FilterOperator.EQ,value1:o}))}if(r!=null&&r!=""&&n!=null&&n!=""){s.push(new sap.ui.model.Filter({path:"Fechaini",operator:sap.ui.model.FilterOperator.EQ,value1:r}));s.push(new sap.ui.model.Filter({path:"Fechafin",operator:sap.ui.model.FilterOperator.EQ,value1:n}))}var l="ZOSP_CITAS_ADM_SRV";var d="MainSet";var p="CTCITASCAB";var g=s;var u="";var c=e.getView().getModel("Platforms").getData();sap.ui.core.BusyIndicator.show();e._GEToDataV2(l,d,g,p,u).then(function(t){sap.ui.core.BusyIndicator.hide();console.log(t);var a=t.data.results[0].CTCITASCAB.results;console.log(a);for(var o=0;o<a.length;o++){for(var i=0;i<c.length;i++){if(Number(a[o].Anden)===Number(c[i].name.split("-")[1].trim())){c[i].appointments.push({start:new Date(a[o].Fechacita+" "+a[o].HoraIni),end:new Date(a[o].Fechacita+" "+a[o].HoraFin),title:"Descarga  ",type:"Type02",pic:"",tentative:false})}}}var r=new sap.ui.model.json.JSONModel(c);e.getOwnerComponent().setModel(r,"Platforms")})}})});