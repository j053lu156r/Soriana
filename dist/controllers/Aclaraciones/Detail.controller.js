sap.ui.define(["sap/ui/model/json/JSONModel","demo/controllers/BaseController","sap/ui/core/mvc/Controller"],function(e,t){"use strict";var a="/sap/opu/odata/sap/ZOSP_ACLARA_SRV/";return t.extend("demo.controllers.Aclaraciones.Detail",{onInit:function(){var e=this.getView().byId("exitFullScreenBtn"),t=this.getView().byId("enterFullScreenBtn");this._uploadDialog=sap.ui.xmlfragment("uploadFilesFragment","demo.views.Aclaraciones.fragments.UploadAttachmentFiles",this);this.getView().addDependent(this._uploadDialog);this.configUploadSet(this.getView().byId("attachmentDocuments"));var a=this.getView().byId("attachmentDocuments");a.attachAfterItemRemoved(this.onDeleteAttach.bind(this));a.attachAfterItemAdded(this.addAttach.bind(this));this.clearFields();this.oRouter=this.getOwnerComponent().getRouter();this.oModel=this.getOwnerComponent().getModel();this.oRouter.getRoute("detailAclaracion").attachPatternMatched(this._onDocumentMatched,this);let s=sap.ui.getCore().getModel("catalogos_base").getProperty("/sizeFilesUpload");if(!isNaN(parseInt(s,10))&&parseInt(s,10)>0)a.setMaxFileSize(parseFloat(s));[e,t].forEach(function(e){e.addEventDelegate({onAfterRendering:function(){if(this.bFocusFullScreenButton){this.bFocusFullScreenButton=false;e.focus()}}.bind(this)})},this)},Formato:function(e){const t=Number(e);const a=t.toLocaleString("en");if(this.modo=="new"){this.getView().byId("reclaimedImport").setEditable(true);this.getView().byId("reclaimedImport").setEnabled(true)}return a},addAttach:function(t){var a=this;var s=t.getParameter("item");var i=s.getFileObject();var l=a.getOwnerComponent().getModel("nRelease");if(l!=null){var o={};o.Zdoctype=i.name;var r=new FileReader;r.onload=function(t){o.Zdocvalue64=t.target.result;let i={attach:a.getOwnerComponent().getModel("nRelease").getProperty("/attach")==null?[]:a.getOwnerComponent().getModel("nRelease").getProperty("/attach")};i.attach.push(o);a.getOwnerComponent().setModel(new e(i),"nRelease");s.setUploadState(sap.m.UploadState.Complete)};r.readAsDataURL(i)}else{var o={};o.Zdoctype=i.name;var r=new FileReader;r.onload=function(t){o.Zdocvalue64=t.target.result;let a=l.getProperty("/attach").push(o);this.getOwnerComponent().setModel(new e(a),"nRelease");s.setUploadState(sap.m.UploadState.Complete)};r.readAsDataURL(i)}s.setUploadState(sap.m.UploadState.Complete)},onDeleteAttach:function(t){let a=this;var s=t.getParameter("item");var i=s.getFileObject();let l=this.getOwnerComponent().getModel("nRelease").getProperty("/attach");for(let e=0;e<l.length;e++){const t=l[e];if(i.name===t.Zdoctype){l.splice(e,1);break}}let o={attach:[...l]};this.getOwnerComponent().setModel(new e(o),"nRelease")},guardaAclara:function(){var e=this.getView().getModel("Aclaracion").getData();if(this.validaCampos()===false){return false}console.log(e.Obsgen2);if(e.Obsgen2!==undefined){if(this.getView().byId("comments").getValue()!==e.Obsgen2){if(!this.getView().byId("comments").getValue().includes(e.Obsgen2)){var t=e.Obsgen2+"\n "+e.Obsgen}else{var t=e.Obsgen}if(t.includes("undefined")){const e=/undefined/i;t.replace(e,"");console.log(t)}e.Obsgen=t}}else{var t=this.getView().byId("comments").getValue();e.Obsgen=t}console.log(e);if(this.getView().byId("comments").getValue()===""||this.getView().byId("comments").getValue()===undefined||this.getView().byId("comments").getValue()===null){sap.m.MessageBox.warning(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.Errorcoment"));return false}let a=this.getView().byId("clarificationType");let s=this.getView().byId("invoice").getValue().trim();let i=this.getView().byId("sourceDocument").getValue().trim();let l=this.getView().byId("reclaimedImport").getValue();let o=e.Obsgen;let r=parseInt(this._document,10)==0?"":this._document;let n=this.getView().byId("status").getSelectedKey();let c=a.getSelectedKey();let u=this.getConfigModel().getProperty("/supplierInputKey");let d=this.getView().byId("analyst").getSelectedKey();let g=this.getView().byId("distributionCenter").getValue();let p=this.getView().byId("receipt").getValue();let h=this.getView().byId("Gjahr").getValue();let m=this.getView().byId("clarifiedAmount").getValue();if(u==null&&this.getView().byId("supplierInput").getValue().trim()!="")u=this.getView().byId("supplierInput").getValue().trim().split(" ")[0];var b=this.getOwnerComponent().getModel("nRelease").getProperty("/attach")==null?[]:this.getOwnerComponent().getModel("nRelease").getProperty("/attach");var V=[];if(r!=""){V={IOption:r!=""?"2":"12",ILifnr:u,IFactura:s,ICendis:g,ITacla:c,IMonrec:l.replace(/\,/g,""),IMonacl:m.replace(/\,/g,""),IObsgen:o,INoDoc:"",IDocori:i,IAnalista:d,IStatus:n,IRecibo:p,IGjahr:h,ZFile:b}}else{V={IOption:r!=""?"2":"12",ILifnr:u,IFactura:s,ICendis:g,ITacla:c,IMonrec:l.replace(/\,/g,""),IObsgen:o,INoDoc:"",IDocori:i,IAnalista:d,IStatus:n,IRecibo:p,IGjahr:h,ZFile:b}}if(r!=""){V["IFolio"]=r;if(String(V.INoDoc).trim()!=""){V["IMonacl"]=this.getView().byId("clarifiedAmount").getValue().trim();V["IIvaacl"]=this.getView().byId("clarifiedTax").getValue().trim();let e=this.getView().byId("expirationDate").getDateValue();V["IFecven"]=e.getFullYear()+"-"+String("0"+(e.getMonth()+1)).substr(-2)+"-"+String("0"+e.getDate()).substr(-2)}}console.log(JSON.stringify(V));var y="ZOSP_ACLARA_SRV";var f="/EAclaHdrSet";var I=JSON.stringify(V);var w=this;w._POSToDataV2(y,f,I).then(function(e){sap.ui.core.BusyIndicator.hide();console.log(JSON.stringify(V));var t=e.d;if(t!=null){if(t.ESuccess=="X"){let e=r!=""?w.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.msgUpdated"):w.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.msgSaved")+" "+t.IFolio;sap.m.MessageBox.success(e,{actions:[sap.m.MessageBox.Action.CLOSE],emphasizedAction:sap.m.MessageBox.Action.CLOSE,onClose:function(e){w.goToMainReleases()}})}else{sap.m.MessageBox.error(t.EMessage)}}else{sap.m.MessageBox.error("No se pudo conectar con el servidor, intente nuevamente.")}})},goToMainReleases:function(){this.handleClose()},clearFields:function(){this.getView().byId("clarificationType").setEnabled(true).setEditable(true);this.getView().byId("sourceDocument").setEnabled(true).setEditable(true);this.getView().byId("invoice").setEnabled(true).setEditable(true);this.getView().byId("comments").setEnabled(true).setEditable(true);this.getView().byId("analyst").setEnabled(true).setEditable(true);this.getView().byId("validateSourceDocument").setEnabled(true);this.getView().byId("validateInvoice").setEnabled(true);this.getView().byId("distributionCenterDescription").setEnabled(true).setVisible(true);this.getView().byId("receipt").setEnabled(true).setVisible(true).setEditable(true);this.getView().byId("btnGuardar").setEnabled(true).setVisible(true);this.getView().byId("helpDocsList").destroyItems();this.getView().byId("attachmentDocuments").setUploadEnabled(true);this.getView().byId("attachmentDocuments").removeAllItems();this.getView().byId("attachmentDocuments").removeAllIncompleteItems();this.getView().byId("attachmentDocuments").destroyItems();this.getView().byId("attachmentDocuments").destroyIncompleteItems();this.getOwnerComponent().setModel(new e,"nRelease");if(sap.ui.getCore().getModel("catalogos_base")==undefined)this.getCatalogoEstatus();let t=JSON.parse(sap.ui.getCore().getModel("catalogos_base").getJSON()).Estatus;for(let e=0;e<t.results.length;e++){const a=t.results[e];let s=this.getView().byId("status").getItemByKey(a.Status);if(s!==null)s.setEnabled(true)}let a={Folio:"",Estatus:t.results[0].Status,descripcionEstatus:t.results[0].Descripcion,FAlta:new Date,FVenc:"",TipAcla:"",DocOrig:"",MonRec:"",Factura:"",IvaRec:"",Tienda:"",Obsgen:"",MonAcla:"",IvaAcla:"",Analista:"",Butxt:"",NoDoc:"",Gjahr:"",Recibo:""};let s={ZtaclaraDo:{results:[]}};this.getOwnerComponent().setModel(new e(a),"Aclaracion");this.getOwnerComponent().setModel(new e(s),"Documentos");this.paginate("Documentos","/ZtaclaraDo",1,0);let i=this.getView().getControlsByFieldGroupId("aclaracion");for(let e=0;e<i.length;e++){const t=i[e]}this.getView().byId("dateCreation").setDateValue(new Date);this.getView().byId("expirationDate").setDateValue(null)},getCatalogoEstatus:function(){let t=`EAclaHdrSet?$expand=ZtaclaraSt,ZtaclaraTa&$filter=IOption eq '7'&$format=json`;let s=this.getOdata(a);let i=this.getOdataJsonModel(t,s);let l=i.getJSON();let o=JSON.parse(l);let r={Estatus:{results:[...o.results[0].ZtaclaraSt.results]}};sap.ui.getCore().setModel(new e(JSON.parse(JSON.stringify(r))),"catalogos_base")},setData:function(e){let t=JSON.parse(sap.ui.getCore().getModel("catalogos_base").getJSON()).Estatus;for(let a=0;a<t.results.length;a++){const s=t.results[a];if(s.Status==e.Estatus){e.descripcionEstatus=s.Descripcion;break}}let a=e.FAlta instanceof Date?e.FAlta:new Date(e.FAlta+"T00:00:00");let s=e.FVenc==""||e.FVenc=="0000-00-00"?"":new Date(e.FVenc+"T00:00:00");this.getView().byId("dateCreation").setDateValue(a);this.getView().byId("expirationDate").setDateValue(s);this.getView().byId("clarificationType").setSelectedKey(e.TipAcla);this.getView().byId("sourceDocument").setValue(e.DocOrig);this.getView().byId("reclaimedImport").setValue(e.MonRec);this.getView().byId("invoice").setValue(e.Factura);this.getView().byId("distributionCenter").setValue(e.Tienda);this.getView().byId("comments").setValue(e.Obsgen);this.getView().byId("status").setValue(e.Estatus);this.getView().byId("clarifiedAmount").setValue(e.MonAcla);this.getView().byId("clarifiedTax").setValue(e.IvaAcla);this.getView().byId("statusDescription").setValue(e.descripcionEstatus);this.getView().byId("analyst").setSelectedKey(e.Analista)},validaCampos:function(){let e=true;if(this.getView().byId("supplierInput").getValue()==undefined||this.getView().byId("supplierInput").getValue()==""){sap.m.MessageBox.warning(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.noSupplier"));return false}let t=this.getView().getControlsByFieldGroupId("aclaracion");for(let e=0;e<t.length;e++){const a=t[e];if(typeof a.setValueState=="function"&&a.getValueState()===sap.ui.core.ValueState.Error)a.setValueState(sap.ui.core.ValueState.None)}if(this.getView().byId("sourceDocument").getValue().trim()==""&&this.getView().byId("invoice").getValue().trim()==""){e=false;this.getView().byId("sourceDocument").setValueState(sap.ui.core.ValueState.Error);this.getView().byId("invoice").setValueState(sap.ui.core.ValueState.Error)}if(this.getView().byId("sourceDocument").getValueState()!==sap.ui.core.ValueState.Success||this.getView().byId("invoice").getValueState()!==sap.ui.core.ValueState.Success){e=false}if(this.getView().byId("dateCreation").getDateValue()==null){e=false;this.getView().byId("dateCreation").setValueState(sap.ui.core.ValueState.Error)}if(this.getView().byId("status").getValue()==""){e=false;this.getView().byId("status").setValueState(sap.ui.core.ValueState.Error)}if(this.getView().byId("receipt").getValue()==""&&this.getView().byId("clarificationType").getSelectedKey()==="PF"){e=false;this.getView().byId("receipt").setValueState(sap.ui.core.ValueState.Error)}let a=this.getView().byId("clarificationType");if(a.getSelectedKey().trim()==""||a.getValueState()==sap.ui.core.ValueState.Error){e=false;this.getView().byId("clarificationType").setValueState(sap.ui.core.ValueState.Error)}if(this.getView().byId("reclaimedImport").getValue().trim()==""||parseFloat(this.getView().byId("reclaimedImport").getValue())<=0){e=false;this.getView().byId("reclaimedImport").setValueState(sap.ui.core.ValueState.Error)}if(e===false)sap.m.MessageBox.warning(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.msgInvalidFields"));let s=this.getOwnerComponent().getModel("nRelease").getProperty("/attach");if(this.modo=="new"&&(s==null||s==undefined||s.length===0)){sap.m.MessageBox.warning(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.msgNoFileAttach"));e=false}return e},attachmentFiles:function(){if(!this._uploadDialog){this._uploadDialog=sap.ui.xmlfragment("uploadFilesFragment","demo.views.Aclaraciones.fragments.UploadAttachmentFiles",this)}this._uploadDialog.open();this.getView().byId("attachmentDocuments").setUploadEnabled(true)},onCloseDialog:function(){this._uploadDialog.close()},handleItemPress:function(e){var t=this.getOwnerComponent().getHelper().getNextUIState(2),a=e.getSource().getBindingContext("tableItemsCfdi").getPath(),s=a.split("/").slice(-1).pop()},handleFullScreen:function(){this.bFocusFullScreenButton=true;var e=this.oModel.getProperty("/actionButtonsInfo/midColumn/fullScreen");this.oRouter.navTo("detailAclaracion",{layout:e,document:this._document,modo:this.modo,tipo:this.tipo})},handleExitFullScreen:function(){this.bFocusFullScreenButton=true;var e=this.oModel.getProperty("/actionButtonsInfo/midColumn/exitFullScreen");this.oRouter.navTo("detailAclaracion",{layout:e,document:this._document,modo:this.modo,tipo:this.tipo})},handleClose:function(){var e=this.oModel.getProperty("/actionButtonsInfo/midColumn/closeColumn");this.oRouter.navTo("Aclaraciones",{layout:e});this.clearFields()},_onDocumentMatched:function(t){this._document=t.getParameter("arguments").document||this._document||"0";this.modo=t.getParameter("arguments").modo||this.modo||"";this.tipo=t.getParameter("arguments").tipo||this.tipo||"";if(parseInt(this._document,10)>0){let t=this.getConfigModel().getProperty("/supplierInputKey")!=undefined?this.getConfigModel().getProperty("/supplierInputKey"):"";let i=`IOption eq '13' and IFolio eq '${this._document}' and ILifnr eq '${t}' and ITacla eq '${this.tipo}'`;let l=`EAclaHdrSet?$expand=ZtaclaraFo,ZtaclaraFd,ZtaclaraDo,ZtaclaraAa&$filter=${i}&$format=json`;let o=this.getOdata(a);let r=this.getOdataJsonModel(l,o);let n=r.getJSON();let c=JSON.parse(n);let u=JSON.parse(sap.ui.getCore().getModel("catalogos_base").getJSON()).Estatus;this.getOwnerComponent().getModel("catalogos").setProperty("/Analistas",{results:[...c.results[0].ZtaclaraAa.results]});console.log(this.getOwnerComponent().getModel("catalogos"));var s=c.results[0].ZtaclaraFo.results[0];for(let e=0;e<u.results.length;e++){const t=u.results[e];if(t.Status==s.Estatus){s.descripcionEstatus=t.Descripcion;break}}s.distributionCenterDescription=c.results[0].ZtaclaraFd.results[0].Butxt;let d={ZtaclaraDo:{results:[...c.results[0].ZtaclaraDo.results]}};s.modo=this.modo;s.MonRec=this.Formato(s.MonRec);console.log(s);this.getView().byId("dateCreation").setEnabled(true);this.getView().byId("supplierInput").setEnabled(true);this.getView().byId("clarificationType").setEnabled(true);this.getView().byId("distributionCenter").setEnabled(true);this.getView().byId("distributionCenterDescription").setEnabled(true);this.getView().byId("status").setEnabled(true);this.getView().byId("analyst").setEnabled(true);this.getView().byId("sourceDocument").setEnabled(true);this.getView().byId("invoice").setEnabled(true);this.getView().byId("receipt").setEnabled(true);this.getView().byId("reclaimedImport").setEnabled(true);this.getView().byId("clarifiedAmount").setEnabled(true);this.getView().byId("clarifiedTax").setEnabled(true);this.getView().byId("expirationDate").setEnabled(true);this.getView().byId("comments").setEnabled(true);this.getView().byId("dateCreation").setDateValue(new Date(s.FAlta+"T00:00:00"));if(s.FVenc!="")this.getView().byId("expirationDate").setDateValue(new Date(s.FVenc+"T00:00:00"));this.getOwnerComponent().setModel(new e(s),"Aclaracion");this.getView().byId("supplierInput").setValue(s.Lifnr+" - "+s.Supplier);this.getOwnerComponent().setModel(new e(d),"Documentos");this.paginate("Documentos","/ZtaclaraDo",1,0);if(this.modo=="edit"){this.getView().byId("sourceDocument").setValueState(sap.ui.core.ValueState.Success);this.getView().byId("invoice").setValueState(sap.ui.core.ValueState.Success)}this.bloquearCampos(this.modo,s.Estatus)}else this.clearFields()},ValidarValor:function(){var e=this;var t=this.getView().getModel("Aclaracion").getData();console.log(t);var a=Number(t.MonAcla.replace(",",""));var s=Number(t.MonRec.replace(",",""));if(a>s){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.validacionNum"));this.getView().byId("clarifiedAmount").setValue()}else{var i,l;l=t.MonAcla.split(".")[0];var o=t.MonAcla.split(".")[1];console.warn(l,o);i=/(\.\d+)|\B(?=(\d{3})+(?!\d))/g;l=l.toString().replace(i,",");if(o!==undefined){l=l+"."+o}this.getView().byId("clarifiedAmount").setValue(l)}},bloquearCampos:function(t,a){var s=this.getView().getModel("Aclaracion").getData();let i=this.getView().getControlsByFieldGroupId("aclaracion");for(let e=0;e<i.length;e++){const t=i[e];if(typeof t.setEditable=="function"&&(!t.sId.includes("clarifiedAmount")&&s.descripcionEstatus!=="CONCLUIDA"))t.setEditable(false).setEnabled(false);else if(typeof t.setEnabled=="function"&&(!t.sId.includes("clarifiedAmount")&&s.descripcionEstatus!=="CONCLUIDA"))t.setEnabled(false);else if(typeof t.setUploadEnabled=="function"&&(!t.sId.includes("clarifiedAmount")&&s.descripcionEstatus!=="CONCLUIDA"))t.setUploadEnabled(false)}console.log(t);if(t==="edit"){console.log(s);s.Obsgen2=s.Obsgen;switch(a){case"B":this.getView().byId("status").setEnabled(true);this.getView().byId("status").setEditable(true);this.getView().byId("clarificationType").setEnabled(true).setEditable(true);this.getView().byId("analyst").setEnabled(true).setEditable(true);break;case"C":let e=this.getView().byId("status");e.setEnabled(true).setEditable(true);this.getView().byId("comments").setEnabled(true).setEditable(true);e.getItemByKey("A").setEnabled(false);e.getItemByKey("B").setEnabled(false);break;case"D":this.getView().byId("comments").setEnabled(true).setEditable(true);this.getView().byId("status").setEnabled(true);this.getView().byId("status").setEditable(true);e.getItemByKey("A").setEnabled(false);e.getItemByKey("B").setEnabled(false);break;case"E":this.getView().byId("status").setEnabled(true).setEditable(true);this.getView().byId("comments").setEnabled(true).setEditable(true);this.getView().byId("clarificationType").setEnabled(true).setEditable(true);this.getView().byId("analyst").setEnabled(true).setEditable(true);e.getItemByKey("A").setEnabled(false);e.getItemByKey("B").setEnabled(false);e.getItemByKey("C").setEnabled(false);e.getItemByKey("D").setEnabled(false);break;case"G":this.getView().byId("status").setEnabled(true).setEditable(true);this.CambioStatus();this.getView().byId("comments").setEnabled(true).setEditable(true);e.getItemByKey("A").setEnabled(false);e.getItemByKey("B").setEnabled(false);e.getItemByKey("C").setEnabled(false);break;case"H":default:sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.noEditMsg"));this.handleClose();return false}}else{console.log(this.getView().getModel("Aclaracion"));var l=this.getView().getModel("Aclaracion").getData().TipAcla;var o=this.getView().getModel("catalogos").getData().Tipos.results;var r=this.getView().getModel("catalogos").getData().Analistas.results;var n=this.getView().getModel("Aclaracion").getData().Analista;var c=[];for(var u=0;u<o.length;u++){if(o[u].TipAcla===l){c.push(o[u])}}this.getOwnerComponent().setModel(new e(c),"TipoAclara");console.log(this.getView().getModel("TipoAclara"));var d=[];for(var u=0;u<r.length;u++){if(r[u].TipAcla===n){d.push(r[u])}}console.log(d);if(d.length===0){this.getView().byId("analyst").setSelectedKey(n);this.getView().byId("analyst").setValue(n)}this.getView().byId("dateCreation").setEnabled(false);this.getView().byId("supplierInput").setEnabled(false);this.getView().byId("clarificationType").setEnabled(false);this.getView().byId("distributionCenter").setEnabled(false);this.getView().byId("distributionCenterDescription").setEnabled(false);this.getView().byId("status").setEnabled(false);this.getView().byId("analyst").setEnabled(false);this.getView().byId("sourceDocument").setEnabled(false);this.getView().byId("invoice").setEnabled(false);this.getView().byId("receipt").setEnabled(false);this.getView().byId("reclaimedImport").setEnabled(false);this.getView().byId("clarifiedAmount").setEnabled(false);this.getView().byId("clarifiedTax").setEnabled(false);this.getView().byId("expirationDate").setEnabled(false);this.getView().byId("comments").setEnabled(false);this.getView().byId("btnGuardar").setEnabled(false).setVisible(false);console.log(s);s.Obsgen2=s.Obsgen}},CambioStatus:function(){var e=this;if(e.getView().byId("status").getSelectedKey()==="G"){e.getView().byId("analyst").setEnabled(true);e.getView().byId("analyst").setEditable(true)}else{e.getView().byId("analyst").setEnabled(false);e.getView().byId("analyst").setEditable(false)}},validateSourceDocument:function(t){let s=this.getView().byId("sourceDocument");if(s.getValue().trim()==""){sap.m.MessageBox.alert(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.sourceDocumentMsg"));return false}let i=s.getValue().trim();let l=this.getConfigModel().getProperty("/supplierInputKey")!=undefined?this.getConfigModel().getProperty("/supplierInputKey"):"";let o=`EAclaHdrSet?$expand=ZDocOri&$filter=IOption eq '9' and IDocori eq '${i}' and ILifnr eq '${l}'&$format=json`;let r=this.getOdata(a);let n=this.getOdataJsonModel(o,r);let c=n.getJSON();let u=JSON.parse(c);if(u.results[0].EExistea=="X"){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.msgDuplicated"));s.setValueState(sap.ui.core.ValueState.Error);return false}if(u.results[0].EError!==""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.sourceDocumentMsgNoMatches"));s.setValueState(sap.ui.core.ValueState.Error);return false}var d=u.results[0].ZDocOri.results[0].Descripcion.split(" ")[0];console.log(d);var g=this.getView().getModel("catalogos").getData().Tipos.results;console.log(g);var p=[];if(d==="RE"){for(var h=0;h<g.length;h++){if(g[h].TipAcla==="CD"||g[h].TipAcla==="FI"||g[h].TipAcla==="PF"){p.push(g[h])}}}if(d==="KR"){for(var h=0;h<g.length;h++){if(g[h].TipAcla==="CD"||g[h].TipAcla==="FI"||g[h].TipAcla==="PF"){p.push(g[h])}}}if(d==="KG"){for(var h=0;h<g.length;h++){if(g[h].TipAcla==="DF"){p.push(g[h])}}}if(d==="KD"){for(var h=0;h<g.length;h++){if(g[h].TipAcla==="AP"||g[h].TipAcla==="DC"||g[h].TipAcla==="FC"||g[h].TipAcla==="NS"){p.push(g[h])}}}if(d==="RA"){for(var h=0;h<g.length;h++){if(g[h].TipAcla==="CC"||g[h].TipAcla==="DC"||g[h].TipAcla==="FC"||g[h].TipAcla==="UP"){p.push(g[h])}}}this.getOwnerComponent().setModel(new e(p),"TipoAclara");let m=this.Formato(u.results[0].ZDocOri.results[0].Monrec);let b=u.results[0].ZDocOri.results[0].Ivarec;let V=u.results[0].ZDocOri.results[0].Xblnr;let y=u.results[0].ZDocOri.results[0].Werks;let f=u.results[0].ZDocOri.results[0].Descripcion.slice(2);let I=u.results[0].ZDocOri.results[0].Gjahr;let w=u.results[0].ZDocOri.results[0].Recibo;s.setValueState(sap.ui.core.ValueState.Success);this.getView().byId("reclaimedImport").setValue(m);this.getView().byId("invoice").setValue(V).setValueState(sap.ui.core.ValueState.Success);this.getView().byId("distributionCenter").setValue(y).setValueState(sap.ui.core.ValueState.Success);this.getView().byId("distributionCenterDescription").setValue(f).setValueState(sap.ui.core.ValueState.Success);this.getView().byId("Gjahr").setValue(I);this.getView().byId("receipt").setValue(w)},validateInvoice:function(t){let s=this.getView().byId("invoice");if(s.getValue().trim()==""){sap.m.MessageBox.alert(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.invoiceMsg"));return false}let i=s.getValue().trim();let l=this.getConfigModel().getProperty("/supplierInputKey")!=undefined?this.getConfigModel().getProperty("/supplierInputKey"):"";let o=`EAclaHdrSet?$expand=ZRefFac&$filter=IOption eq '6' and IFactura eq '${i}' and ILifnr eq '${l}'&$format=json`;let r=this.getOdata(a);let n=this.getOdataJsonModel(o,r);let c=n.getJSON();let u=JSON.parse(c);if(u.results[0].ZRefFac.results.length===0){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.invoiceMsgNoMatches"));s.setValueState(sap.ui.core.ValueState.Error);return false}var d=u.results[0].ZRefFac.results[0].Descripcion.split(" ")[0];var g=this.getView().getModel("catalogos").getData().Tipos.results;var p=[];if(d==="RE"){for(var h=0;h<g.length;h++){if(g[h].TipAcla==="CD"||g[h].TipAcla==="FI"||g[h].TipAcla==="PF"){p.push(g[h])}}}if(d==="KR"){for(var h=0;h<g.length;h++){if(g[h].TipAcla==="CD"||g[h].TipAcla==="FI"||g[h].TipAcla==="PF"){p.push(g[h])}}}if(d==="KD"){for(var h=0;h<g.length;h++){if(g[h].TipAcla==="AP"||g[h].TipAcla==="DC"||g[h].TipAcla==="FC"||g[h].TipAcla==="NS"){p.push(g[h])}}}if(d==="RA"){for(var h=0;h<g.length;h++){if(g[h].TipAcla==="CC"||g[h].TipAcla==="DC"||g[h].TipAcla==="FC"||g[h].TipAcla==="UP"){p.push(g[h])}}}if(d==="KE"){for(var h=0;h<g.length;h++){if(g[h].TipAcla==="PF"){p.push(g[h])}}}this.getOwnerComponent().setModel(new e(p),"TipoAclara");let m=this.Formato(u.results[0].ZRefFac.results[0].Monrec);let b=u.results[0].ZRefFac.results[0].Ivarec;let V=u.results[0].ZRefFac.results[0].Belnr;let y=u.results[0].ZRefFac.results[0].Werks;let f=u.results[0].ZRefFac.results[0].Descripcion.slice(2);let I=u.results[0].ZRefFac.results[0].Gjahr;let w=u.results[0].ZRefFac.results[0].Recibo;s.setValueState(sap.ui.core.ValueState.Success);this.getView().byId("reclaimedImport").setValue(m);this.getView().byId("sourceDocument").setValue(V).setValueState(sap.ui.core.ValueState.Success);this.getView().byId("distributionCenter").setValue(y).setValueState(sap.ui.core.ValueState.Success);this.getView().byId("distributionCenterDescription").setValue(f).setValueState(sap.ui.core.ValueState.Success);this.getView().byId("Gjahr").setValue(I);this.getView().byId("receipt").setValue(w)},loadAnalyst:function(e){let t=e.getParameters().selectedItem.getKey();let s=`IOption eq '16' and ITacla eq '${t}'`;let i=`EAclaHdrSet?$expand=ZtaclaraAa&$filter=${s}&$format=json`;let l=this.getOdata(a);let o=this.getOdataJsonModel(i,l);let r=o.getProperty("/results/0");this.getOwnerComponent().getModel("catalogos").setProperty("/Analistas",{results:[...r.ZtaclaraAa.results]})},downloadDocument:function(e,t){let a=new Aclaraciones;var s=a.getJsonModel(`/EAclaHdrSet?$expand=ZtaclaraDo&$filter=IOption eq '15' and IFolio eq '${e}' and IDoctype eq'${t}'&$format=json`);if(s!=null){var i=s.getProperty("/results/0");if(i.ZtaclaraDo.results.length>0){let e=String(i.ZtaclaraDo.results[0].Zdocvalue64).split(";")[0].split(":")[1];this.downloadAttach(i.ZtaclaraDo.results[0].Zdocvalue64,e)}else{sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.msgNoFile"))}}},deleteDocument:function(e,t){let a=new Aclaraciones;var s=a.getJsonModel(`/EAclaHdrSet?$expand=ZtaclaraDo&$filter=IOption eq '14' and IFolio eq '${e}' and IDoctype eq'${t}'&$format=json`);if(s!=null){var i=s.getProperty("/results/0");if(i.ESuccess=="X"){let e=this.getOwnerComponent().getModel("Documentos").getProperty("/ZtaclaraDo/Paginated/results");for(let a=0;a<e.length;a++){const s=e[a];if(s.Zdoctype===t){this.getView().byId("helpDocsList").removeItem(a);break}}sap.m.MessageBox.success(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.msgFileDeleted"))}else{sap.m.MessageBox.error(i.EError)}}},downloadAttach:function(e,t){switch(t){case"application/pdf":this.pdfView(e,t);break;default:var a=this.buildBlobUrl(e,t);sap.m.URLHelper.redirect(a,true);break}},pdfView:function(e,t){var a=this.buildBlobUrl(e,t);if(!this._PDFViewer){this.createPDFView(a)}else{if(this._PDFViewer.getSource()!==a){this._PDFViewer=null}this.createPDFView(a)}this._PDFViewer.open()},createPDFView:function(e){this._PDFViewer=new sap.m.PDFViewer({width:"auto",source:e});jQuery.sap.addUrlWhitelist("blob")},buildExcel:function(){var e=this.getOwnerComponent().getModel("appTxts");let t=this.getOwnerComponent().getModel("tableDetailMoves");var a=[{name:e.getProperty("/sendInv.recepNumberUPC"),template:{content:t.getProperty("/EDOCHDRNAV/results/0/Xblnr")}},{name:e.getProperty("/sendInv.documentUPC"),template:{content:t.getProperty("/EDOCHDRNAV/results/0/Belnr")+" - "+t.getProperty("/EDOCHDRNAV/results/0/Gjahr")}},{name:e.getProperty("/sendInv.purchaseOrderUPC"),template:{content:t.getProperty("/EDOCHDRNAV/results/0/Ebeln")}},{name:e.getProperty("/sendInv.amountUPC"),template:{content:t.getProperty("/EDOCHDRNAV/results/0/Dmbtr")}},{name:e.getProperty("/sendInv.referenceUPC"),template:{content:t.getProperty("/EDOCHDRNAV/results/0/Bktxt")}},{name:e.getProperty("/sendInv.dateUPC"),template:{content:t.getProperty("/EDOCHDRNAV/results/0/Budat")}},{name:e.getProperty("/sendInv.taxUPC"),template:{content:t.getProperty("/EDOCHDRNAV/results/0/Impuesto")}},{name:e.getProperty("/sendInv.vendorUPC"),template:{content:t.getProperty("/EDOCHDRNAV/results/0/Sociedad")}},{name:e.getProperty("/sendInv.branchUPC"),template:{content:t.getProperty("/EDOCHDRNAV/results/0/Werks")}},{name:e.getProperty("/sendInv.totalUPC"),template:{content:t.getProperty("/EDOCHDRNAV/results/0/Total")}},{name:e.getProperty("/sendInv.positionUPC"),template:{content:"{Ebelp}"}},{name:e.getProperty("/sendInv.barcodeUPC"),template:{content:"{Ean11}"}},{name:e.getProperty("/sendInv.descriptionUPC"),template:{content:"{Txz01}"}},{name:e.getProperty("/sendInv.qtyUPC"),template:{content:"{Bpmng} {Bprme}"}},{name:e.getProperty("/sendInv.unitPriceUPC"),template:{content:"{Unitp}"}},{name:e.getProperty("/sendInv.positionAmountUPC"),template:{content:"{Dmbtr}"}},{name:e.getProperty("/sendInv.packCapUPC"),template:{content:"{Emp_cap}"}},{name:e.getProperty("/sendInv.storeUPC"),template:{content:"{Werks}-{Centro}"}}];this.exportxls("tableDetailMoves","/EDOCDTLNAV/results",a)}})});