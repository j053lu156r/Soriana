sap.ui.define(["sap/ui/model/json/JSONModel","demo/controllers/BaseController","demo/models/BaseModel","sap/m/Label","sap/m/Link","sap/m/MessageToast","sap/m/Text","sap/ui/core/Fragment"],function(e,t,o,s,i,r,a,n){"use strict";var l="/sap/opu/odata/sap/ZOCP_FACTORAJE_SRV/";var u;var c=new Date;return t.extend("demo.controllers.Factoraje.DetalFactoraje",{sCollection:"GroupedFactoraje>/Hierarchy",aCrumbs:["movimientos","positions"],mInitialOrderState:{products:{},count:0,hasCounts:false},onInit:function(){var t=this.getView().byId("exitFullScreenBtn"),o=this.getView().byId("enterFullScreenBtn");this.oRouter=this.getOwnerComponent().getRouter();this.oModel=this.getOwnerComponent().getModel();this.oRouter.getRoute("detailFactoring").attachPatternMatched(this._onDocumentMatched,this);this.getView().addEventDelegate({onBeforeShow:function(t){this.getOwnerComponent().setModel(new e,"totales");var o=new e({filtros:[{filtro:"belnr",descripcion:"Documento"},{filtro:"xblnr",descripcion:"Factura"},{filtro:"",descripcion:""}]});this.getView().setModel(o,"filterOptions")}},this);if(!this._pTemplate){this._pTemplate=this.loadFragment({id:this.getView().getId(),name:"demo.views.Factoraje.Row"})}this._oTable=this.byId("detailsStatementList")},searchData:function(){var t=sap.ui.core.format.DateFormat.getDateInstance({pattern:"YYYYMMdd"});let o=this.getConfigModel().getProperty("/supplierInputKey");let s=new Date;console.log(this._fecha);let i=this._fecha.replace(/-/g,"");let r=t.format(s);i="-";r="-";let a=this._document;let n=this._ejercicio;if(o==null||o==""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/global.supplierSelectError"));return false}if(i=="-"||r=="-"){}var l=this._sociedad;var u=` and Belnr eq '${a}'`;let c=`EStmtHdrSet?$expand=Citms&$filter= Datei eq '${i}' and Datef eq '${i}'${u} &$format=json`;var d=[];d.push(new sap.ui.model.Filter({path:"Datei",operator:sap.ui.model.FilterOperator.EQ,value1:i}));d.push(new sap.ui.model.Filter({path:"Datef",operator:sap.ui.model.FilterOperator.EQ,value1:r}));var h=`${a}`;var m=`${this._ejercicio}`;var p=`${o}`;d.push(new sap.ui.model.Filter({path:"Belnr",operator:sap.ui.model.FilterOperator.EQ,value1:h}));d.push(new sap.ui.model.Filter({path:"LIFNR",operator:sap.ui.model.FilterOperator.EQ,value1:p}));d.push(new sap.ui.model.Filter({path:"GJAHR",operator:sap.ui.model.FilterOperator.EQ,value1:m}));var g="ZOCP_FACTORAJE_SRV";var b="EStmtHdrSet";var f=["Citms"];var C=d;var v="";sap.ui.core.BusyIndicator.show();let y=this;this._GetODataV2(g,b,C,f,v).then(function(t){sap.ui.core.BusyIndicator.hide();var o=t.data.results;console.log(o);let s=[...o[0].Citms.results];let i=s.find(({ZdocAforo:e})=>e.startsWith("60"));console.log("get aforo",i);if(i){var r={...i};r.DescripcionGpo="RETENCIÓN AFORO";r.IdNumGpo="82";r.DescTipomov="PROTECCIÓN POR FACTORAJE";r.IdNumTipomov="82";r.Belnr=r.ZdocAforo;r.Wrbtr=i.RetencionAforo*-1;s.push(r)}var a=s;var n=a.filter(e=>{if(e.DescripcionGpo===""){e.DescripcionGpo="AJUSTE DE FACTURAS";e.IdNumGpo="9";e.DescTipomov="CARGOS DIVERSOS";e.IdNumTipomov="65"}return true});o[0].Detalles={results:[...n]};var l=$.extend({},o[0]);var u=new e;u.setData(l);let c=[...n];var d=c.reduce(function(e,t){var o=Number(t.Wrbtr);var s=e+o;return s},0);var h=y.groupArrayOfObjects(c,"DescripcionGpo");var m=[];var p=y;for(let e in h){var g=h[e].reduce(function(e,t){var o=Number(t.Wrbtr);var s=e+o;return s},0);m.push({name:e,totalRegs:h[e].length,totalDebit:0,totalCredit:0,cost:p.truncate(g,2),positions:h[e]})}var b=m.reduce(function(e,t){var o=Number(t.totalRegs);var s=e+o;return p.truncate(s,2)},0);var f=1e-5;d=d+f;var C=new e({Hierarchy:{movimientos:m,totalR:b,totalD:0,totalC:0,totalCostos:p.truncate(d,2)}});y.getOwnerComponent().setModel(C,"GroupedFactoraje");y.initTable()})},subtractYears:function(e,t=new Date){t.setFullYear(t.getFullYear()-e);return t},groupArrayOfObjects:function(e,t){return e.reduce(function(e,o){(e[o[t]]=e[o[t]]||[]).push(o);return e},{})},initTable:function(){console.log("on init table");var e=this._getInitialPath();this._setAggregation(e);var t=this.byId("breadcrumb");var o=new i({text:"Conceptos",press:[e,this.onBreadcrumbPress,this]});t.destroyLinks();t.addLink(o)},_getInitialPath:function(){return[this.sCollection,this.aCrumbs[0]].join("/")},_nextCrumb:function(e){for(var t=0,o=this.aCrumbs.length;t<o;t++){if(this.aCrumbs[t]===e){return this.aCrumbs[t+1]}}},truncate:function(e,t){return Math.trunc(e*Math.pow(10,t))/Math.pow(10,t)},_stripItemBinding:function(e){var t=e.split("/");return t.slice(0,t.length-1).join("/")},_setAggregation:function(e){var t=e.split("/").reverse()[0];if(t===this.aCrumbs[this.aCrumbs.length-1]){this.byId("statusColumn").setVisible(false);this.byId("folioColumn").setVisible(true);this.byId("referenceColumn").setVisible(true);this.byId("typeDocColumn").setVisible(true);this.byId("dateColumn").setVisible(false);this.byId("amountColumn").setVisible(true);this.byId("mCondicionColumn").setVisible(false);this.byId("bloqueoColumn").setVisible(false);this.byId("conciliacionColumn").setVisible(false);this.byId("tipoMovColumn").setVisible(true);this.byId("tipoColumn").setVisible(false);this.byId("totalRegColumn").setVisible(false);this.byId("debitColumn").setVisible(false);this.byId("creditColumn").setVisible(false);this.byId("costoColumn").setVisible(false);this.byId("sucursalColumn").setVisible(true);this.byId("folio2Column").setVisible(true)}else{this.byId("statusColumn").setVisible(false);this.byId("folioColumn").setVisible(false);this.byId("referenceColumn").setVisible(false);this.byId("tipoMovColumn").setVisible(false);this.byId("typeDocColumn").setVisible(false);this.byId("dateColumn").setVisible(false);this.byId("amountColumn").setVisible(false);this.byId("mCondicionColumn").setVisible(false);this.byId("bloqueoColumn").setVisible(false);this.byId("conciliacionColumn").setVisible(false);this.byId("tipoColumn").setVisible(true);this.byId("totalRegColumn").setVisible(true);this.byId("debitColumn").setVisible(false);this.byId("creditColumn").setVisible(false);this.byId("costoColumn").setVisible(true);this.byId("sucursalColumn").setVisible(false);this.byId("folio2Column").setVisible(false)}console.log("SET agregation spath",e);this._oTable.bindRows({path:e})},conceptoSelect:function(e){console.log("on condepto select");let t=e.getSource().getBindingContext("GroupedFactoraje").getPath();console.log(t);var o=t.split("/");var s=t.split("/").reverse()[1];var r=o[o.length-2];console.log("current path",r);if(s!==this.aCrumbs[this.aCrumbs.length-1]){var a=this.byId("breadcrumb");var n=o[o.length-2];var l=this.aCrumbs.indexOf(n)+1;console.log("currentNOde",l);var u=new i({text:"{GroupedFactoraje>name}",press:[t+"/"+this.aCrumbs[l],this.onBreadcrumbPress,this]});u.bindElement({path:"GroupedFactoraje>"+t});a.addLink(u)}if(r===this.aCrumbs[this.aCrumbs.length-1]){console.log("on Documento seleccionado....");var c={};console.log("on documnt press",e);console.log(t);let o=this.getOwnerComponent().getModel("GroupedFactoraje").getProperty(t);console.log(o);var d=o.Tcode}else{console.log("on grupo seleccionado seleccionado.....");var h="GroupedFactoraje>";var m=[t,this._nextCrumb(r)].join("/");this._setAggregation(h+m);console.log("new spath",m)}},onBreadcrumbPress:function(e,t){var o=e.getSource();var s=this.byId("breadcrumb");var i=s.indexOfLink(o);var r=s.getLinks().slice(i+1);if(r.length){r.forEach(function(e){e.destroy()});this._setAggregation(t)}},handleFullScreen:function(){var e=this.getOwnerComponent().getHelper().getNextUIState(2);this.bFocusFullScreenButton=true;var t=this.oModel.getProperty("/actionButtonsInfo/midColumn/fullScreen");this.oRouter.navTo("detailFactoring",{layout:t,document:this._document,sociedad:this._sociedad,ejercicio:this._ejercicio,fecha:this._fecha})},handleExitFullScreen:function(){this.bFocusFullScreenButton=true;var e=this.oModel.getProperty("/actionButtonsInfo/midColumn/exitFullScreen");this.oRouter.navTo("detailFactoring",{layout:e,document:this._document,sociedad:this._sociedad,ejercicio:this._ejercicio,fecha:this._fecha})},handleClose:function(){console.log("on hanlde close");var e=this.oModel.getProperty("/actionButtonsInfo/midColumn/closeColumn");this.oRouter.navTo("masterFactoring",{layout:e})},_onDocumentMatched:function(t){this._document=t.getParameter("arguments").document||this._document||"0";this._sociedad=t.getParameter("arguments").sociedad||this._sociedad||"0";this._ejercicio=t.getParameter("arguments").ejercicio||this._ejercicio||"0";this._fecha=t.getParameter("arguments").fecha||this._fecha||"0";console.log(this._document);this.getView().bindElement({path:"/ProductCollection/"+this._document,model:"products"});this.getView().setModel(new e({document:this._document,date:this._fecha}),"detailFactoraje");this.searchData()},onDocumentDevolucionPress:function(e){var t=e.getSource().getBindingContext("GroupedFactoraje").getPath();let o=this.getOwnerComponent().getModel("GroupedFactoraje").getProperty(t);console.log(o);console.log(o.Foliodescuento);console.log(o.Lifnr);console.log(o.Ebeln);this.getOwnerComponent().getRouter().navTo("detailDevoFactoraje",{layout:sap.f.LayoutType.ThreeColumnsEndExpanded,xblnr:o.Folio||0,lifnr:o.Lifnr,ebeln:o.Ebeln||0,suc:o.Sucursal},true)},onDocumentPress:function(e){console.log("on documnt press",e);let t=e.getSource().getBindingContext("GroupedFactoraje").getPath();let o=this.getOwnerComponent().getModel("GroupedFactoraje").getProperty(t);console.log(o);var s=this.getOwnerComponent().getModel("GroupedFactoraje").getProperty("/Bukrs");var i=o.Gjahr;var r=i.substr(0,4)?i.substr(0,4):"";var a=o.Tcode;console.log(s,r,a);var n=o.Belnr;var l=["Z_APORTACIONES"];var u=["ZMM_ACUERDOS_LIQUI"];console.log(a!==""&&a.match("(ZMMFILACUERDO|MEB|WLF).*")&&n.startsWith("51")||a===""&&!n.startsWith("170")&&o.Foliodescuento);if(a!==""&&a.match("(ZMMFILACUERDO|MEB|WLF).*")&&n.startsWith("51")||a===""&&!n.startsWith("170")&&o.Foliodescuento){console.log("on detail factoraje acuerdos",a.match("(ZMMFILACUERDO|MEB|WLF).*"));this.getOwnerComponent().getRouter().navTo("detailAcuerdosFactoraje",{layout:sap.f.LayoutType.ThreeColumnsEndExpanded,document:o.Belnr,sociedad:this._sociedad,ejercicio:i,doc:this._document,fecha:this._fecha},true)}else if(l.includes(a)||n.startsWith("170")&&o.Foliodescuento){console.warn("on detail factoraje aportaciones");this.getOwnerComponent().getRouter().navTo("detailAportacionesFactoraje",{layout:sap.f.LayoutType.ThreeColumnsEndExpanded,document:o.Foliodescuento,sociedad:this._sociedad,ejercicio:i,doc:this._document,fecha:this._fecha},true)}else if(u.includes(a)||a===""){console.log("on boletin vtz");this.getOwnerComponent().getRouter().navTo("BoletinVtaDetailPolizas",{layout:sap.f.LayoutType.ThreeColumnsEndExpanded,document:n,company:s,year:r},false)}}})});