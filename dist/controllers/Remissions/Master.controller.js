sap.ui.define(["jquery.sap.global","demo/controllers/BaseRemission","sap/m/UploadCollectionParameter","sap/ui/core/mvc/Controller","sap/m/PDFViewer","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/ui/core/routing/Router","sap/f/library","sap/m/MessageBox"],function(e,t,r,o,i,a,s,l){"use strict";var n="";var p=new this.EnvioCfdi;var d=new this.AvisoModel;var g=new this.WSModel;var u=new this.Remissions;return t.extend("demo.controllers.Remissions.Master",{onInit:function(){this._pdfViewer=new i;this.getView().addDependent(this._pdfViewer);this.oRouter=this.getOwnerComponent().getRouter();this.getView().addEventDelegate({onAfterShow:function(e){var t=this.getConfigModel();t.setProperty("/barVisible",true);this.getOwnerComponent().setModel(new a,"tableRemissions");this.getConfigModel().setProperty("/updateFormatsSingle","xml,xls,xlsx");this.setCurrentWeek()}},this);this.configFilterLanguage(this.getView().byId("filterBar"));this.inptFolio=this.getView().byId("folio");this.inptFolio2=this.getView().byId("folio2");this.inptOrder=this.getView().byId("order");this.inptOrder2=this.getView().byId("order2");this.cboxTipo=this.getView().byId("cboxTipo");var e=this.getTipoEntrega();var t=new a(e);this.getView().setModel(t,"TipoEntregaModel")},openUploadDialog:function(){if(!this.hasAccess(40)){return false}if(!this._uploadDialog2){this._uploadDialog2=sap.ui.xmlfragment("uploadAviso","demo.views.Remissions.fragments.UploadAviso",this);this.getView().addDependent(this._uploadDialog2)}this._uploadDialog2.open()},onCloseDialogUpload:function(){if(this._uploadDialog2){this._uploadDialog2.destroy();this._uploadDialog2=null}},documentUploadPress:function(){var e=this;var t=sap.ui.core.Fragment.byId("uploadAviso","fileUploaderAviso");var r=sap.ui.core.Fragment.byId("uploadAviso","logUploadListAviso");var o=sap.ui.core.Fragment.byId("uploadAviso","uploadBoxAviso");var i=this.getConfigModel().getProperty("/supplierInputKey");if(!t.getValue()){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/helpDocs.uploader.nodata"));return}if(i==null||i==""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/helpDocs.uploader.noProvider"));return}var s={Lifnr:i,Type:"A",Format:"",Log:[{Uuid:"",Description:"",Sts:""}]};var l=this.byId("complPagoList").getSelectedItems();if(l.length>0){var n=l[0].getBindingContext("tableItemsCfdi").getObject();s.Docmat=n.Mblnr;s.Year=n.Gjahr}var p=t.oFileUpload.files[0];if(p.type!="text/xml"){s.Format="X"}var g=new FileReader;g.onload=function(i){if(p.type=="text/xml"){let t=atob(i.target.result.replace("data:text/xml;base64,",""));var l=new sap.ui.model.xml.XMLModel;l.setXML(t);var n=l.getData();var g=n.getElementsByTagName("cfdi:Comprobante");if(g.length>0){sap.m.MessageBox.error(e.getOwnerComponent().getModel("appTxts").getProperty("/rem.uploader.cfdiError"));return}}if(p.type=="text/xml"){var u=i.target.result.split(",");s.Cfdi=u[1]}else{var m={};var h=i.target.result;var f=XLSX.read(h,{type:"binary"});f.SheetNames.forEach(function(e){var t=XLSX.utils.sheet_to_row_object_array(f.Sheets[e],{raw:false});var r=t;m[e]={columnas:r}});s.Cfdi=JSON.stringify(m)}var c=d.create("/ECfdiSet ",s);if(c!=null){o.setVisible(false);if(c.Log!=null){r.setVisible(true);r.setModel(new a(c))}else{sap.m.MessageBox.error(c.EMessage)}}t.clear()};if(p.type=="text/xml"){g.readAsDataURL(p)}else{g.readAsBinaryString(p)}},searchData:function(){if(!this.hasAccess(5)){return false}var e=sap.ui.core.format.DateFormat.getDateTimeInstance({parent:"yyyyMMdd"});var t=this.getView().byId("dateOrder");var r=this.buildSapDate(t.getDateValue());var o=this.buildSapDate(t.getSecondDateValue());var i=this.getConfigModel().getProperty("/supplierInputKey");var s=this.getView().byId("order").getValue();var l=this.inptOrder2.getValue();var n=this.getView().byId("folio").getValue();var p=this.inptFolio2.getValue();var d=this.cboxTipo.getSelectedKey();var g=false;var u=true;let m=[];m.push(new sap.ui.model.Filter({path:"IOption",operator:sap.ui.model.FilterOperator.EQ,value1:"1"}));m.push(new sap.ui.model.Filter({path:"ILifnr",operator:sap.ui.model.FilterOperator.EQ,value1:i}));if(n!=""&&p!=""){m.push(new sap.ui.model.Filter({path:"IZremision",operator:sap.ui.model.FilterOperator.EQ,value1:n}));m.push(new sap.ui.model.Filter({path:"IZremision2",operator:sap.ui.model.FilterOperator.EQ,value1:p}));g=true}else if(n==""&&p!=""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/rem.filters.folioEmpty"));u=false}else if(n!=""&&p==""){m.push(new sap.ui.model.Filter({path:"IZremision",operator:sap.ui.model.FilterOperator.EQ,value1:n}));g=true}if(g==false){if(r!=""&&o!=""){m.push(new sap.ui.model.Filter({path:"ISfechrem",operator:sap.ui.model.FilterOperator.EQ,value1:r}));m.push(new sap.ui.model.Filter({path:"IFfechrem",operator:sap.ui.model.FilterOperator.EQ,value1:o}))}}if(d!=0){m.push(new sap.ui.model.Filter({path:"ITipoentrega",operator:sap.ui.model.FilterOperator.EQ,value1:d}))}if(s!=""&&l!=""){if(s<l){m.push(new sap.ui.model.Filter({path:"IEbeln",operator:sap.ui.model.FilterOperator.EQ,value1:s}));m.push(new sap.ui.model.Filter({path:"IEbeln2",operator:sap.ui.model.FilterOperator.EQ,value1:l}))}else{sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/rem.filters.orderErrorValue"));u=false}}else if(s==""&&l!=""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/rem.filters.orderEmpty"));u=false}else if(s!=""&&l==""){m.push(new sap.ui.model.Filter({path:"IEbeln",operator:sap.ui.model.FilterOperator.EQ,value1:s}))}if(u){sap.ui.core.BusyIndicator.show();let e=this;this._GetODataV2("ZOSP_AVISO_ANT_SRV","HdrAvisoSet",m,["EFREMNAV","ETREMDNAV"],"").then(t=>{if(t.data.results[0].EFREMNAV.results.length==0){sap.m.MessageBox.information(this.getOwnerComponent().getModel("appTxts").getProperty("/rem.tableEmpty"))}e.getOwnerComponent().setModel(new a(t.data.results[0]),"tableRemissions");e.paginate("tableRemissions","/EFREMNAV",1,0);sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.error(e)})}},onListItemPress:function(e){var t=e.getSource().getBindingContext("tableRemissions").getPath(),r=t.split("/").slice(-1).pop(),o=e.getSource().getBindingContext("tableRemissions").getObject();var i=this.getOwnerComponent().getModel("tableRemissions");var a=i.getProperty("/EFREMNAV/Paginated/results");var s=a[r].Zremision;var l=o.Zremfolio;this.getOwnerComponent().getRouter().navTo("detailRemission",{layout:sap.f.LayoutType.MidColumnFullScreen,document:s,folio:l},true)},buildExportTable:function(){var e=this.getOwnerComponent().getModel("appTxts");var t=[{name:e.getProperty("/rem.document"),template:{content:"{Zremision}"}},{name:e.getProperty("/rem.addressee"),template:{content:"{Werks}"}},{name:e.getProperty("/rem.createDate"),template:{content:"{Zfechrem}"}},{name:e.getProperty("/rem.typeRemission"),template:{content:"{Ztipoaviso}"}},{name:e.getProperty("/rem.statusRemission"),template:{content:"{Zstatus}"}},{name:e.getProperty("/rem.typedeliv"),template:{content:"{Ztipoentreg}"}},{name:e.getProperty("/rem.cancelStatus"),template:{content:"{ZstatusCan}"}}];this.exportxls("tableRemissions","/EFREMNAV/results",t)},setCurrentWeek:function(){var e=new Date;var t=0;var r=e.getDay();var o=new Date(e.valueOf()-(r<=0?7-t:r-t)*864e5);var i=new Date(o.valueOf()+6*864e5);var a=this.getView().byId("dateOrder");a.setDateValue(o);a.setSecondDateValue(i)},onFolioChange:function(e){if(e.getParameter("value")==""){var t=this.inptFolio2.getValue();if(t!=""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/rem.filters.folioEmpty"));this.inptFolio2.setValue("")}}},onFolio2Change:function(e){if(e.getParameter("value")!=""){var t=this.inptFolio.getValue();if(t==""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/rem.filters.folioEmpty"));this.inptFolio2.setValue("")}}},onOrderChange:function(e){if(e.getParameter("value")==""){var t=this.inptOrder2.getValue();if(t!=""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/rem.filters.orderEmpty"));this.inptOrder2.setValue("")}}},onOrder2Change:function(e){if(e.getParameter("value")!=""){var t=this.inptOrder.getValue();if(t==""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/rem.filters.orderEmpty"));this.inptOrder2.setValue("")}}},handleWizardSubmitAviso:function(){console.log("Andle wizard Aviso anticipado!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");sap.m.MessageBox["confirm"](this.getView().getModel("appTxts").getProperty("/rem.submitMessage"),{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){var t=this.getConfigModel().getProperty("/supplierInputKey");var r=this.getView().getModel("reviewModel").getData();var o={Lifnr:t,Type:"A",Format:"X",Log:[{Uuid:"",Description:"",Sts:""}]};o.Cfdi=JSON.stringify(r);var i=d.create("/ECfdiSet ",o);if(i!=null){if(i.Log!=null){this.openLogErrorDialog(i)}else{sap.m.MessageBox.error(i.EMessage)}}this._oWizard.discardProgress(this._oWizard.getSteps()[0]);this.byId("wizardDialog").destroy();this._pDialog=null;this._oWizard=null}}.bind(this)})},clearFilters:function(){this.getView().byId("dateOrder").setValue("");this.getView().byId("folio").setValue("");this.getView().byId("folio2").setValue("");this.getView().byId("order").setValue("");this.getView().byId("order2").setValue("");this.cboxTipo.setSelectedKey("0")}})});