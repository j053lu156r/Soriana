sap.ui.define(["demo/controllers/BaseController","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/f/library","sap/ui/table/RowAction","sap/ui/table/RowActionItem","sap/ui/table/RowSettings","sap/ui/export/library","sap/ui/export/Spreadsheet"],function(e,t,i,a,l,o,r,s,n){"use strict";var d=s.EdmType;var g="/sap/opu/odata/sap/ZOSP_ACLARA_SRV/";return e.extend("demo.controllers.Aclaraciones",{onInit:function(){this.ValidateDevice();let e=`EAclaHdrSet?$expand=ZtaclaraSt,ZtaclaraTa&$filter=IOption eq '7'&$format=json`;let t=this.getOdata(g);let a=this.getOdataJsonModel(e,t);let l=a.getJSON();let o=JSON.parse(l);let r={Estatus:{results:[...o.results[0].ZtaclaraSt.results]},Tipos:{results:[...o.results[0].ZtaclaraTa.results]},sizeFilesUpload:o.results[0].ITamarchivo};this.getOwnerComponent().setModel(new i(r),"catalogos");sap.ui.getCore().setModel(new i(JSON.parse(JSON.stringify(r))),"catalogos_base");this.getView().addEventDelegate({onBeforeShow:function(e){this.getOwnerComponent().setModel(new i,"Aclaraciones");this.clearFilters()}},this);console.log(this.getView().byId("dateRangeAcl").getDateValue())},ValidateNAc:function(){var e=this;if(e.getView().byId("supplierInput").getValue()===""){e.getView().byId("NewClarification").setEnabled(false)}else{e.getView().byId("NewClarification").setEnabled(true)}},ValidateDevice:function(){var e=this;if(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)){e.oModel=new i({idfolio:true,idFAlta:true,idlifnr:false,idDesAcla:false,idFactura:false,idMonRec:false,idIvaRec:false,idAnalista:false,idEstatus2:false,idFAlta2:false,idHalta:false,idFvenc:false,idMonacla:false,idivaacla:false,idNdoc:false})}else{e.oModel=new i({idfolio:true,idFAlta:true,idlifnr:true,idDesAcla:true,idFactura:true,idMonRec:false,idIvaRec:false,idAnalista:false,idEstatus2:false,idFAlta2:false,idHalta:false,idFvenc:false,idMonacla:false,idivaacla:false,idNdoc:false})}e.getView().setModel(e.oModel);e.TableVisible()},onAfterRendering:function(){console.log(this.getView().byId("dateRangeAcl").getDateValue());var e=new Date;e=e.getTime()-1e3*60*60*24*60;this.getView().byId("dateRangeAcl").setDateValue(new Date(e));this.getView().byId("dateRangeAcl").setSecondDateValue(new Date)},onChange:function(){var e=this.getView().byId("dateRangeAcl").getDateValue();var t=this.getView().byId("dateRangeAcl").getSecondDateValue();var i=e.getTime()-t.getTime();console.log(Math.round(i/(1e3*60*60*24))*-1);if(Math.round(i/(1e3*60*60*24))*-1>60){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.ValidacionMens"));var i=new Date;i=i.getTime()-1e3*60*60*24*30;this.getView().byId("dateRangeAcl").setDateValue(new Date(i));this.getView().byId("dateRangeAcl").setSecondDateValue(new Date);return false}},ConfigTable:function(){var e=this;var t=e.getView().byId("dinamicTable");if(!t){t=sap.ui.xmlfragment(e.getView().getId(),"demo.views.Aclaraciones.fragments.option",this);e.getView().addDependent(t);e.getView().byId("dinamicTable").addStyleClass(e.getOwnerComponent().getContentDensityClass())}t.open()},ClosepopUp:function(){var e=this;e.TableVisible();e.getView().byId("dinamicTable").close()},onParentClicked:function(e){var t=e.getParameter("selected");this.oModel.setData({idfolio:t,idFAlta:t,idlifnr:t,idDesAcla:t,idFactura:t,idMonRec:t,idIvaRec:t,idAnalista:t,idEstatus2:t,idFAlta2:t,idHalta:t,idFvenc:t,idMonacla:t,idivaacla:t,idNdoc:t})},TableVisible:function(){var e=this;e.getView().byId("idfolio").setVisible(e.getView().getModel().getProperty("/idfolio"));e.getView().byId("idFAlta").setVisible(e.getView().getModel().getProperty("/idFAlta"));e.getView().byId("idlifnr").setVisible(e.getView().getModel().getProperty("/idlifnr"));e.getView().byId("idDesAcla").setVisible(e.getView().getModel().getProperty("/idDesAcla"));e.getView().byId("idFactura").setVisible(e.getView().getModel().getProperty("/idFactura"));e.getView().byId("idMonRec").setVisible(e.getView().getModel().getProperty("/idMonRec"));e.getView().byId("idIvaRec").setVisible(e.getView().getModel().getProperty("/idIvaRec"));e.getView().byId("idAnalista").setVisible(e.getView().getModel().getProperty("/idAnalista"));e.getView().byId("idEstatus2").setVisible(e.getView().getModel().getProperty("/idEstatus2"));e.getView().byId("idFAlta2").setVisible(e.getView().getModel().getProperty("/idFAlta2"));e.getView().byId("idHalta").setVisible(e.getView().getModel().getProperty("/idHalta"));e.getView().byId("idFvenc").setVisible(e.getView().getModel().getProperty("/idFvenc"));e.getView().byId("idMonacla").setVisible(e.getView().getModel().getProperty("/idMonacla"));e.getView().byId("idivaacla").setVisible(e.getView().getModel().getProperty("/idivaacla"));e.getView().byId("idNdoc").setVisible(e.getView().getModel().getProperty("/idNdoc"))},searchData:function(){if(!this.hasAccess(18)){return false}var e=this.getView().byId("dateRangeAcl");var t=this.getView().byId("comboStatus");var a=this.getView().byId("inputFolioTxt");let l=a.getValue();let o=t.getSelectedKey();let r=this.getConfigModel().getProperty("/supplierInputKey")!=undefined?this.getConfigModel().getProperty("/supplierInputKey"):"";let s=this.buildSapDate(e.getDateValue());let n=this.buildSapDate(e.getSecondDateValue());let d=this.getOwnerComponent().getModel("userdata").getProperty("/EIdusua");let c=[`IOption eq '4'`];if(String(l).trim()!=""){c.push(`IFolio eq '${l}'`)}else{c.push(`IFechai eq '${s}' and IFechaf eq '${n}'`);if(o!="")c.push(`IStatus eq '${o}'`)}if(String(d).trim()!="")c.push(`IIdusua eq '${d}'`);if(r!=""&&!this.getView().byId("colSor").getSelected())c.push(`ILifnr eq '${r}'`);c=c.join(" and ");let p=`EAclaHdrSet?$expand=ZtaclaUp,ZtaclaraFo,ZtaclaraFd,ZtaclaraDo&$filter=${c}&$format=json`;let u=this.getOdata(g);let y=this.getOdataJsonModel(p,u);let f=y.getJSON();let h=JSON.parse(f);var w={Detalles:{results:[...h.results[0].ZtaclaraFo.results]}};if(l!==""&&h.results[0].ZtaclaraFo.results.length==1){this.getView().byId("comboStatus").setSelectedKey(h.results[0].ZtaclaraFo.results[0].Estatus)}this.getOwnerComponent().setModel(new i(w),"Aclaraciones");this.paginate("Aclaraciones","/Detalles",1,0);this.genereteRowAction()},clearFilters:function(){this.getView().byId("inputFolioTxt").setValue("");this.getView().byId("comboStatus").setSelectedKey("");this.getView().byId("dateRangeAcl").setValue("")},newClarification:function(){var e=this;if(e.getView().byId("supplierInput").getValue()===""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.noSupplier"))}else{if(!this.hasAccess(19)){return false}this.getOwnerComponent().getRouter().navTo("detailAclaracion",{layout:sap.f.LayoutType.MidColumnFullScreen,document:"0",modo:"new",tipo:"01"},true)}},genereteRowAction:function(){var e=this.getOwnerComponent().getModel("appTxts");var t=this.byId("aclaracionesList");var i=t.getRowActionTemplate();if(i){i.destroy();i=null}i=new l({items:[new o({icon:"sap-icon://detail-view",text:e.getProperty("/global.view"),press:e=>this.viewClarification(e)}),new o({icon:"sap-icon://edit",text:e.getProperty("/global.edit"),press:e=>this.editClarification(e)})]});t.setRowActionTemplate(i);t.setRowActionCount(2)},viewClarification:function(e){let t=e.getSource().getBindingContext("Aclaraciones").getPath();let i=t.split("/").slice(-1).pop();let l=this.getOwnerComponent().getModel("Aclaraciones");let o=l.getProperty("/Detalles/Paginated/results");this.getOwnerComponent().getRouter().navTo("detailAclaracion",{layout:a.LayoutType.MidColumnFullScreen,document:o[i].Folio,modo:"view",tipo:o[i].TipAcla},true)},editClarification:function(e){if(!this.hasAccess(20)){return false}let t=this.getOwnerComponent().getModel("userdata").getProperty("/ERol");console.log(t);let i=e.getSource().getBindingContext("Aclaraciones").getPath();let l=i.split("/").slice(-1).pop();let o=this.getOwnerComponent().getModel("Aclaraciones");let r=o.getProperty("/Detalles/Paginated/results");let s=true;let n=r[l].Estatus;console.log(n);if(n==="H"){s=false}if(!s){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/clarifications.noEditMsg"));return false}this.getOwnerComponent().getRouter().navTo("detailAclaracion",{layout:a.LayoutType.MidColumnFullScreen,document:r[l].Folio,modo:"edit",tipo:r[l].TipAcla},true)},createColumnConfig:function(){var e=this;var t=e.getView().getModel("Aclaraciones").getData(),i=[];console.log(t);var a=this.getOwnerComponent().getModel("appTxts");i.push({label:a.getProperty("/clarifications.headerFolioUPC"),type:d.String,property:"Folio"});i.push({label:a.getProperty("/clarifications.headerDateUPC"),type:d.String,property:"FAlta"});i.push({label:a.getProperty("/clarifications.headerSupplierUPC"),type:d.String,property:"Lifnr"});i.push({label:a.getProperty("/clarifications.headerTypeUPC"),type:d.String,property:"DesAcla"});i.push({label:a.getProperty("/clarifications.headerInvoiceUPC"),type:d.String,property:"Factura"});i.push({label:a.getProperty("/clarifications.headerReclaimedAmountUPC"),type:d.String,property:"MonRec"});i.push({label:a.getProperty("/clarifications.headerReclaimedTaxesUPC"),type:d.String,property:"IvaRec"});i.push({label:a.getProperty("/clarifications.headerStatusUPC"),type:d.String,property:"DesStatus"});i.push({label:a.getProperty("/clarifications.headerAnalystUPC"),type:d.String,property:"Analista"});i.push({label:a.getProperty("/clarifications.headerAssignmentDateUPC"),type:d.String,property:"FAlta"});i.push({label:a.getProperty("/clarifications.headerAssignmentTimeUPC"),type:d.String,property:"HAlta"});i.push({label:a.getProperty("/clarifications.headerSolutionDateUPC"),type:d.String,property:"FVenc"});i.push({label:a.getProperty("/clarifications.headerClearedAmountUPC"),type:d.String,property:"MonAcla"});i.push({label:a.getProperty("/clarifications.headerSupplierUPC"),type:d.String,property:"IvaAcla"});i.push({label:a.getProperty("/clarifications.headerPaymentUPC"),type:d.String,property:"NoDoc"});console.log(i);return i},buildExportTable:function(){var e,t,i,a,l,o=this;if(!o._oTable){o._oTable=this.byId("aclaracionesList")}l=o._oTable;console.log(l);t=l.getBinding().oList;e=o.createColumnConfig();i={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:t,fileName:"Aclaraciones",worker:false};a=new n(i);a.build().finally(function(){a.destroy()})},onSelectColaborator:function(){this.getView().byId("supplierInput").setEditable(!this.getView().byId("colSor").getSelected())},paginar:function(e){let t=parseInt(this.getOwnerComponent().getModel("Aclaraciones").getProperty("/Detalles/results/length"),10);let i=parseInt(e.getKey(),10);let a=this.getView().byId("aclaracionesList");a.setVisibleRowCount(t<i?t:i);this.paginateValue(e,"Aclaraciones","/Detalles")},formatStatus:function(e){var t="";if(e!=null){var i=this.getOwnerComponent().getModel("catalogos");if(i!=null){var a=i.getProperty("/Estatus/results");if(a!=null){var l=a.find(t=>t.Status==e);t=l.Descripcion}}}return t}})});