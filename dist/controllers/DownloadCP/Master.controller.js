sap.ui.define(["demo/controllers/BaseController"],function(e){"use strict";var t=new this.CartaPorte;var o=new this.FilesCartaPorte;return e.extend("demo.controllers.DownloadCP.Master",{cboxComboBoxDet:undefined,cboxTipoOper:undefined,inputFolio:undefined,onInit:function(){this.configFilterLanguage(this.getView().byId("filterBar"));this.onLoadCedis();this.onLoadTipoOperacion();this.cboxComboBoxDet=this.getView().byId("DCPComboBoxDet");this.cboxTipoOper=this.getView().byId("DCPComboBoxOp");this.inputFolio=this.getView().byId("DCPinputFolio");var e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("masterDownloadCP").attachMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){this._clearInputs()},onExit:function(){this._clearInputs()},onLoadCedis:function(){sap.ui.core.BusyIndicator.show(0);const e=this;const o=new XMLSerializer;var s='<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '+'xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'+"<soap:Body>"+'<GetCedis xmlns="http://tempuri.org/" />'+"</soap:Body>"+"</soap:Envelope>";$.ajax({async:true,url:t.sUrl,method:"POST",headers:{"Content-Type":"text/xml; charset=utf-8","Access-Control-Allow-Origin":"*"},data:s,success:async function(t){const s=o.serializeToString(t.getElementsByTagName("GetCedisResult")[0]);let r=xml2js(s,{compact:true});let a=r.GetCedisResult;a.Cedis=await e._formatDataCedis(a.Cedis);var i=new sap.ui.model.json.JSONModel;i.setData(a);e.getOwnerComponent().setModel(i,"CedisModel");sap.ui.core.BusyIndicator.hide()},error:function(e,t,o){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/cartaPorte.missingCedisError"))}})},onLoadTipoOperacion:function(){sap.ui.core.BusyIndicator.show(0);const e=this;const o=new XMLSerializer;var s='<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '+'xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">'+"<soap:Body>"+'<GetTipoOper xmlns="http://tempuri.org/" />'+"</soap:Body>"+"</soap:Envelope>";$.ajax({async:true,url:t.sUrl,method:"POST",headers:{"Content-Type":"text/xml; charset=utf-8","Access-Control-Allow-Origin":"*"},data:s,success:async function(t){const s=o.serializeToString(t.getElementsByTagName("GetTipoOperResult")[0]);let r=xml2js(s,{compact:true});let a=r.GetTipoOperResult;a.TipoOperacion=await e._formatDataTipoOper(a.TipoOperacion);var i=new sap.ui.model.json.JSONModel;i.setData(a);e.getOwnerComponent().setModel(i,"TipoOperModel");sap.ui.core.BusyIndicator.hide()},error:function(e,t,o){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/cartaPorte.missingTipoOperError"))}})},async _formatDataCedis(e){await e.forEach(function(t,o){let s={Id_Num_UN:0,Ids_Num_UN:0,Desc_UN:""};s.Id_Num_UN=t.Id_Num_UN._text;s.Ids_Num_UN=t.Ids_Num_UN._text;s.Desc_UN=t.Desc_UN._text;e[o]=s});return e},async _formatDataTipoOper(e){await e.forEach(function(t,o){let s={Id_Num_TipoOper:0,Desc_TipoOper:""};s.Id_Num_TipoOper=t.Id_Num_TipoOper._text;s.Desc_TipoOper=t.Desc_TipoOper._text;e[o]=s});return e},onDownload:function(){let e=this;let t=this.getConfigModel().getProperty("/supplierInputKey");let s=this.cboxComboBoxDet.getSelectedKey();let r=this.cboxTipoOper.getSelectedKey();let a=this.inputFolio.getValue();let i=this.cboxComboBoxDet.getSelectedItem().getText();let n=this.cboxTipoOper.getSelectedItem().getText();if(s==""||r==""||a==""||t==undefined){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/cartaPorte.missingDataError"))}else{sap.ui.core.BusyIndicator.show(0);const p=new FormData;p.append("IdsNumUn",s);p.append("TipoOperacion",r);p.append("provid",t);p.append("folio",a);p.append("BControlDescargar","bajar");$.ajax({async:true,url:o.sUrl,method:"POST",headers:{"Access-Control-Allow-Origin":"*"},processData:false,contentType:false,mimeType:"multipart/form-data",data:p,success:function(o){sap.ui.core.BusyIndicator.hide();if(o!==""){var s=new Blob([o],{type:"text/plain;charset=utf-8"});saveAs(s,`${n}_${i}_${t}_${a}.txt`)}else{sap.m.MessageBox.error(e.getOwnerComponent().getModel("appTxts").getProperty("/cartaPorte.emptyFile"))}},error:function(){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error(e.getOwnerComponent().getModel("appTxts").getProperty("/cartaPorte.downloadError"))}})}},_clearInputs(){this.cboxComboBoxDet.setSelectedKey(null);this.cboxTipoOper.setSelectedKey(null);this.inputFolio.setValue(null)}})});