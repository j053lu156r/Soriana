sap.ui.define(["jquery.sap.global","sap/ui/core/Fragment","demo/controllers/BaseController","sap/m/UploadCollectionParameter","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/ui/core/routing/Router","sap/m/upload/Uploader","sap/ui/richtexteditor/RichTextEditor","sap/ui/richtexteditor/EditorType","sap/m/SearchField","sap/m/Token"],function(e,t,a,s,i,o,n,r){"use strict";var l=new this.MyInbox;return a.extend("demo.controllers.MiBandeja.Releases.NewRelease",{onInit:function(){this.oRouter=this.getOwnerComponent().getRouter();this.getView().addEventDelegate({onBeforeShow:function(e){var t={attach:[]};this.getOwnerComponent().setModel(new o(t),"nRelease");this.getView().byId("allSupp").setSelected(false);this.getView().byId("btnAdd").setEnabled(true);this.getView().byId("btnRemove").setEnabled(true);var a=this.byId("dateRange");a.setMinDate(new Date);a.setDateValue(new Date);a.setSecondDateValue(new Date)}},this);this.configUploadSet(this.getView().byId("attacheds"));var e=this.getView().byId("attacheds");e.attachAfterItemRemoved(this.onDeleteAttach.bind(this));e.attachAfterItemAdded(this.addAttach.bind(this))},onCancel:function(){this.goToMainRelease()},handleChange:function(e){var t=e.getParameter("from"),a=e.getParameter("valid"),s=e.getSource();if(a){}else{s.setValueState(ValueState.Error)}},goToMainRelease:function(){this.oRouter.navTo("masterRelease");this.clearFields()},openSupplierSlect:function(){if(!this._uploadDialog2){this._uploadDialog2=sap.ui.xmlfragment("demo.views.MiBandeja.Releases.SupplierSelect",this);this.getView().addDependent(this._uploadDialog2)}this._uploadDialog2.open()},addSupplier:function(e){var t=e.getParameter("selectedItem");e.getSource().getBinding("items").filter([]);if(!t){return}var a={title:t.getTitle(),description:t.getDescription()};var s={suppList:[]};if(this.getOwnerComponent().getModel("newRelease")){s.suppList=this.getOwnerComponent().getModel("newRelease").getProperty("/suppList");if(s.suppList!=null&&!s.suppList.find(e=>e.title==a.title)){s.suppList.push(a)}}else{s.suppList.push(a)}var i=new sap.ui.model.json.JSONModel(s);this.getOwnerComponent().setModel(i,"newRelease")},deleteSupplier:function(){var e=this.getView().byId("suppList").getSelectedItems();if(e!=null&&e.length>0){e.forEach(e=>{var t=e.getBindingContext("newRelease");var a=this.getOwnerComponent().getModel("newRelease").getObject(t.sPath);var s=this.getOwnerComponent().getModel("newRelease").getData().suppList;s.splice(s.indexOf(a),1);this.getOwnerComponent().getModel("newRelease").refresh();this.getView().byId("suppList").removeSelections()})}},allSuppliers:function(e){var t=e.getSource().getSelected();var a=this.getView().byId("suppList").getItems();if(t){if(a.length>0){var s={suppList:[]};this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(s),"newRelease")}this.getView().byId("btnAdd").setEnabled(false);this.getView().byId("btnRemove").setEnabled(false)}else{this.getView().byId("btnAdd").setEnabled(true);this.getView().byId("btnRemove").setEnabled(true)}},validateData(e,t,a,s,i){var o=true;if(e==null||e.getValue()==""){o=false;sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/release.daterangeError"))}if(o){if(t==null||t==""){o=false;sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/release.subjectError"))}}if(o){if(a==null||a==""){o=false;sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/release.messageError"))}}if(o){if(i==null||!i.getSelected()){if(s==null||s.getItems().length==0){o=false;sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/release.supplierError"))}}}return o},createRelease:function(){var e=this.getView().byId("subject").getValue();var t=this.getView().byId("message").getValue();var a=this.getView().byId("dateRange");var s=this.getView().byId("suppList");var i=this.getView().byId("allSupp");var o=this.getView().byId("sendMail");var n=this.getOwnerComponent().getModel("userdata");var r=n.getProperty("/EIdusua");var d=this.getView().byId("attacheds");var u=this.getView().getModel();var p=this.buildSapDate(a.getDateValue());var g=this.buildSapDate(a.getSecondDateValue());if(!this.validateData(a,e,t,s,i)){return}var c=[];s.getItems().forEach(function(e){var t={Lifnr:e.getProperty("title")};c.push(t)});var h=this.getOwnerComponent().getModel("nRelease").getProperty("/attach");var m={IOption:"1",IIdusua:r,IAllpro:this.booleanToAbapTrue(i.getSelected()),ISdate:p,IEdate:g,IFmail:this.booleanToAbapTrue(o.getSelected()),ISubject:e,IText:t,ITPROVNAV:c,ITATTACNAV:h};var f=l.create("/headInboxSet",m);if(f!=null){if(f.ESuccess=="X"){sap.m.MessageBox.success("Se ha enviado el comunicado.",{actions:[sap.m.MessageBox.Action.CLOSE],emphasizedAction:sap.m.MessageBox.Action.CLOSE,onClose:function(e){this.goToMainReleases();this.clearFields()}.bind(this)})}else{sap.m.MessageBox.error(f.EMessage)}}else{sap.m.MessageBox.error("No se pudo conectar con el servidor, intente nuevamente.")}},goToMainReleases:function(){this.oRouter.navTo("masterRelease");this.clearFields()},clearFields:function(){this.getView().byId("subject").setValue("");this.getView().byId("message").setValue("");this.getView().byId("dateRange").setValue("");this.getOwnerComponent().setModel(new o,"nRelease");var e={suppList:[]};this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(e),"newRelease");this.getView().byId("allSupp").setSelected(false);this.getView().byId("sendMail").setSelected(false);var t=this.getView().byId("attacheds");t.destroyItems();t.destroyIncompleteItems();t.removeAllHeaderFields();t.removeAllIncompleteItems();t.removeAllItems()},onChangeUpload:function(e){var t=e.getParameter("files");t},onUpload:function(e){this._import(e.getParameter("files")&&e.getParameter("files")[0])},_import:function(e){var t=this;var a={};if(e&&window.FileReader){var s=new FileReader;s.onload=function(e){var s=e.target.result;var i=XLSX.read(s,{type:"binary"});i.SheetNames.forEach(function(e){a=XLSX.utils.sheet_to_row_object_array(i.Sheets[e]);if(a!=null&&a.length>0){var s={suppList:[]};a.forEach(e=>{if(t.getOwnerComponent().getModel("newRelease")){s.suppList=t.getOwnerComponent().getModel("newRelease").getProperty("/suppList");if(s.suppList!=null&&!s.suppList.find(t=>t.title==e.title)){s.suppList.push(e)}}else{s.suppList.push(e)}var a=new sap.ui.model.json.JSONModel(s);t.getOwnerComponent().setModel(a,"newRelease")})}})};s.onerror=function(e){console.log(e)};s.readAsBinaryString(e)}},addAttach:function(e){var t=this;var a=e.getParameter("item");var s=a.getFileObject();var i=this.getOwnerComponent().getModel("nRelease");var o={};o.Zatname=s.name;o.Zdoctype=s.type;var n=new FileReader;n.onload=function(e){o.Zdocvalue64=e.target.result;var t=i.getData();t.attach.push(o);a.setUploadState(sap.m.UploadState.Complete)};n.readAsDataURL(s)},onDeleteAttach:function(e){var t=e.getParameter("item");var a=t.getFileObject();a},booleanToAbapTrue:function(e){var t=false;if(e){t="X"}else{t=""}return t},initRichTextEditor:function(e){var t=this;sap.ui.require(["sap/ui/richtexteditor/RichTextEditor","sap/ui/richtexteditor/EditorType"],function(a,s){t.oRichTextEditor=new a("message",{editorType:e?s.TinyMCE5:s.TinyMCE4,width:"100%",customToolbar:true,showGroupFont:true,showGroupLink:true,showGroupInsert:true,value:"",ready:function(){this.addButtonGroup("styleselect").addButtonGroup("table")}});t.getView().byId("idVerticalLayout").addContent(t.oRichTextEditor)})},readyEditor:function(e){e.getSource().addButtonGroup("styleselect")},befInit:function(e){tinyMCE.execCommand("mceRepaint")},_onMultiInputValidate:function(e){if(e.suggestionObject){var t=e.suggestionObject.getBindingContext().getObject(),a=new r;a.setKey(t.ProductId);a.setText(t.Name+" ("+t.ProductId+")");return a}return null}})});