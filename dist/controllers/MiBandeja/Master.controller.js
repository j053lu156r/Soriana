sap.ui.define(["sap/m/library","sap/ui/thirdparty/jquery","sap/m/MessageBox","demo/controllers/BaseController","sap/ui/core/mvc/Controller","sap/base/Log","sap/ui/model/json/JSONModel","sap/ui/Device"],function(e,t,o,a,i,n,s){"use strict";var l=e.URLHelper;var r=new this.MyInbox;return a.extend("demo.controllers.MiBandeja.Master",{onInit:function(){this._pdfViewer=new sap.m.PDFViewer;this.getView().addDependent(this._pdfViewer);this.getView().addEventDelegate({onBeforeShow:function(){this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel,"tableInbox");this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel,"tableLocations");this.clearFilters()},onAfterShow:function(e){this.getOwnerComponent().getModel("configSite").setProperty("/barVisible",true);this.getInbox()}},this);var e=this.getView().byId("GeoMap");var t={MapProvider:[{Id:"base",name:"Base",tileX:"512",tileY:"512",minLOD:"1",maxLOD:"19",copyright:"Google",Source:[{id:"a",url:"https://mt1.google.com/vt/lyrs=r&style=2&x={X}&y={Y}&z={LOD}"}]}],MapLayerStacks:[{name:"Default",MapLayer:[{name:"Default",refMapProvider:"Base",opacity:"1.0"}],colBkgnd:"rgb(0,0,0)"}]};e.setMapConfiguration(t);e.setRefMapLayerStack("Default");e.setInitialZoom(17)},searchData:function(){var e=this.getSplitContObj().getCurrentPage(false).sId;var t=e.replace(`${this.getView().sId}--`,"");switch(t){case"locations":this.doSearchLocation(this.getView().byId("searchLocation").getValue());break;case"detailDetail":this.getHelpDocs();break;case"inbox":this.doSearchRelease(this.getView().byId("subject").getValue());break}},onPressNavToDetail:function(){this.getSplitContObj().to(this.createId("detailDetail"));this.getHelpDocs()},onPressNotices:function(){sap.m.MessageBox.success("test")},onPressMasterBack:function(){this.getSplitContObj().backMaster()},onPressGoToMaster:function(){this.getSplitContObj().toDetail(this.createId("inbox"));this.getInbox()},onPressGoToMasterLocations:function(){this.getSplitContObj().toDetail(this.createId("locations"))},onListItemPress:function(e){var t=e.getParameter("listItem").getCustomData()[0].getValue();this.getSplitContObj().toDetail(this.createId(t));this.buildView(t)},lon2tile:function(e,t){var o=Math.floor((e+180)/360*Math.pow(2,t));o},lat2tile:function(e,t){var o=Math.floor((1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t));o},selectRelease:function(e){var t=e.getSource().getBindingContext("tableInbox").getPath();var o=this.getOwnerComponent().getModel("userdata").getProperty("/IMail");var a=this.getOwnerComponent().getModel("tableInbox");var i=a.getProperty(t);var n=r.getJsonModel("/headInboxSet?$expand=ETATTACHNAV&$filter=IOption eq '4'"+" and IMail eq '"+o+"'"+" and IIdmen eq '"+i.Idmensaje+"'");if(n!=null){var s=n.getProperty("/results/0");this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(s),"release")}this.getSplitContObj().toDetail(this.createId("releaseDetail"))},buildView:function(e){switch(e){case"inbox":this.getInbox();break;case"detailDetail":this.getHelpDocs();break}},getInbox:async function(){var e=this.getView().byId("releaseSearch");if(e!=null&&e.getValue()!=""){return}var t=this.getOwnerComponent().getModel("userdata").getProperty("/IMail");this.getView().byId("complPagoList").setBusy(true);var o=r.getJsonModelAsync(`/headInboxSet?$expand=ETINBOXUNAV&$filter=IOption eq '2' and IMail eq '${t}'`,function(e,t){var o=e.getProperty("/results/0");if(o!=null){t.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(o),"tableInbox");t.paginated("tableInbox","/ETINBOXUNAV",1,0)}t.getView().byId("complPagoList").setBusy(false);t.inboxMetric()},function(e){e.getView().byId("complPagoList").setBusy(false)},this)},getHelpDocs:function(){var e=this.getView().byId("helpDocSearch").getValue();this.getView().byId("helpDocsList").setBusy(true);var t="/headInboxSet?$expand=ETDOCANAV&$filter= IOption eq '10'";if(e!=null&&e!=""){t+=` and IName eq '${e}'`}r.getJsonModelAsync(t,function(e,t){var o=e.getProperty("/results/0");if(o!=null){t.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(o),"tableHelpDocs");t.paginated("tableHelpDocs","/ETDOCANAV",1,0)}t.getView().byId("helpDocsList").setBusy(false)},function(e){e.getView().byId("helpDocsList").setBusy(false)},this)},selectHelpDoc:function(e){var t=r.getJsonModel(`/headInboxSet?$expand=ETDOCANAV&$filter= IOption eq '11' and IIdhp eq '${e}'`);if(t!=null){var o=t.getProperty("/results/0");if(o.ESuccess=="X"){this.downloadAttach(o.EsVdoca.Zdocvalue64,o.EsVdoca.Zdoctype)}else{sap.m.MessageBox.error(o.EMessage)}}},searchLocation:function(e){var t=e.getSource().getValue();this.doSearchLocation(t)},doSearchLocation:function(e){if(e!=null&&e!=""){var t=new sap.m.BusyDialog;t.open();var o=r.getJsonModel("/headInboxSet?$expand=ETSTORENAV&$filter= IOption eq '14' and IName eq '"+e+"'");t.close();if(o!=null){var a=o.getProperty("/results/0");this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(a),"tableLocations");this.paginated("tableLocations","/ETSTORENAV",1,0)}}else{this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel,"tableLocations")}},onPressLocation:function(e){var t=e.getSource().getBindingContext("tableLocations").getPath();var o=this.getOwnerComponent().getModel("tableLocations");var a=o.getProperty(t);this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(a),"detailLocation");var i=this.getView().byId("GeoMap");if(a.Zlatitud!=null&&a.Zlatitud!=""&&a.Zlongitud!=null&&a.Zlongitud!=""){i.setCenterPosition(a.Zlongitud+";"+a.Zlatitud);i.setVisible(true)}else{i.setVisible(false)}this.getSplitContObj().toDetail(this.createId("locantionsDetail"))},getSplitContObj:function(){var e=this.byId("SplitContDemo");if(!e){i.error("SplitApp object can't be found")}return e},paginated:function(e,t,o,a){this.paginate(e,t,o,a)},handleUrlMap:function(e,t){var o="https://www.google.com.mx/maps/@"+t+","+e+",19z";l.redirect(o,true)},hasMap:function(e,t){return e!=null&&e!=""&&t!=null&&t!=""},editMap:function(e,t){var o=this.getOwnerComponent().getModel("userdata").getProperty("/IRol");return e!=null&&e!=""&&t!=null&&t!=""&&o=="0001"},defineCoordinates:function(){if(!this._uploadDialog2){this._uploadDialog2=sap.ui.xmlfragment("coordinatesFragment","demo.views.MiBandeja.fragments.EditCoordinates",this);this.getView().addDependent(this._uploadDialog2)}this._uploadDialog2.open()},onCloseDialog:function(){if(this._uploadDialog2){this._uploadDialog2.destroy();this._uploadDialog2=null}},saveCoordinates:function(){var e=sap.ui.core.Fragment.byId("coordinatesFragment","latitud").getValue();var t=sap.ui.core.Fragment.byId("coordinatesFragment","longitud").getValue();if(e!=null&&e!=""&&t!=null&&t!=""){var o={IOption:"15",IMail:this.getOwnerComponent().getModel("userdata").getProperty("/IMail"),ISTORECO:[{Werks:this.getOwnerComponent().getModel("detailLocation").getProperty("/Werks"),Zlatitud:this.getOwnerComponent().getModel("detailLocation").getProperty("/Zlatitud"),Zlongitud:this.getOwnerComponent().getModel("detailLocation").getProperty("/Zlongitud")}]};var a=r.create("/headInboxSet",o);if(a!=null){if(a.ESuccess=="X"){this.onCloseDialog()}else{}}}},pdfView:function(e,t){var o=this.buildBlobUrl(e,t);if(!this._PDFViewer){this.createPDFView(o)}else{if(this._PDFViewer.getSource()!==o){this._PDFViewer=null}this.createPDFView(o)}this._PDFViewer.open()},createPDFView:function(e){this._PDFViewer=new sap.m.PDFViewer({width:"auto",source:e});t.sap.addUrlWhitelist("blob")},searchDataUser:function(){var e=sap.ui.getCore().getModel("userdata").getProperty("/IMail");var t=false;var o=sap.ui.core.format.DateFormat.getDateTimeInstance({parent:"yyyyMMdd"});var a=this.getView().byId("dateRange");var i=this.buildSapDate(a.getDateValue());var n=this.buildSapDate(a.getSecondDateValue());var s=this.getView().byId("subject").getValue();var l=this.getOwnerComponent().getModel("userdata").getProperty("/EIdusua");if(s!=null&&s==""){if(i!=""&&n!=""){t=true}else{t=false;sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/global.searchFieldsEmpty"))}}else{t=true}if(t){var d="/headInboxSet?$expand=ETINBOXUNAV&$filter=IOption eq '2' and IMail eq '"+e+"'";if(s!=""){d+="  and IName eq '"+s+"'"}if(i!=""&&n!=""){d+=" and ISdate eq '"+i+"'"+" and IEdate eq '"+n+"'"}var g=r.getJsonModel(d);var u=g.getProperty("/results/0");if(u!=null){this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(u),"tableInbox");this.paginated("tableInbox","/ETINBOXUNAV",1,0)}}},searchRelease:function(e){var t=e.getSource().getValue();this.doSearchRelease(t)},doSearchRelease:function(e){var t=sap.ui.getCore().getModel("userdata").getProperty("/IMail");if(e&&e.length>0){var o=r.getJsonModelAsync(`/headInboxSet?$expand=ETINBOXUNAV&$filter=IOption eq '2' and IMail eq '${t}'  and IName eq '${e}'`,function(e,t){var o=e.getProperty("/results/0");if(o!=null){t.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(o),"tableInbox");t.paginated("tableInbox","/ETINBOXUNAV",1,0)}t.getView().byId("complPagoList").setBusy(false);t.inboxMetric()},function(e){e.getView().byId("complPagoList").setBusy(false)},this)}else{this.getInbox()}},clearFilters:function(){this.getView().byId("helpDocSearch").setValue("");this.getView().byId("searchLocation").setValue("")}})});