sap.ui.define(["demo/controllers/BaseController","sap/m/MessageBox","sap/m/PDFViewer"],function(e,t,o){"use strict";var r=new this.Acuerdos;return e.extend("demo.controllers.Acuerdos.Master",{onInit:function(){this._pdfViewer=new o;this.getView().addDependent(this._pdfViewer);this.getView().addEventDelegate({onAfterShow:function(e){var t=this.getOwnerComponent().getModel();t.setProperty("/barVisible",true);this.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel,"AcuerdosHdr");this.clearFilters()}},this);this.configFilterLanguage(this.getView().byId("filterBar"))},searchData:function(){var e=this.getOwnerComponent().getModel("appTxts");var o=true;if(!r.getModel()){r.initModel()}var s=this.getView().byId("sociedadInput").getValue();var a=this.getView().byId("documentoInput").getValue();var n=this.getView().byId("ejercicioInput").getValue();var i=this.getView().byId("acuerdoInput").getValue();if((a==""||a==null)&&(i==""||i==null)){t.error(e.getProperty("/acuerdos.indNo"));o=false}else if(a!=""&&a!=null&&(i!=""&&i!=null)){t.error(e.getProperty("/acuerdos.soloIndNo"));o=false}else if(a!=""&&a!=null){if(s==""||s==null){t.error(e.getProperty("/acuerdos.indSoc"));o=false}else if(n==""||n==null){t.error(e.getProperty("/acuerdos.indEje"));o=false}}if(o){var d="AcuerdosSet?$expand=AcuerdosDet&$filter=";if(a!=""&&a!=null){d+="Sociedad eq '"+s+"'";d+=" and Documento eq '"+a+"'";d+=" and Ejercicio eq '"+n+"'"}else if(i!=""&&i!=null){d+="DoAcuerdo eq '"+i+"'"}this.getView().byId("tableAcuerdos").setBusy(true);r.getJsonModelAsync(d,function(e,t){var o=e.getProperty("/results/0");if(o!=null){var r=o.AcuerdosDet.results.reduce((e,t)=>+e+(+t["Base"]||0),0);var s=o.AcuerdosDet.results.reduce((e,t)=>+e+(+t["Descuento"]||0),0);var a=o.AcuerdosDet.results.reduce((e,t)=>+e+(+t["IVA"]||0),0);var n={TotBase:Number(r.toFixed(2)),TotDescto:Number(s.toFixed(2)),TotIVA:Number(a.toFixed(2))};t.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(n),"acuTotDetModel");t.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(o),"AcuerdosHdr");t.paginate("AcuerdosHdr","/AcuerdosDet",1,0)}t.getView().byId("tableAcuerdos").setBusy(false)},function(e){e.getView().byId("tableAcuerdos").setBusy(false)},this)}},onExit:function(){},clearFilters:function(){var e=new Date;var t=e.getFullYear();this.getView().byId("sociedadInput").setValue("2001");this.getView().byId("documentoInput").setValue("");this.getView().byId("ejercicioInput").setValue(t);this.getView().byId("acuerdoInput").setValue("");var o=this.getOwnerComponent().getModel("AcuerdosHdr");if(o){o.setData([])}},buildExportTable:function(){var e=this.getOwnerComponent().getModel("appTxts");var t=[{name:e.getProperty("/acuerdos.sucursal"),template:{content:"{Centro}"}},{name:e.getProperty("/acuerdos.base"),template:{content:"{Base}"}},{name:e.getProperty("/acuerdos.desc"),template:{content:"{Descuento}"}},{name:e.getProperty("/acuerdos.iva"),template:{content:"{IVA}"}},{name:e.getProperty("/acuerdos.pDesc"),template:{content:"{PDesc}"}},{name:e.getProperty("/acuerdos.unidad"),template:{content:"{Unidad}"}}];this.exportxls("AcuerdosHdr","/AcuerdosDet/results",t)},onListItemPress:function(e){var t=e.getSource().getBindingContext("AcuerdosHdr").getPath(),o=t.split("/").slice(-1).pop();var r=this.getOwnerComponent().getModel("AcuerdosHdr");var s=r.getProperty("/AcuerdosDet/Paginated/results");var a=s[o];var n=this.getView().byId("sociedadInput").getValue();var i=this.getView().byId("documentoInput").getValue();var d=this.getView().byId("ejercicioInput").getValue();this.getOwnerComponent().getRouter().navTo("detailDetailAcu",{layout:sap.f.LayoutType.TwoColumnsMidExpanded,sociedad:n,documento:i,ejercicio:d,tienda:a.Centro},true)},onPressPDF:function(){var e=this.getOwnerComponent().getModel("AcuerdosHdr");var t=e.getData();var o="/sap/opu/odata/sap/ZOSP_ACUERDOS_SRV/";var r=o+"AcuerdosFilesSet('"+t.UUID+"')/$value";this._pdfViewer.setSource(r);this._pdfViewer.setTitle("CFDI");this._pdfViewer.open()},onPressXML:function(){var e=this.getOwnerComponent().getModel("AcuerdosHdr");var o=e.getData();var r="/sap/opu/odata/sap/ZOSP_ACUERDOS_SRV/";var e=new sap.ui.model.odata.ODataModel(r);e.read("/AcuerdosFilesSet('XML"+o.UUID+"')/$value",{method:"GET",success:function(e,t){let r=o.UUID;let s="application/xml";let a=t.body;sap.ui.core.util.File.save(a,r,"xml",s)},error:function(e){t.error(e.message)}})}})});