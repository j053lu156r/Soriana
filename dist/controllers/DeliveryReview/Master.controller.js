sap.ui.define(["jquery.sap.global","sap/ui/core/Fragment","demo/controllers/BaseController","sap/m/UploadCollectionParameter","sap/ui/core/mvc/Controller","sap/m/PDFViewer","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/m/MessageBox","sap/ui/core/routing/Router","demo/models/BaseModel","sap/f/library"],function(e,t,i,a,o,r,n,l){"use strict";var s=new this.DelivReview;var g=new this.CfdiModel;return i.extend("demo.controllers.DeliveryReview.Master",{onInit:function(){this._pdfViewer=new r;this.getView().addDependent(this._pdfViewer);this.getView().addEventDelegate({onAfterShow:function(e){var t=this.getOwnerComponent().getModel();t.setProperty("/barVisible",true);this.getOwnerComponent().setModel(new n,"tableDelivReview");this.clearFilters();this.getView().byId("dateRange").setValue("");this.getView().byId("folioRecibo").setValue("");this.getConfigModel().setProperty("/updateFormatsSingle","xml")}},this);this.configFilterLanguage(this.getView().byId("filterBar"))},searchData:function(){if(!this.hasAccess(7)){return false}var e=false;if(!s.getModel()){s.initModel()}var t=sap.ui.core.format.DateFormat.getDateTimeInstance({parent:"yyyyMMdd"});var i=this.getView().byId("dateRange");var a=this.buildSapDate(i.getDateValue());var o=this.buildSapDate(i.getSecondDateValue());var r=this.getConfigModel().getProperty("/supplierInputKey");var l=this.getView().byId("fact").getValue();var g=this.getView().byId("xblnr").getValue();var p=this.getView().byId("folioRecibo").getValue();var d=this.getView().byId("conta").getSelected();if(r!=null&&r!=""){e=true}else{sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/global.supplierSelectError"))}if(e){if(l==""){if(p==""){if(g==""){if(a!=""&&o!=""){e=true}else{e=false;sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/global.searchFieldsEmpty"))}}else{e=true}}else{e=true}}else{e=true}}if(e){var c="/FacrevnavSet?$expand=FACNAV&$filter=IOption eq '1' and ILifnr eq '"+r+"'";if(l!=""){c+=" and IBelnr eq '"+l+"'"}if(a!=""&&o!=""){c+=" and IFini eq '"+a+"' and IFfin eq '"+o+"'"}if(p!=""){c+=" and IMblnr eq '"+p+"'"}if(g!=""){c+=" and IXblnr eq '"+g+"'"}if(d!=null&&d){c+=" and IConta eq 'X'"}var u=s.getJsonModel(c);var v=u.getProperty("/results/0");console.log(u);this.getOwnerComponent().setModel(new n(v),"tableDelivReview");this.paginate("tableDelivReview","/FACNAV",1,0);if(v.FACNAV.results.length>0){this.getView().byId("btnLog").setVisible(true)}}},openUploadDialog:function(){if(!this.hasAccess(45)){return false}if(!this._uploadDialog2){this._uploadDialog2=sap.ui.xmlfragment("uploadInvoice","demo.fragments.UploadInvoice",this);this.getView().addDependent(this._uploadDialog2)}this._uploadDialog2.open()},onCloseDialogUpload:function(){if(this._uploadDialog2){this._uploadDialog2.destroy();this._uploadDialog2=null}},documentUploadPress:function(){var e=sap.ui.core.Fragment.byId("uploadInvoice","fileUploader");var t=sap.ui.core.Fragment.byId("uploadInvoice","logUploadList");var i=sap.ui.core.Fragment.byId("uploadInvoice","uploadBox");var a=this.getConfigModel().getProperty("/supplierInputKey");if(!e.getValue()){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/helpDocs.uploader.nodata"));return}var o={Lifnr:a,Type:"-",Log:[{Uuid:"",Description:"",Sts:""}]};var r=this.byId("complPagoList").getSelectedItems();if(r.length>0){var l=r[0].getBindingContext("tableDelivReview").getObject();o.Invoice=l.Belnr;o.Uuid=l.ZtfiglUuid;o.Year=l.Gjahr}var s=e.oFileUpload.files[0];var p=new FileReader;p.onload=function(a){var r={};var l=a.target.result.split(",");r.Cfdii=l[1];o.Cfdi=l[1];var s=g.create("/ECfdiSet ",o);if(s!=null){i.setVisible(false);if(s.Log!=null){t.setVisible(true);t.setModel(new n(s))}else{sap.m.MessageBox.error(s.EMessage)}}e.clear()};p.readAsDataURL(s)},onExit:function(){},filtrado:function(e){var t=[];var i=e.getParameter("query");var a=this.getView().byId("selectFilter");var o=a.getSelectedKey();if(i&&i.length>0){var r=new sap.ui.model.Filter(o,sap.ui.model.FilterOperator.Contains,i);t.push(r)}var n=this.getView().byId("complPagoList");var l=n.getBinding("items");l.filter(t)},setDaterangeMaxMin:function(){var e=this.getView().byId("dateRange");var t=new Date;var i=new Date;var a=new Date;a.setDate(t.getDate()-7);i.setDate(t.getDate()-30);e.setSecondDateValue(t);e.setDateValue(a)},onListItemPress:function(e){var t=e.getSource().getBindingContext("tableDelivReview").getPath(),i=t.split("/").slice(-1).pop();var a=this.getConfigModel().getProperty("/supplierInputKey");var o=this.getOwnerComponent().getModel("tableDelivReview");var r=o.getProperty("/FACNAV/Paginated/results");var l=r[i];var g="/FacrevnavSet?$expand=FACLOGNAV&$filter=IOption eq '2'";g+=" and IUuid eq '"+l.ZtfiglUuid+"'";if(a!=null&&a!=""){g+=" and ILifnr eq '"+a+"'"}var p=s.getJsonModel(g);var d=p.getProperty("/results/0");this.getOwnerComponent().setModel(new n(d),"tableDelivLog");console.log(p);if(d.FACLOGNAV.results.length>0){this._createDialog=sap.ui.xmlfragment("DelivLogFragment","demo.views.DeliveryReview.fragments.DelivLogFragment",this);this.getView().addDependent(this._createDialog);this._createDialog.open()}else{sap.m.MessageBox.error(response.EMessage)}},onCancel:function(){if(this._createDialog){this._createDialog.close();this._createDialog.destroy();this._createDialog=undefined}},clearFilters:function(){this.getView().byId("dateRange").setValue("");this.getView().byId("folioRecibo").setValue("");this.getView().byId("fact").setValue("");this.getView().byId("xblnr").setValue("");this.getView().byId("conta").setSelected(false)},buildExportTable:function(){var e=this.getOwnerComponent().getModel("appTxts");var t=[{name:e.getProperty("/invoice.invoicesheet"),template:{content:"{Xblnr}"}},{name:e.getProperty("/invoice.ffactura"),template:{content:"{Belnr}"}},{name:e.getProperty("/invoice.invoicedate"),template:{content:"{Bldat}"}},{name:e.getProperty("/global.year"),template:{content:"{Gjahr}"}},{name:e.getProperty("/invoice.amount"),template:{content:"{Rmwwr}"}},{name:e.getProperty("/global.currencyUC"),template:{content:"{Waers}"}},{name:e.getProperty("/invoice.uuid"),template:{content:"{ZtfiglUuid}"}},{name:e.getProperty("/invoice.order"),template:{content:"{Ebeln}"}},{name:e.getProperty("/invoice.receiptsheet"),template:{content:"{Sgtxt}"}},{name:e.getProperty("/invoice.status"),template:{content:"{Descripcion4}"}}];this.exportxls("tableDelivReview","/FACNAV/results",t)},createLogExcel:function(){var e=this.getConfigModel().getProperty("/supplierInputKey");var t=this.getView().byId("dateRange");var i=this.buildSapDate(t.getDateValue());var a=this.buildSapDate(t.getSecondDateValue());var o="/FacrevnavSet?$expand=FACLOGNAV&$filter=IOption eq '2'";if(e!=null&&e!=""){o+=" and ILifnr eq '"+e+"'"}if(i!=""&&a!=""){o+=" and IFini eq '"+i+"' and IFfin eq '"+a+"'"}var r=s.getJsonModel(o);var l=r.getProperty("/results/0");this.getOwnerComponent().setModel(new n(l),"tableDelivLog");console.log(r);var g=this.getOwnerComponent().getModel("appTxts");var p=[{name:g.getProperty("/invoice.uuid"),template:{content:"{Uuid}"}},{name:g.getProperty("/invoice.vendor"),template:{content:"{Proveedor}"}},{name:g.getProperty("/invoice.folio"),template:{content:"{FolioId}"}},{name:g.getProperty("/invoice.date"),template:{content:"{Fecha}"}},{name:g.getProperty("/invoice.hour"),template:{content:"{Hora}"}},{name:g.getProperty("/invoice.desc1"),template:{content:"{Descripcion1}"}},{name:g.getProperty("/invoice.status"),template:{content:"{Descripcion4}"}}];this.exportxls("tableDelivLog","/FACLOGNAV/results",p)}})});