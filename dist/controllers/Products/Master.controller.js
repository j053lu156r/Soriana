sap.ui.define(["demo/controllers/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","demo/models/formatterCatPrd","sap/ui/core/BusyIndicator"],function(e,t,o,a,s,r,i,n){"use strict";var l="/sap/opu/odata/sap/ZOSP_CATPRO_SRV/";var d="ZOSP_CATPRO_SRV";var g="HdrcatproSet";var u=new Productos;var p=new NotifAltaMasiva;const c=["1A","1B"];var h=false;var m=false;var y={};var f={};var C=document.location.hostname.slice(-4)==".sap";return e.extend("demo.controllers.Products.Master",{formatterCatPrd:i,onInit:function(){this.getView().addEventDelegate({onBeforeShow:function(e){this.getOwnerComponent().setModel(new t,"Paises");this.getOwnerComponent().setModel(new t,"Catalogos");this.getOwnerComponent().setModel(new t,"Folios");this.getOwnerComponent().setModel(new t,"Folio");this.getOwnerComponent().setModel(new t({value:C,gs1Finded:true}),"ValidBarCode");this.getOwnerComponent().setModel(new t({items:[]}),"FolioImages");this.getOwnerComponent().setModel(new t,"FolioToShow");this.getOwnerComponent().setModel(new t,"ITARTVAR");this.getOwnerComponent().getModel("ITARTVAR").setProperty("/results",[]);this.getCatalogos();this.clearFilters();this.setInitialDates();this.loadEstatusCatalog()}},this);this.configFilterLanguage(this.getView().byId("filterBar"));this.setInitialDates()},async getGS1ProductData(){let e="7504001437009";let t=this.getView().byId("barCode").getValue();await fetch(`https://compuarte.serv.net.mx:4000/searchbygtin?codigo_barras=${t}&gln=${e}`).then(async e=>{let t=await e.json();if(!e.ok)throw new Error(t.error.message);this.fillFolioModelData(t);this.byId("barCode").setEditable(false||C);a.success("Producto Encontrado en GS1",{onClose:()=>{this.getView().byId("barCode").setValueState(sap.ui.core.ValueState.Success)}})}).catch(e=>{console.error(" >>>>>>>>>>>> ERROR FETCH GS1 ",e);a.warning(e.message,{onClose:()=>{this.getView().byId("barCode").setValueState(sap.ui.core.ValueState.Warning)}})})},fillFolioModelData(e){this.byId("description").setValue(e.DescripcionCorta);let t=i.findPropertieValue("Eland","Land1",e.RefPaisOrigen,JSON.parse(this.getOwnerComponent().getModel("Paises").getJSON()));this.byId("country").setSelectedKey(t);this.byId("content").setValue(e.ContenidoNeto);let o=i.findPropertieValue("IsoCode","Cveunm",e.UnidContenidoNeto,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadMedida"));this.byId("contentUnit").setSelectedKey(o);let a=this.recalcularValoresDimensiones(e);console.log("Dimenciones Validas",a);this.byId("EcAlto").setValue(a.Alto);this.byId("EcAncho").setValue(a.Ancho);this.byId("EcProfundo").setValue(a.Profundo);this.byId("EcAlto").fireLiveChange();this.byId("EcUndaap").setSelectedKey(a.UnidadLon);this.byId("EcPbruto").setValue(e.PesoBruto);this.byId("EcPneto").setValue(e.PesoNeto);this.byId("EcUndp").setSelectedKey(a.UnidadWeg);this.getOwnerComponent().getModel("ValidBarCode").setProperty("/gs1Finded",false)},recalcularValoresDimensiones(e){let t=i.findPropertieValue("IsoCode","Cveunm",e.UnidAncho,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadLongitud"));let o=i.findPropertieValue("IsoCode","Cveunm",e.UnidPesoBruto,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadPeso"));let a=e.Alto;let s=e.Ancho;let r=e.Profundo;let n=a*s*r;while(a>9999.99||s>9999.99||r>9999.99||n>9999.99){console.log(" Volumen invalido: ",n);a/=10;s/=10;r/=10;n=a*s*r;t=this.getUnidadDimensiones(t)}return{Alto:a,Ancho:s,Profundo:r,UnidadLon:t,UnidadWeg:o}},getUnidadDimensiones(e){let t=this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadLongitud");let o=t.results.findIndex(t=>t.Cveunm==e);e=t.results[o+1].Cveunm;return e},setInitialDates(){let e=this.getView().byId("dateRange");let t=new Date;let o=new Date(t.getFullYear(),t.getMonth(),1);let a=new Date(t.getFullYear(),t.getMonth()+1,0);e.setDateValue(o);e.setSecondDateValue(a)},getCatalogos:function(){try{var e=`/HdrcatproSet?$expand=ETTART,ETCOUNTRYNAV,ETCODENAV,ETBRANDSNAV,ETTCARCV,ETUWEIG,ETULONG,ETUVOL,ETUNM,ETLABEL,ETFORMAT,ETOUTSTRAT,ETBONUS&$filter=IOption eq '4'`;u.getJsonModelAsync(e,function(e,o){let a=[];const s=e.getProperty("/results/0/ETCOUNTRYNAV/results");for(let e=0;e<s.length;e++){a.push(s[e])}o.getOwnerComponent().getModel("Catalogos").setProperty("/TiposProducto",e.getProperty("/results/0/ETTART"));o.getOwnerComponent().getModel("Catalogos").setProperty("/TipoCodigo",e.getProperty("/results/0/ETCODENAV"));o.getOwnerComponent().getModel("Catalogos").setProperty("/UnidadMedida",e.getProperty("/results/0/ETUNM"));o.getOwnerComponent().getModel("Catalogos").setProperty("/UnidadLongitud",e.getProperty("/results/0/ETULONG"));o.getOwnerComponent().getModel("Catalogos").setProperty("/UnidadVolumen",e.getProperty("/results/0/ETUVOL"));o.getOwnerComponent().getModel("Catalogos").setProperty("/UnidadPeso",e.getProperty("/results/0/ETUWEIG"));o.getOwnerComponent().getModel("Catalogos").setProperty("/Caracteristicas",e.getProperty("/results/0/ETTCARCV"));o.getOwnerComponent().getModel("Catalogos").setProperty("/NegotiatedFormat",e.getProperty("/results/0/ETFORMAT"));o.getOwnerComponent().getModel("Catalogos").setProperty("/TiposEtiqueta",e.getProperty("/results/0/ETLABEL"));o.getOwnerComponent().getModel("Catalogos").setProperty("/EstrategiaSalida",e.getProperty("/results/0/ETOUTSTRAT"));o.getOwnerComponent().getModel("Catalogos").setProperty("/TiposBonificacion",e.getProperty("/results/0/ETBONUS"));var r={results:a};o.getOwnerComponent().setModel(new t(r),"Paises");o.getOwnerComponent().getModel("Paises").setSizeLimit(parseInt(a.length,10))},function(){sap.m.MessageBox.error("No se lograron obtener los datos del proveedor registrado en GS1.")},this);var e=`HdrcatproSet?$expand=ETPRES&$filter=IOption eq '10'`;u.getJsonModelAsync(e,function(e,t){t.getOwnerComponent().getModel("Catalogos").setProperty("/Presentaciones",e.getProperty("/results/0/ETPRES"))},function(){sap.m.MessageBox.error("No se lograron obtener los datos del proveedor registrado en GS1.")},this);let o=`HdrcatproSet?$expand=ETJERARQUIANAV&$filter=IOption eq '21'`;u.getJsonModelAsync(o,function(e,t){t.getOwnerComponent().getModel("Catalogos").setProperty("/Divisiones",e.getProperty("/results/0/ETJERARQUIANAV"))},function(){sap.m.MessageBox.error("No se lograron obtener las divisiones")},this)}catch(e){console.error(" Get Catalogos Error ",e)}},addAttachChangeTxt:function(e){let o=this.getView().getModel("ETMODIFY");if(o){o.setProperty("/Paginated/results",[]);o.setProperty("/results",[])}var a=e.getParameters().files;var s=a[0];var r=this;var i=new FileReader;i.onload=function(e){let o={};o.IText64=e.target.result;let a={attach:[]};r.getOwnerComponent().setModel(new t(a),"LETTERx64");a.attach.push(o);r.getOwnerComponent().setModel(new t(a),"ITEXT64")};i.readAsDataURL(s)},addAttachLetter(e){let o=e.getParameters().files;let a=o[0];let s=this;var r=new FileReader;r.onload=function(e){let o={};o.IText64=e.target.result;let a={attach:[]};a.attach.push(o);s.getOwnerComponent().setModel(new t(a),"LETTERx64")};r.readAsDataURL(a)},addAttachDelete:function(e){let o=this.getView().getModel("ETDELETE");if(o){o.setProperty("/Paginated/results",[]);o.setProperty("/results",[])}var a=e.getParameters().files;var s=a[0];var r=this;var i=new FileReader;i.onload=function(e){let o={};o.IText64=e.target.result;let a={attach:[]};a.attach.push(o);r.getOwnerComponent().setModel(new t(a),"ITEXT64Delete")};i.readAsDataURL(s)},async handleUploadPressChangePrice(){let e=this.getOwnerComponent().getModel("ITEXT64").getProperty("/attach");if(e.length==1){let o={IOption:"16",ITEXT64:[...e],ETMODIFY:[{OrgCompras:"",Centro:"",Codigoean:"",Descrip:"",Costobant:"",Costobnuevo:"",Konwa:"",Adver:""}]};sap.ui.core.BusyIndicator.show();let s=null;let r={"X-Requested-With":"X","Content-Type":"application/json;charset=utf-8",Accept:"application/json, text/javascript, */*;q=0.01"};await this._PostODataV2Async(d,g,o,r).then(e=>{s=e.d;sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.log(e)});if(s!=null){if(s.ESuccess=="X"){if(s.ETMODIFY.results.length>0){const e=parseInt(s.ETMODIFY.results.length,10);const o=[];for(let e=0;e<s.ETMODIFY.results.length;e++){const t=s.ETMODIFY.results[e];if(t.Adver==="")o.push(s.ETMODIFY.results[e])}s.ETMODIFY.results=o;const r=o.length===0?"El archivo cargado no tiene registros válidos.":`Se encontraron ${o.length} coincidencias de los ${e} registros que contenía el archivo cargado.`;a.information(r);this.getOwnerComponent().setModel(new t(s.ETMODIFY),"ETMODIFY");this.paginate("ETMODIFY","",1,0);let i=this.getOwnerComponent().getModel("ETMODIFY").getData();this.getView().setModel(new t(i),"ETMODIFY");this.byId("fileUploaderChangeCost").clear()}else a.warning("No se encontraron folios en el archivo cargado")}else{let e=s.EMessage;sap.m.MessageBox.error(e)}}else{a.error("No se pudo conectar con el servidor, intente nuevamente.")}}else a.warning("No se ha seleccionado ningún archivo para subir.")},async handleUploadPressDelete(){let e=this.getOwnerComponent().getModel("ITEXT64Delete").getProperty("/attach");if(e.length==1){let o={IOption:"13",ITEXT64:[...e],ETDELETE:[{EanUpcBase:"",HazardDescript:"",FechSumhasta:"",MotBaja:"",Comet:"",Advertencia:""}]};sap.ui.core.BusyIndicator.show();let s=null;await this._PostODataV2Async(d,g,o).then(e=>{s=e.d;sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.log(e)});if(s!=null){if(s.ESuccess=="X"){if(s.ETDELETE.results.length>0){const e=parseInt(s.ETDELETE.results.length,10);const o=new Date;const r=o.getFullYear()+"-"+String("0"+(o.getMonth()+1)).substr(-2)+"-"+String("0"+o.getDate()).substr(-2);const i=[];for(let e=0;e<s.ETDELETE.results.length;e++){const t=s.ETDELETE.results[e];if(t.Advertencia==="")i.push(s.ETDELETE.results[e])}for(let e=0;e<i.length;e++){const t=i[e];i[e].FechSumhasta=String(r)}s.ETDELETE.results=i;const n=i.length===0?"El archivo cargado no tiene registros válidos.":`Se encontraron ${i.length} coincidencias de los ${e} registros que contenía el archivo cargado.`;a.information(n);this.getOwnerComponent().setModel(new t(s.ETDELETE),"ETDELETE");this.paginate("ETDELETE","",1,0);let l=this.getOwnerComponent().getModel("ETDELETE").getData();this.getView().setModel(new t(l),"ETDELETE");this.byId("fileUploaderDelete").clear()}else a.warning("No se encontraron folios en el archivo cargado")}else{let e=s.error.message.value;sap.m.MessageBox.error(e)}}else{sap.m.MessageBox.error("No se pudo conectar con el servidor, intente nuevamente.")}}else a.warning("No se ha seleccionado ningún archivo para subir.")},duplicarValorInicial:function(){let e=this;a.confirm("Desea asignar el valor de la primer fila a todos los registros existentes?",function(o){if(o===a.Action.OK){const o=e.getOwnerComponent().getModel("ETDELETE").getData();const a=o.results[0].FechSumhasta;const s=o.results[0].MotBaja;const r=o.results[0].Comet;for(let e=0;e<o.results.length;e++){o.results[e].FechSumhasta=a;o.results[e].MotBaja=s;o.results[e].Comet=r}e.getOwnerComponent().setModel(new t(o),"ETDELETE");e.paginate("ETDELETE","",1,0)}})},searchData:function(){if(!this.hasAccess(46)){return false}var e=this.getView().byId("dateRange");var o=this.getView().byId("inputFolioTxt");var a=this.getView().byId("cboxStatus");let s=o.getValue().trim();let r=this.getConfigModel().getProperty("/supplierInputKey")!=undefined?this.getConfigModel().getProperty("/supplierInputKey"):"";let i=this.buildSapDate(e.getDateValue());let n=this.buildSapDate(e.getSecondDateValue());if(r==""||s.trim()===""&&e.getValue()==""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/products.msgNoFilter"));return false}let l=[];if(a.getSelectedKey()!==""){l.push(new sap.ui.model.Filter("IScode",sap.ui.model.FilterOperator.EQ,a.getSelectedKey()))}l.push(new sap.ui.model.Filter({path:"IOption",operator:sap.ui.model.FilterOperator.EQ,value1:"2"}));if(s!=""){l.push(new sap.ui.model.Filter({path:"IUniqr",operator:sap.ui.model.FilterOperator.EQ,value1:s}))}else{l.push(new sap.ui.model.Filter({path:"ISdate",operator:sap.ui.model.FilterOperator.EQ,value1:i}));l.push(new sap.ui.model.Filter({path:"IFdate",operator:sap.ui.model.FilterOperator.EQ,value1:n}))}l.push(new sap.ui.model.Filter({path:"ILifnr",operator:sap.ui.model.FilterOperator.EQ,value1:r}));sap.ui.core.BusyIndicator.show();let u=this;this._GetODataV2(d,g,l,["ETPRICNAV"],"").then(e=>{console.log(" RESP : ",e.data);u.getOwnerComponent().setModel(new t(e.data.results[0]),"Folios");u.paginate("Folios","/ETPRICNAV",1,0);sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.error(e)})},clearFilters:function(){this.getView().byId("inputFolioTxt").setValue("");this.getView().byId("dateRange").setValue("")},paginar:function(e,t,o,a){let s=parseInt(this.getOwnerComponent().getModel(t).getProperty(`/${o}/results/length`),10);let r=parseInt(e.getKey(),10);let i=this.getView().byId(a);i.setVisibleRowCount(s<r?s:r);this.paginateValue(e,t,`/${o}`)},buildExportTable:function(){var e=this.getOwnerComponent().getModel("appTxts");var t=[{name:e.getProperty("/products.folioUPC"),template:{content:"{UniqueReference}"}},{name:e.getProperty("/products.productUPC"),template:{content:"{EanUpcBase}"}},{name:e.getProperty("/products.descriptionUPC"),template:{content:"{HazardDescript}"}},{name:e.getProperty("/products.typeUPC"),template:{content:"{Zzstatus}"}},{name:e.getProperty("/products.dateUPC"),template:{content:"{ValidityBase}"}},{name:e.getProperty("/products.dateStatusUPC"),template:{content:"{TakeOverDate}"}},{name:e.getProperty("/products.statusUPC"),template:{content:"{ProcStatus}"}},{name:e.getProperty("/products.descriptionStatusUPC"),template:{content:"{Pristate}"}},{name:e.getProperty("/products.maraStatus"),template:{content:"{MaraStatus}"}},{name:e.getProperty("/products.currentCost"),template:{content:"{CostoActual}"}},{name:e.getProperty("/products.capEmpaque"),template:{content:"{CapEmpaque}"}}];this.exportxls("Folios","/ETPRICNAV/results",t)},buildExportTableCostos(){let e=this.getOwnerComponent().getModel("appTxts");let t=[{label:e.getProperty("/products.organizePrice"),property:"OrgCompras"},{label:e.getProperty("/products.centerPrice"),property:"Centro"},{label:e.getProperty("/products.codePrice"),property:"Codigoean"},{label:e.getProperty("/products.descriptionPrice"),property:"Descrip"},{label:e.getProperty("/products.costPrice"),property:"Costobant"},{label:e.getProperty("/products.normalDiscount"),property:"DNormal"},{label:e.getProperty("/products.additionalDiscount"),property:"DAdicional"},{label:e.getProperty("/products.discountEarlyPay"),property:"DPronto"},{label:e.getProperty("/products.subtitleBonusType")+"(%)",property:"PDBonif"},{label:e.getProperty("/products.subtitleBonusType")+"($)",property:"PDBonif"},{label:e.getProperty("/products.CostDiff"),property:"PDifCos"},{label:e.getProperty("/products.CompCentral"),property:"PComCen"},{label:e.getProperty("/products.CargoCosto")+"(%)",property:"PCargoC"},{label:e.getProperty("/products.CargoCosto")+"($)",property:"MCargoC"}];let o=this.getOwnerComponent().getModel("ETMODIFY").getProperty("/Paginated/results");this.buildExcelSpreadSheet(t,o,"CostosActuales.xlsx")},massiveRegisterBatch:function(){if(!this.hasAccess(43)){return false}try{var e=this.getView();if(!this._mrDialog){this._mrDialog=o.load({id:e.getId(),name:"demo.views.Products.fragments.WizardMassiveRegisterBatch",controller:this}).then(function(o){o.attachAfterClose(()=>{this.getOwnerComponent().setModel(new t,"ETMODIFY");this.byId("fileUploaderMassiveReg").clear()},this);this.getOwnerComponent().setModel(new t,"ETMODIFY");e.addDependent(o);return o}.bind(this))}this._mrDialog.then(function(e){e.open()})}catch(e){sap.m.MessageBox.error("Ocurrió una excepción.");console.error(e)}},newProduct:function(){if(!this.hasAccess(42)){return false}try{var e=this.getView();if(this.getConfigModel().getProperty("/supplierInputKey")!=null&&this.getConfigModel().getProperty("/supplierInputKey")!=""){this.validateDataSupplier(this.getConfigModel().getProperty("/supplierInputKey"));if(!this._pDialog){this._pDialog=o.load({id:e.getId(),name:"demo.views.Products.fragments.WizardNewProduct",controller:this}).then(function(t){t.attachAfterOpen(this.onDialogAfterOpen,this);e.addDependent(t);e.byId("country").setFilterFunction(function(e,t){return t.getText().match(new RegExp(e,"i"))});return t}.bind(this))}this._pDialog.then(function(e){e.open()})}else sap.m.MessageBox.error("Debe selecionar un proveedor para continuar.")}catch(e){sap.m.MessageBox.error("Ocurrió una excepción al inicializar un nuevo folio.");console.error(e)}this.byId("codeType").setEditable(true)},changePriceProduct:function(){if(!this.hasAccess(43)){return false}try{var e=this.getView();if(!this._cpDialog){this._cpDialog=o.load({id:e.getId(),name:"demo.views.Products.fragments.WizardChangePriceProduct",controller:this}).then(function(o){o.attachAfterClose(()=>{this.getOwnerComponent().setModel(new t,"ETMODIFY");this.byId("fileUploaderChangeCost").clear()},this);this.getOwnerComponent().setModel(new t,"ETMODIFY");e.addDependent(o);return o}.bind(this))}this._cpDialog.then(function(e){e.open()})}catch(e){sap.m.MessageBox.error("Ocurrió una excepción al inicializar un nuevo folio.");console.error(e)}},deleteProducts:function(){if(!this.hasAccess(44)){return false}try{var e=this.getView();if(!this._dpDialog){this._dpDialog=o.load({id:e.getId(),name:"demo.views.Products.fragments.FragmentsDeleteProducts",controller:this}).then(function(o){o.attachAfterClose(()=>{this.getOwnerComponent().setModel(new t,"ETDELETE");this.byId("fileUploaderDelete").clear()},this);this.getOwnerComponent().setModel(new t,"ETDELETE");e.addDependent(o);return o}.bind(this))}this._dpDialog.then(function(e){e.open()})}catch(e){sap.m.MessageBox.error("Ocurrió una excepción al inicializar el proceso de baja.");console.error(e)}},validateDataSupplier:function(e){try{var t=`/HdrcatproSet?$expand=ETTART,ETCOUNTRYNAV,ETCODENAV,ETBRANDSNAV&$filter=IOption eq '8' and ILifnr eq '${e}'`;u.getJsonModelAsync(t,function(e,t){h=e.getProperty("/results/0/Esdprov/GnlSucces")==="X";m=e.getProperty("/results/0/Esexprov/Zexc")==="X";if(!h&&!m){a.error("El proveedor no se encuentra habilitado para alta de productos.",{onClose:function(){t.getView().byId("wizardDialog").close()}})}t.byId("btnValidateDataSupplierGS1").setEnabled(h);let o=e.getProperty("/results/0/Esdprov/Gnl");let s=e.getProperty("/results/0/Esdprov/Land1");let r=e.getProperty("/results/0/Esdprov/Landx50");t.getView().byId("codeGS1").setValue(o)},function(){a.error("No se lograron obtener los datos del proveedor registrado en GS1.")},this)}catch(e){a.error("No se lograron obtener los datos del proveedor registrado en GS1.");console.warn(e)}},validateBarCodeLength(e){let t=e.getParameter("value");if(!t||t.length!=y.length){this.byId("codeType").setEditable(true);e.getSource().setValueState(sap.ui.core.ValueState.Error);e.getSource().setValueStateText("Codigo Invalido. Longitud Requrida: "+y.length)}else{e.getSource().setValueState(sap.ui.core.ValueState.None);this.byId("codeType").setEditable(false)}},validateCstBrutNuevo(e){let t=e.getParameter("value");let o=e.getSource().data("cba");let a=e.getSource().data("ean");let s=t.split(".");if(s.length>1||parseFloat(o)*2<parseFloat(t)){if(s[1].length>2){e.getSource().setValueState(sap.ui.core.ValueState.Warning);e.getSource().setValueStateText("Maximo 2 decimales");f.valid=false;f.identifier=a}else if(parseFloat(o)*2<parseFloat(t)){e.getSource().setValueState(sap.ui.core.ValueState.Warning);e.getSource().setValueStateText("No puede haber un incremento del 100% del costo bruto actual!");f.valid=false;f.identifier=a}else{e.getSource().setValueState(sap.ui.core.ValueState.None);if(!f.valid&&f.identifier==a){f.valid=true;f.identifier=null}}}this.byId("btnSaveChangePriceRow").setEnabled(f.valid)},validateBarCode:function(){const e=this.getOwnerComponent().getModel("Folio");if(e.getProperty("/CodEan")==undefined||e.getProperty("/CodEan").trim()==""){this.getView().byId("barCode").setValueState(sap.ui.core.ValueState.Error);return false}else this.getView().byId("barCode").setValueState(sap.ui.core.ValueState.None);const t=e.getProperty("/CodEan").trim();const o=`/HdrcatproSet?$expand=ETUWEIG,ETULONG,ETUVOL,ETUNM&$filter=IOption eq '7' and IEanv  eq '${t}' and IEantp eq '${y.type}'`;var s=u.getJsonModel(o);if(s.getProperty("/results/0/ESuccess")==="X"){a.success("Artículo apto para registro.",{onClose:()=>{this.getView().byId("barCode").setValueState(sap.ui.core.ValueState.Success);this.getOwnerComponent().getModel("ValidBarCode").setProperty("/value",true)}})}else{a.error("Este artículo ya se encuentra registrado.",{onClose:()=>{this.getView().byId("barCode").setValueState(sap.ui.core.ValueState.Warning)}})}},onDialogAfterOpen:function(){this._oWizard=this.byId("CreateProductWizard");this.handleButtonsVisibility()},onDialogDeleteOpen:function(){this._oWizard=this.byId("DeleteProductsWizard");this.handleButtonsVisibility()},onDialogNextButton:function(){this._oWizard.getProgressStep().fireComplete();if(this._oWizard.getProgressStep().getValidated()){this._oWizard.nextStep()}this.handleButtonsVisibility()},closeDialog:function(e){let o=new t({});if(this.byId("fileUploaderChangeCost")){o=this.getView().getModel("ETMODIFY");this.byId("fileUploaderChangeCost").clear()}if(this.byId("fileUploaderDelete")){o=this.getView().getModel("ETDELETE");this.byId("fileUploaderDelete").clear()}if(o){o.setProperty("/Paginated/results",[]);o.setProperty("/results",[])}if(this.byId("fileUploaderMassiveReg")){this.byId("fileUploaderMassiveReg").clear();this.byId("correoInput").setValue("");this.validateMassiveInfo();this.massiveFile64={}}this.byId(e).close()},onDialogBackButton:function(){const e=this._oWizard.previousStep().getCurrentStep();const t=e.split("--")[1];this.byId(t).setValidated(false);this.handleButtonsVisibility()},handleWizardSubmit:function(){this._handleMessageBoxOpen(this.getOwnerComponent().getModel("appTxts").getProperty("/products.msgSubmitNewProduct"),"confirm")},handleButtonsVisibility:function(e){let t=e?e:this._oWizard.getProgress();var o=this.getView().getModel();o.setProperty("/checkConfirmation",false);o.setProperty("/finishButtonVisible",false);o.setProperty("/nextButtonVisible",true);o.setProperty("/reviewButtonVisible",false);switch(t){case 1:o.setProperty("/nextButtonEnabled",true);o.setProperty("/backButtonVisible",false);break;case 2:case 3:case 4:case 5:case 6:o.setProperty("/backButtonVisible",true);break;case 7:o.setProperty("/nextButtonVisible",false);o.setProperty("/reviewButtonVisible",true);break;case 8:o.setProperty("/nextButtonVisible",false);o.setProperty("/checkConfirmation",true);o.setProperty("/finishButtonVisible",true);o.setProperty("/backButtonVisible",true);o.setProperty("/reviewButtonVisible",false);this.cloneFolioModel();let e=this._oWizard.getProgressStep();this._oWizard.goToStep(e);break;default:break}},handleWizardCancel:function(){this._handleMessageBoxOpen(this.getOwnerComponent().getModel("appTxts").getProperty("/products.msgCancelNewProduct"),"warning")},async _handleMessageBoxOpen(e,t){a[t](e,{actions:[a.Action.YES,a.Action.NO],onClose:async function(e){if(e===a.Action.YES){if(t=="confirm"){let e=[];let t=JSON.parse(this.getView().getModel("ITARTVAR").getJSON()).results;let o=JSON.parse(this.getOwnerComponent().getModel("Folio").getJSON());o.TMoneda="MXN";o.Lifnr=this.getConfigModel().getProperty("/supplierInputKey");o.EanUpcBase=o.CodEan;let s={IOption:"5",ITREC:[o],ITARTVAR:[...t],ITIMGART:[...e]};sap.ui.core.BusyIndicator.show();let r=null;await this._PostODataV2Async(d,g,s).then(e=>{r=e.d;sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.log(e)});if(r.ESuccess){a.success(r.EMessage);let e=this;setTimeout(function(){e.clearFormFolioAlta()},3e3)}else{a.error(r.mensaje)}}else{this.clearFormFolioAlta()}}}.bind(this)})},clearFormFolioAlta(){this._oWizard.discardProgress(this._oWizard.getSteps()[0]);this.byId("wizardDialog").close();this.getOwnerComponent().getModel("Folio").setData({});this.getOwnerComponent().getModel("FolioToShow").setData({});this.getOwnerComponent().getModel("FolioImages").setData({});this.getOwnerComponent().getModel("ValidBarCode").setProperty("/value",false);this.getOwnerComponent().getModel("ValidBarCode").setProperty("/gs1Finded",true);this.byId("ComboDivision").setValue("");this.resetSalesHierarchy();this.byId("barCode").setEditable(false)},selectAgree(e){let t=e.getParameter("selected");this.byId("FinishBtn").setEnabled(t)},cloneFolioModel(){let e=JSON.parse(this.getOwnerComponent().getModel("Folio").getJSON());e.TipEtq=i.findPropertieValue("Labelkey","Descr",e.TipEtq,this.getOwnerComponent().getModel("Catalogos").getProperty("/TiposEtiqueta"));e.EstSalida=i.findPropertieValue("Strategykey","Descr",e.EstSalida,this.getOwnerComponent().getModel("Catalogos").getProperty("/EstrategiaSalida"));e.ForNegoc=i.findPropertieValue("Formatkey","Descr",e.ForNegoc,this.getOwnerComponent().getModel("Catalogos").getProperty("/NegotiatedFormat"));e.EcUndaap=i.findPropertieValue("IsoCode","Unidad",e.EcUndaap,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadLongitud"));e.EcUndvol=i.findPropertieValue("IsoCode","Unidad",e.EcUndvol,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadVolumen"));e.EcUndp=i.findPropertieValue("IsoCode","Unidad",e.EcUndp,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadPeso"));e.PvUndaap=i.findPropertieValue("IsoCode","Unidad",e.PvUndaap,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadLongitud"));e.PvUndvol=i.findPropertieValue("IsoCode","Unidad",e.PvUndvol,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadVolumen"));e.PvUndp=i.findPropertieValue("IsoCode","Unidad",e.PvUndp,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadPeso"));e.Pais=i.findPropertieValue("Land1","Landx50",e.Pais,JSON.parse(this.getOwnerComponent().getModel("Paises").getJSON()));e.Marca=i.findPropertieValue("BrandId","Brand",e.Marca,JSON.parse(this.getOwnerComponent().getModel("Brands").getJSON()));e.TipArt=i.findPropertieValue("Mtart","Mtbez",e.TipArt,this.getOwnerComponent().getModel("Catalogos").getProperty("/TiposProducto"));e.EanUpcType=i.findPropertieValue("Numtp","Ntbez",e.EanUpcType,this.getOwnerComponent().getModel("Catalogos").getProperty("/TipoCodigo"));e.GrupArt=i.findPropertieValue("GrupoArt","DescGart",e.GrupArt,this.getOwnerComponent().getModel("Catalogos").getProperty("/GrupoArticulos"));e.Present=i.findPropertieValue("IsoCode","Descpres",e.Present,this.getOwnerComponent().getModel("Catalogos").getProperty("/Presentaciones"));e.UndCont=i.findPropertieValue("IsoCode","Unidad",e.UndCont,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadMedida"));e.UndMventa=i.findPropertieValue("IsoCode","Unidad",e.UndMventa,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadMedida"));e.UndCompra=i.findPropertieValue("IsoCode","Unidad",e.UndCompra,this.getOwnerComponent().getModel("Catalogos").getProperty("/UnidadMedida"));e.UndBon=i.findPropertieValue("Bonuskey","Descr",e.UndBon,this.getOwnerComponent().getModel("Catalogos").getProperty("/TiposBonificacion"));e.Jerarquia=i.findPropertieValue("Nodo","Denominacion",e.Jerarquia,this.getOwnerComponent().getModel("Catalogos").getProperty("/SubSegmento"));e.PurGroup=i.findPropertieValue("Ekgrp","Eknam",e.PurGroup,this.getOwnerComponent().getModel("Catalogos").getProperty("/GrupoCompras"));this.getOwnerComponent().getModel("FolioToShow").setData({...e})},productTypeComplete:function(e){let t=true;const o=this.getOwnerComponent().getModel("Folio");if(o.getProperty("/CodEan")==undefined||o.getProperty("/CodEan").trim()==""){t=false;this.getView().byId("barCode").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("barCode").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/ProdBase")==undefined||o.getProperty("/ProdBase").trim()==""){t=false;this.getView().byId("baseProduct").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("baseProduct").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/TipArt")==undefined||o.getProperty("/TipArt").trim()==""){t=false;this.getView().byId("productType").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("productType").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/Marca")==undefined||o.getProperty("/Marca").trim()==""){t=false;this.getView().byId("brand").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("brand").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/EanUpcType")==undefined||o.getProperty("/EanUpcType").trim()==""){t=false;this.getView().byId("codeType").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("codeType").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/Pais")==undefined||o.getProperty("/Pais").trim()==""){t=false;this.getView().byId("country").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("country").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/DescrArt")==undefined||o.getProperty("/DescrArt").trim()==""){t=false;this.getView().byId("description").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("description").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/EstSalida")==undefined||o.getProperty("/EstSalida").trim()==""){t=false;this.getView().byId("exitStrategy").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("exitStrategy").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/ForNegoc")==undefined||o.getProperty("/ForNegoc").trim()==""){t=false;this.getView().byId("negotiatedFormat").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("negotiatedFormat").setValueState(sap.ui.core.ValueState.None)}this.getView().byId("ProductTypeStep").setValidated(t||C)},validateSalesHierarchy(){let e=true;if(this.byId("ComboSubSegmento").getValue()==undefined||this.byId("ComboSubSegmento").getValue().trim()==""){e=false}if(!e){sap.m.MessageBox.warning("Capture correcatamente hasta llegar a Sub Segmento.")}this.getView().byId("SalesHierarchyStep").setValidated(e||C)},activateProductPresentation:function(){let e=true;let t=false;const o=this.getOwnerComponent().getModel("Folio");if(o.getProperty("/Present")==undefined||o.getProperty("/Present").trim()==""){e=false;this.getView().byId("presentation").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("presentation").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/Contenido")==undefined||o.getProperty("/Contenido").trim()==""){e=false;this.getView().byId("content").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("content").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/UndCont")==undefined||o.getProperty("/UndCont").trim()==""){e=false;this.getView().byId("contentUnit").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("contentUnit").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/UndMventa")==undefined||o.getProperty("/UndMventa").trim()==""){e=false;this.getView().byId("salesUnit").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("salesUnit").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/UndCompra")==undefined||o.getProperty("/UndCompra").trim()==""){e=false;this.getView().byId("purchaseUnit").setValueState(sap.ui.core.ValueState.Error)}else{this.getView().byId("purchaseUnit").setValueState(sap.ui.core.ValueState.None)}if(o.getProperty("/CapEmpaq")==undefined||o.getProperty("/CapEmpaq").trim()==""||o.getProperty("/CapEmpaq").trim().length>5){e=false;this.getView().byId("boardingCapacity").setValueState(sap.ui.core.ValueState.Error);if(o.getProperty("/CapEmpaq").trim().length>5)this.getView().byId("boardingCapacity").setValueStateText("Este campo es obligatorio y deben ser maximo 5 caracteres")}else{this.getView().byId("boardingCapacity").setValueState(sap.ui.core.ValueState.None)}t=this.getView().byId("variants").getSelected();if(t&&this.getView().byId("characteristic").getValue()==""){e=false;this.getView().byId("characteristic").setValueState(sap.ui.core.ValueState.Error)}else this.getView().byId("characteristic").setValueState(sap.ui.core.ValueState.None);if(e&&t){this.getTallasColores()}else if(e&&!t){this.getView().byId("VariantStep").setValidated(true);this.getView().byId("ProductPresentation").setNextStep(this.getView().byId("DimensionsStep"))}this.getView().byId("newVariant").setVisible(t).setEnabled(t);this.getView().byId("ProductPresentation").setValidated(e||C)},completeValidateVariantStep:function(){let e=true;const t=this.getView().getModel("ITARTVAR").getProperty("/results");for(let o=0;o<t.length;o++){const a=t[o];if(a.Proporcion==undefined||a.Proporcion.trim()==""){e=false}if(a.CodCompra==undefined||a.CodCompra.trim()==""){e=false}if(a.CodVent==undefined||a.CodVent.trim()==""){e=false}if(a.CaracTalla==undefined||a.CaracTalla.trim()==""){e=false}if(a.Colsabaro==undefined||a.Colsabaro.trim()==""){e=false}}if(!e){sap.m.MessageBox.warning("Existen datos faltantes de captura de las variantes.")}this.getView().byId("VariantStep").setValidated(e||C)},calcularECVolumen:function(e){let t=e.getSource().getId().split("--")[1];let o=parseFloat(e.getSource().getValue());if(o<1e4){this.getView().byId(t).setValueState(sap.ui.core.ValueState.Success);let e=this.byId("EcAlto").getValue()?parseFloat(this.byId("EcAlto").getValue()):0;let o=this.byId("EcAncho").getValue()?parseFloat(this.byId("EcAncho").getValue()):0;let a=this.byId("EcProfundo").getValue()?parseFloat(this.byId("EcProfundo").getValue()):0;let s=e*o*a;this.byId("EcVolumen").setValue(s);if(s<1e4){this.getView().byId("EcVolumen").setValueState(sap.ui.core.ValueState.Success)}else{sap.m.MessageBox.warning("El valor del volumen ser menor a 10000 tu resultado es : "+s)}}else{this.getView().byId(t).setValueState(sap.ui.core.ValueState.Error);this.getView().byId(t).setValueStateText("El valor debe ser menor a 10000")}},calcularPvVolumen:function(e){let t=e.getSource().getId().split("--")[1];let o=parseFloat(e.getSource().getValue());if(o<1e4){this.getView().byId(t).setValueState(sap.ui.core.ValueState.Success);let e=this.byId("PvAlto").getValue()?parseFloat(this.byId("PvAlto").getValue()):0;let o=this.byId("PvAncho").getValue()?parseFloat(this.byId("PvAncho").getValue()):0;let a=this.byId("PvProfundo").getValue()?parseFloat(this.byId("PvProfundo").getValue()):0;let s=e*o*a;this.byId("PvVolumen").setValue(s);if(s<1e4){this.getView().byId("PvVolumen").setValueState(sap.ui.core.ValueState.Success)}else{sap.m.MessageBox.warning("El valor del volumen ser menor a 10000 tu resultado es : "+s)}}else{this.getView().byId(t).setValueState(sap.ui.core.ValueState.Error);this.getView().byId(t).setValueStateText("El valor debe ser menor a 10000")}},validateCompleteStepDimensions:function(){let e=true;let t=JSON.parse(this.getOwnerComponent().getModel("Folio").getJSON());if(t.EcAlto==undefined||t.EcAlto.trim()==""||parseFloat(t.EcAlto.trim())>=1e4){e=false}if(t.EcAncho==undefined||t.EcAncho.trim()==""||parseFloat(t.EcAncho.trim())>=1e4){e=false}if(t.EcProfundo==undefined||t.EcProfundo.trim()==""||parseFloat(t.EcProfundo.trim())>=1e4){e=false}if(t.EcUndaap==undefined||t.EcUndaap.trim()==""){e=false}if(t.EcVolumen==undefined||t.EcVolumen.trim()==""||parseFloat(t.EcVolumen.trim())>=1e4){e=false}if(t.EcUndvol==undefined||t.EcUndvol.trim()==""){e=false}if(t.EcPbruto==undefined||t.EcPbruto.trim()==""){e=false}if(t.EcPneto==undefined||t.EcPneto.trim()==""){e=false}if(t.EcUndp==undefined||t.EcUndp.trim()==""){e=false}if(t.PvAlto==undefined||t.PvAlto.trim()==""||parseFloat(t.PvAlto.trim())>=1e4){e=false}if(t.PvAncho==undefined||t.PvAncho.trim()==""||parseFloat(t.PvAncho.trim())>=1e4){e=false}if(t.PvProfundo==undefined||t.PvProfundo.trim()==""||parseFloat(t.PvProfundo.trim())>=1e4){e=false}if(t.PvUndaap==undefined||t.PvUndaap.trim()==""){e=false}if(t.PvVolumen==undefined||t.PvVolumen.trim()==""||parseFloat(t.PvVolumen.trim())>=1e4){e=false}if(t.PvUndvol==undefined||t.PvUndvol.trim()==""){e=false}if(t.PvPbruto==undefined||t.PvPbruto.trim()==""){e=false}if(t.PvPneto==undefined||t.PvPneto.trim()==""){e=false}if(t.PvUndp==undefined||t.PvUndp.trim()==""){e=false}if(t.CodTarima==undefined||t.CodTarima.trim()==""){e=false}if(t.CajasTend==undefined||t.CajasTend.trim()==""){e=false}if(t.TendTarima==undefined||t.TendTarima.trim()==""){e=false}if(t.CajasTarima==undefined||t.CajasTarima.trim()==""){e=false}if(!e){sap.m.MessageBox.warning("Capture correctamente todos los campos.")}this.getView().byId("DimensionsStep").setValidated(e||C)},validateDiscounts:function(){let e=true;const t=JSON.parse(this.getOwnerComponent().getModel("Folio").getJSON());if(t.UndBon==undefined||t.UndBon.trim()=="")e=false;if(t.CostoB==undefined||t.CostoB.trim()=="")e=false;if(t.CostNUCompra==undefined||t.CostNUCompra.trim()=="")e=false;if(t.CostNUVenta==undefined||t.CostNUVenta.trim()=="")e=false;if(t.PSug==undefined||t.PSug.trim()=="")e=false;if(!e){sap.m.MessageBox.warning("Faltan datos por capturar")}this.getView().byId("Discounts").setValidated(e||C)},validarDescuentosDif(){let e=false;let t=this.byId("DscNormal").getValue()?this.byId("DscNormal").getValue()/100:0;let o=this.byId("DscNormal2").getValue()?this.byId("DscNormal2").getValue()/100:0;let a=this.byId("DscNormal3").getValue()?this.byId("DscNormal3").getValue()/100:0;e=t==0&&o==0&&a==0||(t!=o||(t==0||o==0))&&(t!=a||(t==0||a==0))&&(o!=a||(a==0||o==0));return e},async calcularCostNetCom(e){let t=sap.ui.core.ValueState.None;if(this.validarDescuentosDif()){let e=this.byId("CostoB").getValue()?this.byId("CostoB").getValue():0;let t=[];t.push(this.byId("DscNormal").getValue()?this.byId("DscNormal").getValue()/100:0);t.push(this.byId("DscNormal2").getValue()?this.byId("DscNormal2").getValue()/100:0);t.push(this.byId("DscNormal3").getValue()?this.byId("DscNormal3").getValue()/100:0);t.push(this.byId("DscAdicional").getValue()?this.byId("DscAdicional").getValue()/100:0);t.push(this.byId("DscPpago").getValue()?this.byId("DscPpago").getValue()/100:0);let o=e;await t.forEach(function(e){o-=o*e});this.byId("CostNetComp").setValue(o)}else{sap.m.MessageBox.warning("Los descuentos tienes que ser diferentes");this.byId("CostNetComp").setValue(null);t=sap.ui.core.ValueState.Error}this.byId("DscNormal").setValueState(t);this.byId("DscNormal2").setValueState(t);this.byId("DscNormal3").setValueState(t)},calcularCostNetVen:function(e){let t=this.byId("CostoB").getValue()?this.byId("CostoB").getValue():0;let o=this.byId("CapEmpaq2").getValue()&&this.byId("CapEmpaq2").getValue()>0?this.byId("CapEmpaq2").getValue():1;let a=parseFloat(t)/parseFloat(o);this.byId("CostNetVen").setValue(a);this.calcularCostNetCom(null)},changeGrupArt:function(e){let t=e.getParameter("selectedItem");if(!t)return;this.getOwnerComponent().getModel("FolioToShow").setProperty("/GrupoArt",t.getText());this.fetchProdBase_categroria(e)},getTallasColores:function(){},onSelectNegotiatedFormat:function(e){let t=e.getParameters().selectedIndex||0;this.getOwnerComponent().getModel("Folio").setProperty("/ForNegoc",c[t])},onBaseProductRequest:function(){var e=this.getView();if(!this._pSearchBaseProduct){this._pSearchBaseProduct=sap.ui.core.Fragment.load({id:e.getId(),name:"demo.views.Products.fragments.SearchBaseProduct",controller:this}).then(function(t){e.addDependent(t);return t})}this._pSearchBaseProduct.then(function(e){e.open()})},onBaseProductSearch:function(e){var o=e.getParameter("value");var a=u.getJsonModel(`/HdrcatproSet?$expand=ETPBASE&$filter=IOption eq '14' and IName eq '${o}'`);var s=a.getProperty("/results/0/ETPBASE");if(s!=null){this.getOwnerComponent().setModel(new t(s),"ProductosBase")}},onBaseProductClose:function(e){let t=e.getParameter("selectedContexts");let o=e.getParameter("selectedItem");o=t.find(e=>e.getObject().NumLinea==o.getDescription());if(!o){return}this.getOwnerComponent().getModel("Folio").setProperty("/ProdBase",o.getObject().DescLinea);this.getOwnerComponent().getModel("FolioToShow").setProperty("/ProdBase",o.getObject().DescLinea)},onBrandRequest:function(){var e=this.getView();if(!this._pSearchBrand){this._pSearchBrand=sap.ui.core.Fragment.load({id:e.getId(),name:"demo.views.Products.fragments.SearchBrand",controller:this}).then(function(t){e.addDependent(t);return t})}this._pSearchBrand.then(function(e){e.open()})},onBrandSearch:function(e){var o=e.getParameter("value");var a=u.getJsonModel(`/HdrcatproSet?$expand=ETBRANDSNAV&$filter=IOption eq '15' and IName eq '${o}'`);var s=a.getProperty("/results/0/ETBRANDSNAV");if(s!=null){this.getOwnerComponent().setModel(new t(s),"Brands")}},onBrandClose:function(e){var t=e.getParameter("selectedItem");if(!t){return}this.getOwnerComponent().getModel("Folio").setProperty("/Marca",t.getDescription());this.getOwnerComponent().getModel("FolioToShow").setProperty("/Marca",t.getTitle())},addOptionalInfo:function(){var e={Taltam:"",CaracCsa:"",CaracTalla:"",Colsabaro:"",CodVent:"",CodCompra:"",Proporcion:""};if(this.getView().getModel("ITARTVAR")!=null){if(this.getView().getModel("ITARTVAR").getProperty("/results")!=null){let o=this.getView().getModel("ITARTVAR").getData();o.results.push(e);this.getView().setModel(new t(o),"ITARTVAR")}else{var o={results:[]};o.results.push(e);this.getView().setModel(new t(o),"ITARTVAR")}}else{var o={results:[]};o.results.push(e);this.getView().setModel(new t(o),"ITARTVAR")}this.paginate("ITARTVAR","",1,0)},deleteRow:function(e,o){let a=this;var s=this.byId(e).getSelectedItems();if(s.length<1){sap.m.MessageBox.warning("No se a seleccionado ningún registro")}else{sap.m.MessageBox.confirm("¿Desea eliminar los registros?",function(){let e=a.getView().getModel(o).getData();for(let t=0;t<s.length;t++){e.results.splice(s[t].getBindingContextPath().split("/").pop(),1);if(e.Paginated){e.Paginated.results.splice(s[t].getBindingContextPath().split("/").pop(),1)}}a.getView().setModel(new t(e),o);a.paginate(o,"",1,0)})}},reordenarRows:function(e){let o=this.getView().getModel(e).getData();for(let e=0;e<o.results.length;e++)o.results[e].index=e+1;this.getView().setModel(new t(o),e)},async saveChangePrice(){let e=this;let t=this.getView().getModel("ETMODIFY").getProperty("/results");let o=this.getOwnerComponent().getModel("LETTERx64").getProperty("/attach");let s=this.byId("fileUploaderLetter").getValue();let r=this.byId("inputDestinatario").getValue();if(t.length>0&&r!=null&&r.trim()!=""&&o.length>0){a.confirm("Desea enviar los registros para cambio de precio?",async function(){for(let e=0;e<t.length;e++)delete t[e].index;let a={IOption:"11",IvString:o[0].IText64,IvFilename:s,ITRECIPIENT:[{Email:r}],ETMODIFY:[...t],ETDPRINT:[{Prinbr:"",EanUpcBase:"",HazardDescript:"",DesNormal:"",UndDn:"",CostBruto:"",UndCb:"",Zfechenv:"",Docnum:"",Adver:"",Error:""}]};sap.ui.core.BusyIndicator.show();let i=null;await e._PostODataV2Async(d,g,a).then(e=>{i=e.d;sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.log(e)});if(i!=null){if(i.ESuccess==="X"){const t="Se han generado correctamente la solicitud de cambio de costos.";sap.m.MessageBox.success(t,{actions:[sap.m.MessageBox.Action.CLOSE],emphasizedAction:sap.m.MessageBox.Action.CLOSE,onClose:function(e){this.closeDialog("changePriceDialog")}.bind(e)})}else{let e=i.EMessage;sap.m.MessageBox.error(e)}}else{sap.m.MessageBox.error("No se pudo conectar con el servidor, intente nuevamente.")}})}else a.warning("Debe capturar el destinatario y la carta compromiso. \r\n Y almenos un regsitro para el cambio de costo")},async saveDelete(){let e=this;const t=this.getView().getModel("ETDELETE").getProperty("/results");if(t==undefined){a.error("No existen registros cargados para enviar.");return false}if(!this.validateSaveDelete()){a.error("Existen registros con información faltante.");return false}if(t.length>0){a.confirm("Desea enviar los registros para baja de productos?",async function(o){if(o===a.Action.OK){let o={IOption:"12",ETDELETE:[...t],ETCERROR:[{Uniquer:"",Folio:"",Ean:"",Desccrip:"",DateApp:"",Error:""}]};sap.ui.core.BusyIndicator.show();let a=null;await e._PostODataV2Async(d,g,o).then(e=>{a=e.d;sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.log(e)});if(a!=null){if(a.ESuccess==="X"){sap.m.MessageBox.success("Se han generado correctamente las bajas.",{actions:[sap.m.MessageBox.Action.CLOSE],emphasizedAction:sap.m.MessageBox.Action.CLOSE,onClose:function(t){e.closeDialog("deleteProductsDialog")}.bind(this)})}else{let e=a.mensaje||a.EMessage;sap.m.MessageBox.error(e)}}else{sap.m.MessageBox.error("No se pudo conectar con el servidor, intente nuevamente.")}}})}else a.warning("No existen registros para baja de productos.")},validateSaveDelete:function(){let e=true;const t=this.getView().getModel("ETDELETE").getProperty("/results");for(let o=0;o<t.length;o++){const a=t[o];if(a.FechSumhasta==""||String(a.MotBaja).trim()==""||String(a.Comet).trim()==""){e=false;break}}return e},onValueCountryRequest:function(e){var t=e.getSource().getValue(),a=this.getView();if(!this._pValueCountryDialog){this._pValueCountryDialog=o.load({id:a.getId(),name:"demo.views.Products.fragments.ValueHelpCountry",controller:this}).then(function(e){a.addDependent(e);return e})}this._pValueCountryDialog.then(function(e){e.getBinding("items").filter([new s("Landx50",r.Contains,t)]);e.open(t)})},onValueHelpCountrySearch:function(e){var t=e.getParameter("value");var o=new s("Landx50",r.Contains,t);e.getSource().getBinding("items").filter([o])},onValueHelpCountryClose:function(e){var t,o=e.getParameter("selectedItem");e.getSource().getBinding("items").filter([]);if(!o){return}const a=o.getTitle();const s=o.getDescription();this.byId("country").setSelectedKey(s)},onSuggestionCountryItemSelected:function(e){var t=e.getParameter("selectedItem");var o=t?t.getKey():""},changeVariants:function(e){this.getView().byId("characteristicFormElement").setVisible(e.getParameters().selected);if(e.getParameters().selected){this.getView().byId("size").setEditable(false).setValue("");this.getView().byId("qualities").setEditable(false).setValue("")}else{this.getView().byId("size").setEditable(true);this.getView().byId("qualities").setEditable(true)}},async imageAfterAddedTriggered(e){let t=this.byId("ImageUploadSet").getItems().length;let o=e.getParameter("item");let a=o.getFileObject().size/1024;let s=URL.createObjectURL(o.getFileObject());let r=new Image;r.src=s;await r.decode();if(t<=4&&a<300&&r.height<1024&&r.width<1024){o.setUploadState(sap.m.UploadState.Complete);o.setUrl(s);o.setThumbnailUrl(s);this.byId("ImageUploadSet").addItem(o);this.getOwnerComponent().getModel("FolioImages").setProperty("/items",this.byId("ImageUploadSet").getItems());this.attachImagesToModel()}else if(a>300){sap.m.MessageBox.warning("Max size is 300 KB");this.byId("ImageUploadSet").removeItem(o)}else if(r.height>=1024||r.width>=1024){sap.m.MessageBox.warning("Max img dimensions are 1024x1024 pixels");this.byId("ImageUploadSet").removeItem(o)}else if(t>=4){sap.m.MessageBox.warning("Max 5 imgs");this.byId("ImageUploadSet").setUploadEnabled(false)}this.byId("imagesCounter").setText(this.byId("ImageUploadSet").getItems().length)},imageRemovedTriggered(e){let t=this.byId("ImageUploadSet").getItems().length;this.byId("imagesCounter").setText(t);this.getOwnerComponent().getModel("FolioImages").setProperty("/items",this.byId("ImageUploadSet").getItems());this.attachImagesToModel();if(t<=4){this.byId("ImageUploadSet").setUploadEnabled(true)}},attachImagesToModel(){let e=this.getOwnerComponent().getModel("FolioImages").getProperty("/items");let o=e.map(e=>{let t=new FileReader;let o=e.getFileObject();let a={};a.Zdescrip=o.name;a.Zdoctype=o.type;a.Zdocvalue64="base64";t.onload=function(e){a.Zdocvalue64=e.target.result};t.readAsDataURL(o);return a});this.getOwnerComponent().setModel(new t,"images64");this.getOwnerComponent().getModel("images64").setProperty("/attachArray",o)},changeTipoBonif(e){let t=e.getParameter("value");this.byId("ValBoni").setValue("0");this.byId("UnisBonif").setValue("0");switch(t){case"Ninguna":this.byId("ValBoni").setVisible(false);this.byId("UnisBonif").setVisible(false);break;case"Por Porcentaje":this.byId("ValBoni").setVisible(true);this.byId("UnisBonif").setVisible(false);this.byId("BonValue1").setVisible(true);this.byId("BonValue2").setVisible(true);this.byId("BonUnits1").setVisible(false);this.byId("BonUnits2").setVisible(false);break;case"Por Unidades":this.byId("ValBoni").setVisible(false);this.byId("UnisBonif").setVisible(true);this.byId("BonValue1").setVisible(false);this.byId("BonValue2").setVisible(false);this.byId("BonUnits1").setVisible(true);this.byId("BonUnits2").setVisible(true);break}},changePrecioSugerido(e){let t=e.getParameter("value");if(t=="Farmacia Soriana"){this.byId("MaxPubPrice").setVisible(true);this.byId("PSug").setVisible(false);this.byId("MaxPubPrice1").setVisible(true);this.byId("PSug1").setVisible(false);this.byId("MaxPubPrice2").setVisible(true);this.byId("PSug2").setVisible(false)}else{this.byId("PSug").setVisible(true);this.byId("MaxPubPrice").setVisible(false);this.byId("PSug1").setVisible(true);this.byId("MaxPubPrice1").setVisible(false);this.byId("PSug2").setVisible(true);this.byId("MaxPubPrice2").setVisible(false)}},hardStepChange(e){let t=this._oWizard.indexOfStep(e.getParameter("step"));this.cloneFolioModel();this.handleButtonsVisibility(t+1)},resetSalesHierarchy(){this.getOwnerComponent().getModel("Catalogos").setProperty("/GerenCategoria",{});this.byId("ComboCatMgmt").setEditable(false);this.byId("ComboCatMgmt").setValue("");this.getOwnerComponent().getModel("Catalogos").setProperty("/Categoria",{});this.byId("ComboCategory").setEditable(false);this.byId("ComboCategory").setValue("");this.getOwnerComponent().getModel("Catalogos").setProperty("/SubCategoria",{});this.byId("ComboSubCategory").setEditable(false);this.byId("ComboSubCategory").setValue("");this.getOwnerComponent().getModel("Catalogos").setProperty("/Segmento",{});this.byId("ComboSegmento").setEditable(false);this.byId("ComboSegmento").setValue("");this.getOwnerComponent().getModel("Catalogos").setProperty("/SubSegmento",{});this.byId("ComboSubSegmento").setEditable(false);this.byId("ComboSubSegmento").setValue("")},async onDivisionChange(e){this.resetSalesHierarchy();let t=e.getParameter("selectedItem").getKey();let o=await this.fetchHierarchyChildren(t);if(o){this.getOwnerComponent().getModel("Catalogos").setProperty("/GerenCategoria",o)}},async onCatMgmtChange(e){this.getOwnerComponent().getModel("Catalogos").setProperty("/Categoria",{});this.byId("ComboCategory").setEditable(false);this.byId("ComboCategory").setValue("");this.getOwnerComponent().getModel("Catalogos").setProperty("/SubCategoria",{});this.byId("ComboSubCategory").setEditable(false);this.byId("ComboSubCategory").setValue("");this.getOwnerComponent().getModel("Catalogos").setProperty("/Segmento",{});this.byId("ComboSegmento").setEditable(false);this.byId("ComboSegmento").setValue("");this.getOwnerComponent().getModel("Catalogos").setProperty("/SubSegmento",{});this.byId("ComboSubSegmento").setEditable(false);this.byId("ComboSubSegmento").setValue("");let t=e.getParameter("selectedItem").getKey();let o=await this.fetchHierarchyChildren(t);if(o){this.getOwnerComponent().getModel("Catalogos").setProperty("/Categoria",o)}},async onCatChange(e){this.getOwnerComponent().getModel("Catalogos").setProperty("/SubCategoria",{});this.byId("ComboSubCategory").setEditable(false);this.byId("ComboSubCategory").setValue("");this.getOwnerComponent().getModel("Catalogos").setProperty("/Segmento",{});this.byId("ComboSegmento").setEditable(false);this.byId("ComboSegmento").setValue("");this.getOwnerComponent().getModel("Catalogos").setProperty("/SubSegmento",{});this.byId("ComboSubSegmento").setEditable(false);this.byId("ComboSubSegmento").setValue("");let t=this.byId("ComboCategory").getSelectedKey();let o=await this.fetchHierarchyChildren(t);if(o){this.getOwnerComponent().getModel("Catalogos").setProperty("/SubCategoria",o);this.byId("ComboSubCategory").setEditable(true)}},async onSubCatChange(e){this.getOwnerComponent().getModel("Catalogos").setProperty("/Segmento",{});this.byId("ComboSegmento").setEditable(false);this.byId("ComboSegmento").setValue("");this.getOwnerComponent().getModel("Catalogos").setProperty("/SubSegmento",{});this.byId("ComboSubSegmento").setEditable(false);this.byId("ComboSubSegmento").setValue("");let t=e.getParameter("selectedItem").getKey();let o=await this.fetchHierarchyChildren(t);if(o){this.getOwnerComponent().getModel("Catalogos").setProperty("/Segmento",o);this.byId("ComboSegmento").setEditable(true)}},async onSegmentCange(e){this.getOwnerComponent().getModel("Catalogos").setProperty("/SubSegmento",{});this.byId("ComboSubSegmento").setEditable(false);this.byId("ComboSubSegmento").setValue("");let t=e.getParameter("selectedItem").getKey();let o=await this.fetchHierarchyChildren(t);if(o){this.getOwnerComponent().getModel("Catalogos").setProperty("/SubSegmento",o);this.byId("ComboSubSegmento").setEditable(true)}},async fetchHierarchyChildren(e){sap.ui.core.BusyIndicator.show();let t=null;let o=`HdrcatproSet?$expand=ETJERARQUIANODO&$filter=IOption eq '21' and IParent eq '${e}'`;await u.getJsonModelAsync(o,async function(e,o){t=await e.getProperty("/results/0/ETJERARQUIANODO");sap.ui.core.BusyIndicator.hide()},function(){sap.m.MessageBox.error("No se lograron obtener los datos")},this,false);return t},async codeTypeChange(e){this.byId("barCode").setEditable(true);let t=e.getSource().getSelectedKey();y={};y.type=t;y.length=await i.findPropertieValue("Numtp","Lnean",t,this.getOwnerComponent().getModel("Catalogos").getProperty("/TipoCodigo"));this.byId("barCode").fireLiveChange()},changeBuyerEmail(e){this.validateMassiveInfo()},changeFileMassiveReg(e){this.validateMassiveInfo();this.massiveFile=e.getParameters().files[0];var t=this;var o=new FileReader;o.onload=function(e){let o={};o.IText64=e.target.result;t.massiveFile64=o};o.readAsDataURL(this.massiveFile)},validateMassiveInfo(){let e=this.byId("fileUploaderMassiveReg").getValue();let t=this.byId("correoInput").getValue();let o=e!=""&&t!="";this.byId("finishMassive").setEnabled(o)},sendDataForNotification(){let e=this;let t=this.byId("fileUploaderMassiveReg").getValue();let o=this.byId("correoInput").getValue();let a=this.getOwnerComponent().getModel("userdata").getData();let s={IvBcase:"01",IvFilename:t,IvSupplier:this.getConfigModel().getProperty("/supplierInputKey"),IvString:this.massiveFile64.IText64,ITRECIPIENT:[{Email:a.IMail.toLowerCase()},{Email:o}],ETRETURN:[]};sap.ui.core.BusyIndicator.show();$.ajax({async:true,url:p.sUrl+"HeaderSet",method:"POST",headers:{"X-Requested-With":"X","Content-Type":"application/json;charset=utf-8"},data:JSON.stringify(s),success:function(t){sap.ui.core.BusyIndicator.hide();var o=t.getElementsByTagName("d:EvSendStatus")[0].textContent;var a=t.getElementsByTagName("d:EvFolio")[0].textContent;if(o!="OK"){var s=t.getElementsByTagName("d:Message")[0].textContent;sap.m.MessageBox.error(s)}else{sap.m.MessageBox.success("Folio: "+a);e.closeDialog("massiveRegisterDialog")}},error:function(e,t,o){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error(e.ETRETURN.results[0].Message)}})},async fetchProdBase_categroria(e){let t=this.getOwnerComponent().getModel("Folio").getProperty("/PurGroup");let o=this.byId("productGroup").getSelectedKey();if(!t&&!o)return;let a=`HierarchySet(Ekgrp='${t}',Matkl='${o}')`;sap.ui.core.BusyIndicator.show();let s=null;await this._GetODataV2(d,a,[],[],"").then(e=>{s=e.data;sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.error(e)});this.getOwnerComponent().getModel("Folio").setProperty("/ProdBase",s.Hnode04);this.getOwnerComponent().getModel("FolioToShow").setProperty("/ProdBase",s.Hlevel04);this.byId("ComboDivision").setValue(s.Hlevel02);this.byId("ComboDivision").setSelectedKey(s.Hnode02);this.byId("ComboCatMgmt").setValue(s.Hlevel03);this.byId("ComboCatMgmt").setSelectedKey(s.Hnode03);this.byId("ComboCategory").setValue(s.Hlevel04);this.byId("ComboCategory").setSelectedKey(s.Hnode04);this.byId("ComboCategory").fireSelectionChange()},onShoppingGroupRequest(e){this.getOwnerComponent().getModel("Folio").setProperty("/GrupArt",null);this.getOwnerComponent().getModel("FolioToShow").setProperty("/GrupArt",null);this.byId("productGroup").setValue(null);this.getOwnerComponent().getModel("Catalogos").setProperty("/GrupoArticulos",null);this.getOwnerComponent().getModel("Catalogos").setProperty("/GrupoCompras",null);var t=this.getView();if(!this._pSearchShoppingGroup){this._pSearchShoppingGroup=sap.ui.core.Fragment.load({id:t.getId(),name:"demo.views.Products.fragments.SearchShoppingGroup",controller:this}).then(function(e){t.addDependent(e);return e})}this._pSearchShoppingGroup.then(function(e){e.open()})},async searchShoppingGroup(e){let t=e.getParameter("value");if(t==null||t=="")return;let o=[];o.push(this.generateFilter("IOption","22"));o.push(this.generateFilter("IEknam",t));sap.ui.core.BusyIndicator.show();let a=[];await this._GetODataV2(d,g,o,["ETGPOCOMPRAS"],"").then(e=>{a=e.data;sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.error(e)});this.getOwnerComponent().getModel("Catalogos").setProperty("/GrupoCompras",a.results[0].ETGPOCOMPRAS)},onShoppingGroupClose(e){let t=e.getParameter("selectedContexts");let o=e.getParameter("selectedItem");o=t.find(e=>e.getObject().Ekgrp==o.getDescription());if(!o)return;this.getOwnerComponent().getModel("Folio").setProperty("/PurGroup",o.getObject().Ekgrp);this.getOwnerComponent().getModel("FolioToShow").setProperty("/PurGroup",o.getObject().Eknam);this.searchArtGroup()},async searchArtGroup(){let e=this.getOwnerComponent().getModel("Folio").getProperty("/PurGroup");if(!e)return;let t=[];t.push(this.generateFilter("IOption","23"));t.push(this.generateFilter("IEkgrp",e));sap.ui.core.BusyIndicator.show();let o=[];await this._GetODataV2(d,g,t,["ETGPOART"],"").then(e=>{o=e.data;sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.error(e)});this.getOwnerComponent().getModel("Catalogos").setProperty("/GrupoArticulos",o.results[0].ETGPOART)},generateFilter(e,t){return new sap.ui.model.Filter({path:e,operator:sap.ui.model.FilterOperator.EQ,value1:t})},testToken:function(){$.ajax({url:this.sUri,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8; IEEE754Compatible=true",success:function(e){console.log(e)},error:function(e,t,o){console.log(e)}})},loadEstatusCatalog:function(){let e=[];e.push(new sap.ui.model.Filter("IOption",sap.ui.model.FilterOperator.EQ,"24"));this._GetODataV2(d,g,e,["ETSCODE"],"").then(e=>{this.getOwnerComponent().getModel("Catalogos").setProperty("/Estatus",e.data.results[0].ETSCODE.results)}).catch(e=>{console.error(e)})}})});