sap.ui.define(["jquery.sap.global","sap/ui/core/Fragment","demo/controllers/BaseController","sap/m/UploadCollectionParameter","sap/ui/core/mvc/Controller","sap/m/PDFViewer","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/ui/core/routing/Router","demo/models/BaseModel","sap/f/library"],function(e,t,s,a,i,o,r,n){"use strict";var l=new this.MyInbox;return s.extend("demo.controllers.HelpDocs.Master",{onInit:function(){this._pdfViewer=new o;this.getView().addDependent(this._pdfViewer);this.strUrl="";this.strType="";this.strName="";this.oRouter=this.getOwnerComponent().getRouter();this.getView().addEventDelegate({onAfterShow:function(e){var t=this.getConfigModel();t.setProperty("/barVisible",true);this.getView().byId("description").setValue("");this.getOwnerComponent().setModel(new r,"tableHelpDocs");this.searchData()}},this);this.configFilterLanguage(this.getView().byId("filterBar"))},searchData:function(){if(!l.getModel()){l.initModel()}var e=this.getView().byId("description").getValue();this.getView().byId("helpDocsList").setBusy(true);var t="/headInboxSet?$expand=ETDOCANAV&$filter= IOption eq '10'";if(e!=null&&e!=""){t+=` and IName eq '${e}'`}l.getJsonModelAsync(t,function(e,t){var s=e.getProperty("/results/0");if(s!=null){t.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(s),"tableHelpDocs");t.paginated("tableHelpDocs","/ETDOCANAV",1,0)}t.getView().byId("helpDocsList").setBusy(false)},function(e){e.getView().byId("helpDocsList").setBusy(false)},this)},newHelpDoc:function(){if(!this.hasAccess(22)){return}if(!this._uploadDialog2){this._uploadDialog2=sap.ui.xmlfragment("newHelpDocFragment","demo.views.HelpDocs.NewHelpDocs",this);this.getView().addDependent(this._uploadDialog2)}this._uploadDialog2.open()},onCloseDialog:function(){if(this.newHelpDoc){this._uploadDialog2.destroy();this._uploadDialog2=null}},setDaterangeMaxMin:function(){var e=this.getView().byId("dateRange");var t=new Date;var s=new Date;var a=new Date;a.setDate(t.getDate()-7);s.setDate(t.getDate()-30);e.setSecondDateValue(t);e.setDateValue(a)},handleDownloadPress:function(){var e=this.buildBlob(this.strUrl,this.strType);var t="archivo";if(this.strName!=null){var s=this.strName.split(".");t=s[0]}var a=s.length;var i="";switch(this.strType){case"image/png":i="png";break;case"image/jpeg":i="jpg";break;default:i="jpg";break}sap.ui.core.util.File.save(e,t,i,this.strType)},handleUploadPress:function(){var e=this;var t=sap.ui.core.Fragment.byId("newHelpDocFragment","fileUploader");var s=sap.ui.core.Fragment.byId("newHelpDocFragment","description").getValue();if(!t.getValue()||s==null&&s==""){sap.m.MessageBox.error(this.getOwnerComponent().getModel("appTxts").getProperty("/helpDocs.uploader.nodata"));return}var a={IOption:"8",IMail:this.getOwnerComponent().getModel("userdata").getProperty("/IMail"),ITDOCAYNAV:[]};var i=t.oFileUpload.files[0];var o={};o.Zdescrip=s;o.Zarchivo=i.name;o.Zdoctype=i.type;var r=new FileReader;r.onload=function(s){o.Zdocvalue64=s.target.result;a.ITDOCAYNAV.push(o);var i=l.create("/headInboxSet",a);if(i!=null){if(i.ESuccess=="X"){t.clear();e.onCloseDialog();e.searchData()}else{sap.m.MessageBox.error(i.EMessage)}}};r.readAsDataURL(i)},paginated:function(e,t,s,a){this.paginate(e,t,s,a)},selectHelpDoc:function(e){var t=l.getJsonModel(`/headInboxSet?$expand=ETDOCANAV&$filter= IOption eq '11' and IIdhp eq '${e}'`);if(t!=null){var s=t.getProperty("/results/0");if(s.ESuccess=="X"){this.downloadAttach(s.EsVdoca.Zdocvalue64,s.EsVdoca.Zdoctype,s.EsVdoca.Zarchivo)}else{sap.m.MessageBox.error(s.EMessage)}}},downloadAttach:function(e,t,s){this.strName=s;switch(t){case"application/pdf":this.pdfView(e,t);break;case"image/png":this.strUrl=e;this.strType=t;this.viewImage(e,t,s);break;case"image/jpeg":this.strUrl=e;this.strType=t;this.viewImage(e,t,s);break;default:var a=this.buildBlobUrl(e,t);sap.m.URLHelper.redirect(a,true);break}},viewImage:function(e,t,s){this.strUrl=e;this.strType=t;this.strName=s;var a=this;if(!this._uploadDialog3){this._uploadDialog3=sap.ui.xmlfragment("imageViewFragment","demo.views.HelpDocs.ImageView",this);this.getView().addDependent(this._uploadDialog3)}var i=this.buildBlobUrl(e);sap.ui.core.Fragment.byId("imageViewFragment","image1").setSrc(e);this._uploadDialog3.open()},onCloseImageDialog:function(){if(this.viewImage){this._uploadDialog3.destroy();this._uploadDialog3=null}},pdfView:function(e,t){var s=this.buildBlobUrl(e,t);if(!this._PDFViewer){this.createPDFView(s)}else{if(this._PDFViewer.getSource()!==s){this._PDFViewer=null}this.createPDFView(s)}this._PDFViewer.open()},createPDFView:function(t){this._PDFViewer=new sap.m.PDFViewer({width:"auto",source:t});e.sap.addUrlWhitelist("blob")},deleteHelpDoc:function(e,t){if(!this.hasAccess(23)){return}var s=this;var a=this.getOwnerComponent().getModel("appTxts").getProperty("/helpDocs.deleteConfirm");sap.m.MessageBox.confirm(a,{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],emphasizedAction:sap.m.MessageBox.Action.YES,onClose:function(t){if(t==sap.m.MessageBox.Action.YES){s.delteDoc(e)}}})},delteDoc:function(e){var t={IOption:"9",IMail:this.getOwnerComponent().getModel("userdata").getProperty("/IMail"),ITIDDOCNAV:[{Idarchivo:e}]};var s=l.create("/headInboxSet",t);if(s!=null){if(s.ESuccess=="X"){sap.m.MessageBox.success(this.getOwnerComponent().getModel("appTxts").getProperty("/helpDocs.deletSuccess"));this.searchData()}else{sap.m.MessageBox.error(s.EMessage)}}}})});