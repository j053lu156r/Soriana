sap.ui.define(["demo/controllers/BaseController","sap/m/PDFViewer","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/m/library"],function(e,t,o,r,a,n){"use strict";var i=new this.ACcapturados;var s=n.ButtonType;var l=n.DialogType;var p;return e.extend("demo.controllers.BoletinVta.MasterVendor",{onInit:function(){this._pdfViewer=new t;this.getView().addDependent(this._pdfViewer);this.getView().addEventDelegate({onAfterShow:function(e){var t=this.getOwnerComponent().getModel();t.setProperty("/barVisible",true);this.getOwnerComponent().setModel(new o,"promocionesHdr");this.clearFilters()}},this);this.configFilterLanguage(this.getView().byId("filterBar"))},searchData:function(){var e=this.getOwnerComponent().getModel("appTxts");var t=e.getProperty("/foliosCap.indVendor");var o=e.getProperty("/foliosCap.indDates");var r=true;if(!i.getModel()){i.initModel()}var n=this.getView().byId("promocionInput").getValue();var s=this.getConfigModel().getProperty("/supplierInputKey");var e=this.getOwnerComponent().getModel("appTxts");var l=this.getView().byId("aportaDay");var p=this.buildSapDate(l.getDateValue());var d=this.buildSapDate(l.getSecondDateValue());if(s===""||s===null){r=false;a.error(t)}else if(p===""||p===null){r=false;a.error(o)}else if(d===""||d===null){r=false;a.error(o)}if(r){var g="promotionsEnteredSet?$filter=";if(n!==""){g=g+"Promotion eq '"+n+"' and "}g=g+" Vendor eq '"+s+"' and EarliestDate eq '"+p+"' and LatestDate eq '"+d+"' and tile eq 'Vendor' ";this.getView().byId("tablePromociones").setBusy(true);i.getJsonModelAsync(g,function(e,t){var o=e.getProperty("/results");if(o!=null){t.getOwnerComponent().setModel(new sap.ui.model.json.JSONModel(o),"promocionesHdr");t.paginate("promocionesHdr","/promocionesDet",1,0)}t.getView().byId("tablePromociones").setBusy(false)},function(e){e.getView().byId("tablePromociones").setBusy(false)},this)}},onExit:function(){},filtrado:function(e){var t=[];var o=e.getParameter("query");var r=this.getView().byId("selectFilter");var a=r.getSelectedKey();if(o&&o.length>0){var n=new sap.ui.model.Filter(a,sap.ui.model.FilterOperator.Contains,o);t.push(n)}var i=this.getView().byId("promocionesHdr");var s=i.getBinding("items");s.filter(t)},setDaterangeMaxMin:function(){var e=this.getView().byId("dateRange");var t=new Date;var o=new Date;var r=new Date;r.setDate(t.getDate()-7);o.setDate(t.getDate()-30);e.setSecondDateValue(t);e.setDateValue(r)},onListItemPress:function(e){var t=e.getSource().getBindingContext("promocionesHdr").getPath(),o=t.split("/").slice(-1).pop();var r=this.getOwnerComponent().getModel("promocionesHdr");var a=r.getProperty("/");var n=a[o];this.getOwnerComponent().getRouter().navTo("detailBoletinVtaCentros",{layout:sap.f.LayoutType.TwoColumnsMidExpanded,promotion:n.Promotion,vendor:n.Vendor,promDescription:n.Description,IntenalClass:n.InternalClass,origin:"vendor"},true)},openUploadDialog:function(e){var t=e.getSource().getBindingContext("promocionesHdr").getPath(),o=t.split("/").slice(-1).pop();p=o;if(!this._uploadDialog){this._uploadDialog=sap.ui.xmlfragment("demo.views.BoletinVta.UploadPDF",this);this.getView().addDependent(this._uploadDialog)}this._uploadDialog.open()},onCloseDialogUpload:function(){if(this._uploadDialog){this._uploadDialog.destroy();this._uploadDialog=null}},btnValidateFile:function(){console.log("Upload file")},onChangeFUP:function(e){this._import(e.getParameter("files")&&e.getParameter("files")[0])},_import:function(e){var t=this;if(e&&window.FileReader){var o=new FileReader;o.onload=function(o){var r=o.target.result.split(",");t.saveFileToRemoteServer(r,e)}}switch(e.type){case"application/pdf":o.readAsDataURL(e,"UTF-8");break;default:o.readAsDataURL(e);break}},saveFileToRemoteServer:function(e,t){var o=this;var r=this.getOwnerComponent().getModel("promocionesHdr");var n=r.getProperty("/");var i=n[p];r=this.getOwnerComponent().getModel("promocionesHdr").getData();var s={Promotion:i.Promotion,Vendor:i.Vendor,FileName:t.name,Content:e[1],MimeType:t.type};var l=false;var d="/sap/opu/odata/sap/ZOS_AC_CAPTURADOS_SRV/";var g=new sap.ui.model.odata.ODataModel(d,true);var m="/promFilesSet(Promotion='"+i.Promotion+"',Vendor='"+i.Vendor+"')";g.setHeaders({"X-Requested-With":"X",slug:i.Promotion+"|"+i.Vendor+"|"+t.name+"|"+t.type});g.create("/promFilesSet",s,null,function(){r[p].Status="1";var e=new sap.ui.model.json.JSONModel;e.setData(r);o.getOwnerComponent().setModel(e,"promocionesHdr");a.success("Archivo grabado exitosamente");o.onCloseDialogUpload()},function(e){sap.m.MessageBox.alert("Ocurrio un error al grabar el archivo.")})},clearFilters:function(){this.getView().byId("promocionInput").setValue("");this.getView().byId("supplierInput").setValue("")},buildExportTable:function(){var e=this.getOwnerComponent().getModel("appTxts");var t=[{name:e.getProperty("/foliosCap.promocion"),template:{content:"{Promotion}"}},{name:e.getProperty("/foliosCap.promDes"),template:{content:"{Description}"}},{name:e.getProperty("/foliosCap.currency"),template:{content:"{CurrencyProm}"}},{name:e.getProperty("/foliosCap.dateFrom"),template:{content:"{EarliestDate}"}},{name:e.getProperty("/foliosCap.dateTo"),template:{content:"{LatestDate}"}},{name:e.getProperty("/foliosCap.promClass"),template:{content:"{PromClass}"}}];this.exportxls("promocionesHdr","/",t)},onPressAccept:function(e){var t=e.getSource().getBindingContext("promocionesHdr").getPath(),o=t.split("/").slice(-1).pop();this._confirmDialog(o)},_confirmDialog:function(e){var t=this.getOwnerComponent().getModel("appTxts");this._line_approve=e;if(!this.oApproveDialog){this.oApproveDialog=new sap.m.Dialog({type:l.Message,title:t.getProperty("/foliosCap.confirm"),content:new sap.m.Text({text:t.getProperty("/foliosCap.confirm")}),beginButton:new sap.m.Button({type:s.Emphasized,text:t.getProperty("/foliosCap.aprobar"),press:function(){this.oApproveDialog.close();this._approve(this._line_approve)}.bind(this)}),endButton:new sap.m.Button({text:t.getProperty("/foliosCap.cancelar"),press:function(){this.oApproveDialog.close()}.bind(this)})})}this.oApproveDialog.open()},onOpenPDF:function(e){var t=e.getSource().getBindingContext("promocionesHdr").getPath(),o=t.split("/").slice(-1).pop();var r=this.getOwnerComponent().getModel("promocionesHdr");var a=r.getProperty("/");var n=a[o];var s=this;var l="promFilesSet(Promotion='"+n.Promotion+"',Vendor='"+n.Vendor+"')";i.getJsonModelAsync(l,function(e,t){var o=e.getData();if(o!=null){var r=o.__metadata.media_src;r=r.replace("http","https");s._pdfViewer.setSource(r);s._pdfViewer.setTitle(o.FileName);s._pdfViewer.setDisplayType("Embedded");s._pdfViewer.open()}},function(e){},this)},_approve:function(e){var t=this;var o=this.getOwnerComponent().getModel("promocionesHdr");var r=o.getProperty("/");var a=r[e];var n=this.getOwnerComponent().getModel("userdata").getProperty("/IMail");var s="aproveArrangementSet(Promotion='"+a.Promotion+"',Vendor='"+a.Vendor+"'"+",PortalUser='"+n+"')";this.getView().byId("tablePromociones").setBusy(true);i.getJsonModelAsync(s,function(o,r){var a=o.getProperty("/");if(a!=null){if(a.Status==="A"){sap.m.MessageBox.information(a.Message);var n=t.getOwnerComponent().getModel("promocionesHdr").getData();n[e].Status="2";var i=new sap.ui.model.json.JSONModel;i.setData(n);t.getOwnerComponent().setModel(i,"promocionesHdr");r.getView().byId("tablePromociones").setBusy(false)}else{sap.m.MessageBox.error(a.Message)}}r.getView().byId("tablePromociones").setBusy(false)},function(e){e.getView().byId("tablePromociones").setBusy(false)},this)}})});